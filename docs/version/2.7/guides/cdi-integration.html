<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - CDI Integration Guide - 2.7</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/2.7/guides/cdi-integration" />
  <meta property="og:title" content="CDI Integration Guide - 2.7" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/cdi-integration">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >ENGLISH</a></li>
          <li><a href="https://ja.quarkus.io/">JAPANESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/2.7/guides/"> Back to Guides</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">Select Guide Version</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.9 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" selected>2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" >1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">CDI Integration Guide </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#メタデータソース">1. メタデータソース</a></li>
<li><a href="#ユースケース-クラスがbeanとして認識されません">2. ユースケース - クラスがBeanとして認識されません</a>
<ul class="sectlevel2">
<li><a href="#additional_bean_build_item">2.1. <em>理由1</em> :クラスが発見されない</a></li>
<li><a href="#理由2-クラスは発見されたがbeanを定義するアノテーションがない">2.2. <em>理由2</em> : クラスは発見されたが、Beanを定義するアノテーションがない</a></li>
<li><a href="#unremovable_builditem">2.3. <em>Reason 3</em>: Class Was Discovered and Has a Bean Defining Annotation but Was Removed</a></li>
</ul>
</li>
<li><a href="#use-case-my-annotation-is-not-recognized-as-a-qualifier-or-an-interceptor-binding">3. Use Case - My Annotation Is Not Recognized as a Qualifier or an Interceptor Binding</a></li>
<li><a href="#annotations_transformer_build_item">4. ユースケース - メタデータを変換する必要があります</a></li>
<li><a href="#inspect_beans">5. 使用例 - Bean、オブザーバー、インジェクションポイントの検査</a>
<ul class="sectlevel2">
<li><a href="#解決策1-beandiscoveryfinishedbuilditem">5.1. <em>解決策1.</em> <code>BeanDiscoveryFinishedBuildItem</code></a></li>
<li><a href="#解決策2-synthesisfinishedbuilditem">5.2. <em>解決策2</em> : <code>SynthesisFinishedBuildItem</code></a></li>
</ul>
</li>
<li><a href="#synthetic_beans">6. Use Case - The Need for Synthetic Beans</a></li>
<li><a href="#synthetic_observers">7. Use Case - Synthetic Observers</a></li>
<li><a href="#generated_beans">8. Use Case - I Have a Generated Bean Class</a></li>
<li><a href="#use-case-i-need-to-validate-the-deployment">9. Use Case - I Need to Validate the Deployment</a></li>
<li><a href="#custom_context">10. ユースケース - カスタム CDI コンテキストの登録</a>
<ul class="sectlevel2">
<li><a href="#what-if-i-need-to-know-all-the-scopes-used-in-the-application">10.1. What if I Need to Know All the Scopes Used in the Application?</a></li>
</ul>
</li>
<li><a href="#additional_interceptor_bindings">11. Use Case - Additional Interceptor Bindings</a></li>
<li><a href="#使用例-追加の修飾子">12. 使用例 - 追加の修飾子</a></li>
<li><a href="#injection_point_transformation">13. Use Case - Injection Point Transformation</a></li>
<li><a href="#use-case-resource-annotations-and-injection">14. Use Case - Resource Annotations and Injection</a></li>
<li><a href="#build_metadata">15. 利用可能なビルドタイムメタデータ</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>CDI コンテナーである ArC はビルド時にブートストラップされます。このアプローチの欠点は、CDI Portable Extensionsをサポートできないことです。それにもかかわらず、Quarkus固有のエクステンションAPIを使用して機能を実現することができます。</p>
</div>
<div class="paragraph">
<p>コンテナーは複数のフェーズでブートストラップされます。高レベルの視点から見ると、これらのフェーズは以下のようになります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>初期化</p>
</li>
<li>
<p>Bean discovery</p>
</li>
<li>
<p>合成コンポーネントの登録</p>
</li>
<li>
<p>バリデーション</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>初期化</em> フェーズでは、準備作業が行われ、カスタムコンテキストが登録されます。その後、コンテナーがすべてのアプリケーションクラスを分析し、Beanを識別し、提供されたメタデータに基づいてそれらをすべて繋ぎ合わせるプロセスがBean <em>ディスカバリ</em> です。その後、エクステンションは <em>合成コンポーネント</em> を登録することができます。これらのコンポーネントの属性はエクステンションによって完全に制御されます。最後に、 <em>デプロイメントが検証されます</em> 。例えば、コンテナーはアプリケーション内のすべての注入ポイントを検証し、与えられた必要な型と修飾子を満たすBeanがない場合はビルドを失敗させます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
追加のロギングを有効にすることで、ブートストラップに関するより多くの情報を見ることができます。 <code>-X</code> または <code>--debug</code> で Maven ビルドを実行し、 <code>io.quarkus.arc</code> を含む行を grep するだけです。 <a href="cdi-reference.html#dev-mode">開発モード</a> では、 <code>quarkus.log.category."io.quarkus.arc.processor".level=DEBUG</code> を使用することができ、2つの特別なエンドポイントも自動的に登録され、JSON形式でいくつかの基本的なデバッグ情報を提供します。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Quarkusのビルドステップでは、さまざまなビルドアイテムを生成したり消費したりして、各フェーズにフックすることができます。以下のセクションでは、関連するすべてのビルド項目と一般的なシナリオについて説明します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="メタデータソース"><a class="anchor" href="#メタデータソース"></a>1. メタデータソース</h2>
<div class="sectionbody">
<div class="paragraph">
<p>クラスとアノテーションは、Beanレベルのメタデータの主要なソースです。初期のメタデータは、Beanの <a href="cdi-reference.html#bean_discovery">ディスカバリ</a> 時に様々なソースから構築される不変の <a href="https://github.com/wildfly/jandex" target="<em>blank">Jandexインデックス</a> である _Beanアーカイブインデックス</em> から読み込まれます。しかし、エクステンションは、ブートストラップの特定の段階でメタデータを追加、削除、変換することができます。さらに、エクステンションは <a href="#synthetic_beans">合成コンポーネント</a> を登録することもできます。これは、CDIコンポーネントをQuarkusに統合する際に実現すべき重要な側面です。</p>
</div>
<div class="paragraph">
<p>このようにして、エクステンションは、そうでなければ無視されていたクラスをBeanに変えたり、その逆を行ったりすることができます。例えば、 <code>@Scheduled</code> メソッドを宣言するクラスは、たとえそれがBean定義アノテーションでアノテーションされておらず、通常は無視されるようなクラスであっても、常にBeanとして登録されます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ユースケース-クラスがbeanとして認識されません"><a class="anchor" href="#ユースケース-クラスがbeanとして認識されません"></a>2. ユースケース - クラスがBeanとして認識されません</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>UnsatisfiedResolutionException</code> は、 <a href="cdi.html#typesafe_resolution">タイプセーフ解決</a> 時に問題があることを示しています。クラスパス上にインジェクションが可能なクラスがあっても、インジェクションポイントを満たすことができないことがあります。クラスが認識されない理由はいくつかありますが、それを解決する方法もいくつかあります。最初のステップでは、その <em>理由</em> を特定する必要があります。</p>
</div>
<div class="sect2">
<h3 id="additional_bean_build_item"><a class="anchor" href="#additional_bean_build_item"></a>2.1. <em>理由1</em> :クラスが発見されない</h3>
<div class="paragraph">
<p>Quarkusには <a href="cdi-reference.html#bean_discovery">簡易ディスカバリー</a> があります。クラスがアプリケーションのインデックスに含まれていないことが起こるかもしれません。例えば、Quarkusエクステンションの <em>ランタイムモジュール</em> のクラスは自動的にインデックス化されません。</p>
</div>
<div class="paragraph">
<p><em>解決策</em> 。 <code>AdditionalBeanBuildItem</code> .このビルド項目は、ディスカバリー中に解析する1つ以上の追加クラスを指定するために使用することができます。追加のBean・クラスは、コンテナーによって処理されるアプリケーション・インデックスに透過的に追加されます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<a href="cdi-reference#enable_build_profile">cdi-reference</a>および <a href="cdi-reference#enable_build_properties">cdi-reference</a> で説明されているように、 <code>@IfBuildProfile</code>, <code>@UnlessBuildProfile</code>, <code>@IfBuildProperty</code> および <code>@UnlessBuildProperty</code> アノテーションを介して、条件付きで追加のBeanを有効化/無効化することはできません。エクステンションは、設定または現在のプロファイルを検査し、本当に必要な場合にのみ <code>AdditionalBeanBuildItem</code> を生成するべきです。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>AdditionalBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
AdditionalBeanBuildItem additionalBeans() {
     return new AdditionalBeanBuildItem(SmallRyeHealthReporter.class, HealthServlet.class)); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>AdditionalBeanBuildItem.Builder</code> は、より複雑なユースケースに使用することができます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>AdditionalBeanBuildItem</code> 経由で追加された Bean クラスは、デフォルトでは <em>取り外し可能です</em> 。コンテナーがそれらを <a href="cdi-reference.html#remove_unused_beans">未使用</a> とみなした場合、それらはただ無視されます。しかし、 <code>AdditionalBeanBuildItem.Builder.setUnremovable()</code> メソッドを使用して、このビルド項目を介して登録されたBeanクラスを絶対に削除しないようにコンテナーに指示することができます。詳細は、未使用のBeanの <a href="cdi-reference.html#remove_unused_beans">削除</a> と <a href="#unremovable_builditem">[unremovable_builditem</a>] も参照してください。</p>
</div>
<div class="paragraph">
<p><code>AdditionalBeanBuildItem.Builder#setDefaultScope()</code> からデフォルトのスコープを設定することも可能です。デフォルトのスコープは、Beanクラスにスコープが宣言されていない場合にのみ使用されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
デフォルトスコープが指定されていない場合は <code>@Dependent</code> 擬似スコープが使用されます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="理由2-クラスは発見されたがbeanを定義するアノテーションがない"><a class="anchor" href="#理由2-クラスは発見されたがbeanを定義するアノテーションがない"></a>2.2. <em>理由2</em> : クラスは発見されたが、Beanを定義するアノテーションがない</h3>
<div class="paragraph">
<p>In Quarkus, the application is represented by a single bean archive with the <a href="https://jakarta.ee/specifications/cdi/2.0/cdi-spec-2.0.html#default_bean_discovery" target="_blank" rel="noopener">bean discovery mode <code>annotated</code></a>. Therefore, bean classes that don&#8217;t have a <a href="https://jakarta.ee/specifications/cdi/2.0/cdi-spec-2.0.html#bean_defining_annotations" target="_blank" rel="noopener">bean defining annotation</a> are ignored. Bean defining annotations are declared on the class-level and include scopes, stereotypes and <code>@Interceptor</code>.</p>
</div>
<div class="paragraph">
<p><em>解決策1</em> : <code>AutoAddScopeBuildItem</code> の使用。このビルドアイテムを使用すると、特定の条件を満たすクラスにスコープを追加することができます。</p>
</div>
<div class="listingblock">
<div class="title"><code>AutoAddScopeBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
AutoAddScopeBuildItem autoAddScope() {
   return AutoAddScopeBuildItem.builder().containsAnnotations(SCHEDULED_NAME, SCHEDULES_NAME) <i class="conum" data-value="1"></i><b>(1)</b>
      .defaultScope(BuiltinScope.SINGLETON) <i class="conum" data-value="2"></i><b>(2)</b>
      .build();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Scheduled</code> でアノテーションされたすべてのクラスを検索</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>デフォルトのスコープとして <code>@Singleton</code> を追加。既にスコープでアノテーションされているクラスは自動的にスキップされます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>Solution 2</em>: If you need to process classes annotated with a specific annotation then it&#8217;s possible to extend the set of bean defining annotations via the <code>BeanDefiningAnnotationBuildItem</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>BeanDefiningAnnotationBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
BeanDefiningAnnotationBuildItem additionalBeanDefiningAnnotation() {
   return new BeanDefiningAnnotationBuildItem(Annotations.GRAPHQL_API); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add <code>org.eclipse.microprofile.graphql.GraphQLApi</code> to the set of bean defining annotations.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Bean classes added via <code>BeanDefiningAnnotationBuildItem</code> are <em>not removable</em> by default, i.e. the resulting beans must not be removed even if they are considered unused. However, you can change the default behavior. See also <a href="cdi-reference#remove_unused_beans">Removing Unused Beans</a> and <a href="#unremovable_builditem">[unremovable_builditem]</a> for more details.</p>
</div>
<div class="paragraph">
<p>It is also possible to specify the default scope. The default scope is only used if there is no scope declared on the bean class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
デフォルトスコープが指定されていない場合は <code>@Dependent</code> 擬似スコープが使用されます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="unremovable_builditem"><a class="anchor" href="#unremovable_builditem"></a>2.3. <em>Reason 3</em>: Class Was Discovered and Has a Bean Defining Annotation but Was Removed</h3>
<div class="paragraph">
<p>The container attempts to <a href="cdi-reference#remove_unused_beans">remove all unused beans</a> during the build by default. This optimization allows for <em>framework-level dead code elimination</em>. In few special cases, it&#8217;s not possible to correctly identify an unused bean. In particular, Quarkus is not able to detect the usage of the <code>CDI.current()</code> static method yet. Extensions can eliminate possible false positives by producing an <code>UnremovableBeanBuildItem</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>UnremovableBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
UnremovableBeanBuildItem unremovableBeans() {
   return UnremovableBeanBuildItem.targetWithAnnotation(STARTUP_NAME); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Startup</code> でアノテーションされたすべてのクラスを削除できないようにする。</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-case-my-annotation-is-not-recognized-as-a-qualifier-or-an-interceptor-binding"><a class="anchor" href="#use-case-my-annotation-is-not-recognized-as-a-qualifier-or-an-interceptor-binding"></a>3. Use Case - My Annotation Is Not Recognized as a Qualifier or an Interceptor Binding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is likely that the annotation class is not part of the application index. For example, classes from the <em>runtime module</em> of a Quarkus extension are not indexed automatically.</p>
</div>
<div class="paragraph">
<p><em>Solution</em>: Use the <code>AdditionalBeanBuildItem</code> as described in <a href="#additional_bean_build_item"><em>理由1</em> :クラスが発見されない</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="annotations_transformer_build_item"><a class="anchor" href="#annotations_transformer_build_item"></a>4. ユースケース - メタデータを変換する必要があります</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In some cases, it&#8217;s useful to be able to modify the metadata. Quarkus provides a powerful alternative to <a href="https://jakarta.ee/specifications/cdi/2.0/cdi-spec-2.0.html#process_annotated_type" target="_blank" rel="noopener"><code>javax.enterprise.inject.spi.ProcessAnnotatedType</code></a>. With an <code>AnnotationsTransformerBuildItem</code> it&#8217;s possible to override the annotations that exist on bean classes.</p>
</div>
<div class="paragraph">
<p>For example, you might want to add an interceptor binding to a specific bean class. Here is how to do it:</p>
</div>
<div class="listingblock">
<div class="title"><code>AnnotationsTransformerBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
AnnotationsTransformerBuildItem transform() {
   return new AnnotationsTransformerBuildItem(new AnnotationsTransformer() {

      public boolean appliesTo(org.jboss.jandex.AnnotationTarget.Kind kind) {
         return kind == org.jboss.jandex.AnnotationTarget.Kind.CLASS; <i class="conum" data-value="1"></i><b>(1)</b>
      }

      public void transform(TransformationContext context) {
         if (context.getTarget().asClass().name().toString().equals("org.acme.Bar")) {
            context.transform().add(MyInterceptorBinding.class).done(); <i class="conum" data-value="2"></i><b>(2)</b>
         }
      }
    });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>トランスフォーマーはクラスにのみ適用されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the class name equals to <code>org.acme.Bar</code> then add <code>@MyInterceptorBinding</code>. Don&#8217;t forget to invoke <code>Transformation#done()</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
アノテーショントランスフォーマーは、Beanディスカバリが始まる <em>前に</em> 生成されなければならないことを覚えておいてください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Build steps can query the transformed annotations for a given annotation target via the <code>TransformedAnnotationsBuildItem</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>TransformedAnnotationsBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void queryAnnotations(TransformedAnnotationsBuildItem transformedAnnotations, BuildProducer&lt;MyBuildItem&gt; myBuildItem) {
   ClassInfo myClazz = ...;
   if (transformedAnnotations.getAnnotations(myClazz).isEmpty()) { <i class="conum" data-value="1"></i><b>(1)</b>
     myBuildItem.produce(new MyBuildItem());
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>TransformedAnnotationsBuildItem.getAnnotations()</code> will return a possibly transformed set of annotations.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are other build items specialized in transformation: <a href="#additional_interceptor_bindings">Use Case - Additional Interceptor Bindings</a> and <a href="#injection_point_transformation">Use Case - Injection Point Transformation</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inspect_beans"><a class="anchor" href="#inspect_beans"></a>5. 使用例 - Bean、オブザーバー、インジェクションポイントの検査</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="解決策1-beandiscoveryfinishedbuilditem"><a class="anchor" href="#解決策1-beandiscoveryfinishedbuilditem"></a>5.1. <em>解決策1.</em> <code>BeanDiscoveryFinishedBuildItem</code></h3>
<div class="paragraph">
<p>Consumers of <code>BeanDiscoveryFinishedBuildItem</code> can easily inspect all class-based beans, observers and injection points registered in the application. However, synthetic beans and observers are <em>not included</em> because this build item is produced <em>before</em> the synthetic components are registered.</p>
</div>
<div class="paragraph">
<p>Additionaly, the bean resolver returned from <code>BeanDiscoveryFinishedBuildItem#getBeanResolver()</code> can be used to apply the type-safe resolution rules, e.g. to find out whether there is a bean that would satisfy certain combination of required type and qualifiers.</p>
</div>
<div class="listingblock">
<div class="title"><code>BeanDiscoveryFinishedBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void doSomethingWithNamedBeans(BeanDiscoveryFinishedBuildItem beanDiscovery, BuildProducer&lt;NamedBeansBuildItem&gt; namedBeans) {
   List&lt;BeanInfo&gt; namedBeans = beanDiscovery.beanStream().withName().collect(toList())); <i class="conum" data-value="1"></i><b>(1)</b>
   namedBeans.produce(new NamedBeansBuildItem(namedBeans));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The resulting list will not contain <code>@Named</code> synthetic beans.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="解決策2-synthesisfinishedbuilditem"><a class="anchor" href="#解決策2-synthesisfinishedbuilditem"></a>5.2. <em>解決策2</em> : <code>SynthesisFinishedBuildItem</code></h3>
<div class="paragraph">
<p>Consumers of <code>SynthesisFinishedBuildItem</code> can easily inspect all beans, observers and injection points registered in the application. Synthetic beans and observers are included because this build item is produced <em>after</em> the synthetic components are registered.</p>
</div>
<div class="paragraph">
<p>Additionaly, the bean resolver returned from <code>SynthesisFinishedBuildItem#getBeanResolver()</code> can be used to apply the type-safe resolution rules, e.g. to find out whether there is a bean that would satisfy certain combination of required type and qualifiers.</p>
</div>
<div class="listingblock">
<div class="title"><code>SynthesisFinishedBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void doSomethingWithNamedBeans(SynthesisFinishedBuildItem synthesisFinished, BuildProducer&lt;NamedBeansBuildItem&gt; namedBeans) {
   List&lt;BeanInfo&gt; namedBeans = synthesisFinished.beanStream().withName().collect(toList())); <i class="conum" data-value="1"></i><b>(1)</b>
   namedBeans.produce(new NamedBeansBuildItem(namedBeans));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The resulting list will contain <code>@Named</code> synthetic beans.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="synthetic_beans"><a class="anchor" href="#synthetic_beans"></a>6. Use Case - The Need for Synthetic Beans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes it is practical to be able to register a <em>synthetic bean</em>. Bean attributes of a synthetic bean are not derived from a Java class, method or field. Instead, all the attributes are defined by an extension. In regular CDI, this could be achieved using the <a href="https://jakarta.ee/specifications/cdi/2.0/cdi-spec-2.0.html#after_bean_discovery" target="_blank" rel="noopener"><code>AfterBeanDiscovery.addBean()</code></a> methods.</p>
</div>
<div class="paragraph">
<p><em>Solution</em>: If you need to register a synthetic bean then use the <code>SyntheticBeanBuildItem</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>SyntheticBeanBuildItem</code> Example 1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
SyntheticBeanBuildItem syntheticBean() {
   return SyntheticBeanBuildItem.configure(String.class)
             .qualifiers(new MyQualifierLiteral())
             .creator(mc -&gt; mc.returnValue(mc.load("foo"))) <i class="conum" data-value="1"></i><b>(1)</b>
             .done();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Generate the bytecode of the <code>javax.enterprise.context.spi.Contextual#create(CreationalContext&lt;T&gt;)</code> implementation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The output of a bean configurator is recorded as bytecode. Therefore, there are some limitations in how a synthetic bean instance is created at runtime. You can:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate the bytecode of the <code>Contextual#create(CreationalContext&lt;T&gt;)</code> method directly via <code>ExtendedBeanConfigurator.creator(Consumer&lt;MethodCreator&gt;)</code>.</p>
</li>
<li>
<p>Pass a <code>io.quarkus.arc.BeanCreator</code> implementation class via <code>ExtendedBeanConfigurator#creator(Class&lt;? extends BeanCreator&lt;U&gt;&gt;)</code>, and possibly specify some parameters via <code>ExtendedBeanConfigurator#param()</code>.</p>
</li>
<li>
<p>Produce the runtime instance through a proxy returned from a <a href="writing-extensions#bytecode-recording"><code>@Recorder</code> method</a> and set it via <code>ExtendedBeanConfigurator#runtimeValue(RuntimeValue&lt;?&gt;)</code> or <code>ExtendedBeanConfigurator#supplier(Supplier&lt;?&gt;)</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>SyntheticBeanBuildItem</code> Example 2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
@Record(STATIC_INIT) <i class="conum" data-value="1"></i><b>(1)</b>
SyntheticBeanBuildItem syntheticBean(TestRecorder recorder) {
   return SyntheticBeanBuildItem.configure(Foo.class).scope(Singleton.class)
                .runtimeValue(recorder.createFoo()) <i class="conum" data-value="2"></i><b>(2)</b>
                .done();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>By default, a synthetic bean is initialized during <code>STATIC_INIT</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bean instance is supplied by a value returned from a recorder method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to mark a synthetic bean to be initialized during <code>RUNTIME_INIT</code>. See the <a href="writing-extensions#bootstrap-three-phases">Three Phases of Bootstrap and Quarkus Philosophy</a> for more information about the difference between <code>STATIC_INIT</code> and <code>RUNTIME_INIT</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>RUNTIME_INIT</code> <code>SyntheticBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
@Record(RUNTIME_INIT) <i class="conum" data-value="1"></i><b>(1)</b>
SyntheticBeanBuildItem syntheticBean(TestRecorder recorder) {
   return SyntheticBeanBuildItem.configure(Foo.class).scope(Singleton.class)
                .setRuntimeInit() <i class="conum" data-value="2"></i><b>(2)</b>
                .runtimeValue(recorder.createFoo())
                .done();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The recorder must be executed in the <code>ExecutionTime.RUNTIME_INIT</code> phase.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bean instance is initialized during <code>RUNTIME_INIT</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Synthetic beans initialized during <code>RUNTIME_INIT</code> must not be accessed during <code>STATIC_INIT</code>. <code>RUNTIME_INIT</code> build steps that access a runtime-init synthetic bean should consume the <code>SyntheticBeansRuntimeInitBuildItem</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
@Record(RUNTIME_INIT)
@Consume(SyntheticBeansRuntimeInitBuildItem.class) <i class="conum" data-value="1"></i><b>(1)</b>
void accessFoo(TestRecorder recorder) {
   recorder.foo(); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This build step must be executed after <code>syntheticBean()</code> completes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This recorder method results in an invocation upon the <code>Foo</code> bean instance and thus we need to make sure that the build step is executed after all synthetic beans are initialized.</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is also possible to use the <code>BeanRegistrationPhaseBuildItem</code> to register a synthetic bean. However, we recommend extension authors to stick with <code>SyntheticBeanBuildItem</code> which is more idiomatic for Quarkus.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="synthetic_observers"><a class="anchor" href="#synthetic_observers"></a>7. Use Case - Synthetic Observers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Similar to <a href="#synthetic_beans">synthetic beans</a>, the attributes of a synthetic observer method are not derived from a Java method. Instead, all the attributes are defined by an extension.</p>
</div>
<div class="paragraph">
<p><em>Solution</em>: If you need to register a synthetic observer, use the <code>ObserverRegistrationPhaseBuildItem</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A build step that consumes the <code>ObserverRegistrationPhaseBuildItem</code> should always produce an <code>ObserverConfiguratorBuildItem</code> or at least inject a <code>BuildProducer</code> for this build item, otherwise it could be ignored or processed at the wrong time (e.g. after the correct CDI bootstrap phase).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>ObserverRegistrationPhaseBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void syntheticObserver(ObserverRegistrationPhaseBuildItem observerRegistrationPhase,
            BuildProducer&lt;MyBuildItem&gt; myBuildItem,
            BuildProducer&lt;ObserverConfiguratorBuildItem&gt; observerConfigurationRegistry) {
   observerConfigurationRegistry.produce(new ObserverConfiguratorBuildItem(observerRegistrationPhase.getContext()
       .configure()
       .beanClass(DotName.createSimple(MyBuildStep.class.getName()))
       .observedType(String.class)
       .notify(mc -&gt; {
           // do some gizmo bytecode generation...
       })));
   myBuildItem.produce(new MyBuildItem());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of a <code>ObserverConfigurator</code> is recorded as bytecode. Therefore, there are some limitations in how a synthetic observer is invoked at runtime. Currently, you must generate the bytecode of the method body directly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generated_beans"><a class="anchor" href="#generated_beans"></a>8. Use Case - I Have a Generated Bean Class</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No problem. You can generate the bytecode of a bean class manually and then all you need to do is to produce a <code>GeneratedBeanBuildItem</code> instead of <code>GeneratedClassBuildItem</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>GeneratedBeanBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void generatedBean(BuildProducer&lt;GeneratedBeanBuildItem&gt; generatedBeans) {
    ClassOutput beansClassOutput = new GeneratedBeanGizmoAdaptor(generatedBeans); <i class="conum" data-value="1"></i><b>(1)</b>
    ClassCreator beanClassCreator = ClassCreator.builder().classOutput(beansClassOutput)
                .className("org.acme.MyBean")
                .build();
    beanClassCreator.addAnnotation(Singleton.class);
    beanClassCreator.close(); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>io.quarkus.arc.deployment.GeneratedBeanGizmoAdaptor</code> makes it easy to produce <code>GeneratedBeanBuildItem</code>s from Gizmo constructs.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The resulting bean class is something like <code>public class @Singleton MyBean { }</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-case-i-need-to-validate-the-deployment"><a class="anchor" href="#use-case-i-need-to-validate-the-deployment"></a>9. Use Case - I Need to Validate the Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes extensions need to inspect the beans, observers and injection points, then perform additional validations and fail the build if something is wrong.</p>
</div>
<div class="paragraph">
<p><em>Solution</em>: If an extension needs to validate the deployment it should use the <code>ValidationPhaseBuildItem</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A build step that consumes the <code>ValidationPhaseBuildItem</code> should always produce a <code>ValidationErrorBuildItem</code> or at least inject a <code>BuildProducer</code> for this build item, otherwise it could be ignored or processed at the wrong time (e.g. after the correct CDI bootstrap phase).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void validate(ValidationPhaseBuildItem validationPhase,
            BuildProducer&lt;MyBuildItem&gt; myBuildItem,
            BuildProducer&lt;ValidationErrorBuildItem&gt; errors) {
   if (someCondition) {
     errors.produce(new ValidationErrorBuildItem(new IllegalStateException()));
     myBuildItem.produce(new MyBuildItem());
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can easily filter all registered beans via the convenient <code>BeanStream</code> returned from the <code>ValidationPhaseBuildItem.getContext().beans()</code> method.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom_context"><a class="anchor" href="#custom_context"></a>10. ユースケース - カスタム CDI コンテキストの登録</h2>
<div class="sectionbody">
<div class="paragraph">
<p>時々、エクステンションは組み込みCDI コンテキストのセットを拡張する必要があります。</p>
</div>
<div class="paragraph">
<p><em>Solution</em>: If you need to register a custom context, use the <code>ContextRegistrationPhaseBuildItem</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A build step that consumes the <code>ContextRegistrationPhaseBuildItem</code> should always produce a <code>ContextConfiguratorBuildItem</code> or at least inject a <code>BuildProducer</code> for this build item, otherwise it could be ignored or processed at the wrong time (e.g. after the correct CDI bootstrap phase).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ContextRegistrationPhaseBuildItem</code> Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
ContextConfiguratorBuildItem registerContext(ContextRegistrationPhaseBuildItem phase) {
      return new ContextConfiguratorBuildItem(phase.getContext().configure(TransactionScoped.class).normal().contextClass(TransactionContext.class));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, each extension that registers a custom CDI context via <code>ContextRegistrationPhaseBuildItem</code> should also produce the <code>CustomScopeBuildItem</code> in order to contribute the custom scope annotation name to the set of bean defining annotations.</p>
</div>
<div class="paragraph">
<p><code>CustomScopeBuildItem</code> Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
CustomScopeBuildItem customScope() {
   return new CustomScopeBuildItem(DotName.createSimple(TransactionScoped.class.getName()));
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="what-if-i-need-to-know-all-the-scopes-used-in-the-application"><a class="anchor" href="#what-if-i-need-to-know-all-the-scopes-used-in-the-application"></a>10.1. What if I Need to Know All the Scopes Used in the Application?</h3>
<div class="paragraph">
<p><em>Solution</em>: You can inject the <code>CustomScopeAnnotationsBuildItem</code> in a build step and use the convenient methods such as <code>CustomScopeAnnotationsBuildItem.isScopeDeclaredOn()</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional_interceptor_bindings"><a class="anchor" href="#additional_interceptor_bindings"></a>11. Use Case - Additional Interceptor Bindings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In rare cases it might be handy to programmatically register an existing annotation that is not annotated with <code>@javax.interceptor.InterceptorBinding</code> as an interceptor binding. This is similar to what CDI achieves through <code>BeforeBeanDiscovery#addInterceptorBinding()</code>. We are going to use <code>InterceptorBindingRegistrarBuildItem</code> to get it done.</p>
</div>
<div class="listingblock">
<div class="title"><code>InterceptorBindingRegistrarBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
InterceptorBindingRegistrarBuildItem addInterceptorBindings() {
    return new InterceptorBindingRegistrarBuildItem(new InterceptorBindingRegistrar() {
        @Override
        public List&lt;InterceptorBinding&gt; getAdditionalBindings() {
            return List.of(InterceptorBinding.of(NotAnInterceptorBinding.class));
        }
    });
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="使用例-追加の修飾子"><a class="anchor" href="#使用例-追加の修飾子"></a>12. 使用例 - 追加の修飾子</h2>
<div class="sectionbody">
<div class="paragraph">
<p>時には、 <code>@javax.inject.Qualifier</code> でアノテーションされていない既存のアノテーションをCDI修飾子として登録しておくと便利かもしれません。これは CDI が <code>BeforeBeanDiscovery#addQualifier()</code> を通して実現していることに似ています。ここでは <code>QualifierRegistrarBuildItem</code> を使ってそれを実現しようとしています。</p>
</div>
<div class="listingblock">
<div class="title"><code>QualifierRegistrarBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
QualifierRegistrarBuildItem addQualifiers() {
    return new QualifierRegistrarBuildItem(new QualifierRegistrar() {
        @Override
        public Map&lt;DotName, Set&lt;String&gt;&gt; getAdditionalQualifiers() {
            return Collections.singletonMap(DotName.createSimple(NotAQualifier.class.getName()),
                                        Collections.emptySet());
        }
    });
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="injection_point_transformation"><a class="anchor" href="#injection_point_transformation"></a>13. Use Case - Injection Point Transformation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every now and then it is handy to be able to change the qualifiers of an injection point programmatically. You can do just that with <code>InjectionPointTransformerBuildItem</code>. The following sample shows how to apply transformation to injection points with type <code>Foo</code> that contain qualifier <code>MyQualifier</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code>InjectionPointTransformerBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
InjectionPointTransformerBuildItem transformer() {
    return new InjectionPointTransformerBuildItem(new InjectionPointsTransformer() {

        public boolean appliesTo(Type requiredType) {
            return requiredType.name().equals(DotName.createSimple(Foo.class.getName()));
        }

        public void transform(TransformationContext context) {
            if (context.getQualifiers().stream()
                    .anyMatch(a -&gt; a.name().equals(DotName.createSimple(MyQualifier.class.getName())))) {
                context.transform()
                        .removeAll()
                        .add(DotName.createSimple(MyOtherQualifier.class.getName()))
                        .done();
            }
        }
    });
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In theory, you can use <a href="#annotations_transformer_build_item">an <code>AnnotationsTransformer</code></a> to achieve the same goal. However, there are few differences that make <code>InjectionPointsTransformer</code> more suitable for this particular task: (1) annotation transformers are applied to all classes during bean discovery, whereas <code>InjectionPointsTransformer</code> is only applied to discovered injection points after bean discovery; (2) with <code>InjectionPointsTransformer</code> you don&#8217;t need to handle various types of injection points (field, parameters of initializer methods, etc.).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-case-resource-annotations-and-injection"><a class="anchor" href="#use-case-resource-annotations-and-injection"></a>14. Use Case - Resource Annotations and Injection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>ResourceAnnotationBuildItem</code> can be used to specify resource annotations that make it possible to resolve non-CDI injection points, such as Jakarta EE resources. An integrator must also provide a corresponding <code>io.quarkus.arc.ResourceReferenceProvider</code> service provider implementation.</p>
</div>
<div class="listingblock">
<div class="title"><code>ResourceAnnotationBuildItem</code> Example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void setupResourceInjection(BuildProducer&lt;ResourceAnnotationBuildItem&gt; resourceAnnotations, BuildProducer&lt;GeneratedResourceBuildItem&gt; resources) {
    resources.produce(new GeneratedResourceBuildItem("META-INF/services/io.quarkus.arc.ResourceReferenceProvider",
        MyResourceReferenceProvider.class.getName().getBytes()));
    resourceAnnotations.produce(new ResourceAnnotationBuildItem(DotName.createSimple(MyAnnotation.class.getName())));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build_metadata"><a class="anchor" href="#build_metadata"></a>15. 利用可能なビルドタイムメタデータ</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>BuildExtension.BuildContext</code> で動作する上記のエクステンションはいずれも、ビルドタイムに生成される特定のビルドタイムメタデータを利用することができます。 <code>io.quarkus.arc.processor.BuildExtension.Key</code> にある組込キーは以下の通りです。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ANNOTATION_STORE</dt>
<dd>
<p>Contains an <code>AnnotationStore</code> that keeps information about all <code>AnnotationTarget</code> annotations after application of annotation transformers</p>
</dd>
<dt class="hdlist1">INJECTION_POINTS</dt>
<dd>
<p><code>Collection&lt;InjectionPointInfo&gt;</code> containing all injection points</p>
</dd>
<dt class="hdlist1">BEANS</dt>
<dd>
<p><code>Collection&lt;BeanInfo&gt;</code> containing all beans</p>
</dd>
<dt class="hdlist1">REMOVED_BEANS</dt>
<dd>
<p><code>Collection&lt;BeanInfo&gt;</code> 削除されたすべての <a href="cdi-reference.html#remove_unused_beans">Bean</a> を含む</p>
</dd>
<dt class="hdlist1">OBSERVERS</dt>
<dd>
<p><code>Collection&lt;ObserverInfo&gt;</code> containing all observers</p>
</dd>
<dt class="hdlist1">SCOPES</dt>
<dd>
<p><code>Collection&lt;ScopeInfo&gt;</code> containing all scopes, including custom ones</p>
</dd>
<dt class="hdlist1">QUALIFIERS</dt>
<dd>
<p><code>Map&lt;DotName, ClassInfo&gt;</code> すべての修飾子を含む</p>
</dd>
<dt class="hdlist1">INTERCEPTOR_BINDINGS</dt>
<dd>
<p><code>Map&lt;DotName, ClassInfo&gt;</code> containing all interceptor bindings</p>
</dd>
<dt class="hdlist1">STEREOTYPES</dt>
<dd>
<p><code>Map&lt;DotName, StereotypeInfo&gt;</code> containing all stereotypes</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>これらのメタデータを取得するには、そのキーのエクステンションコンテキストオブジェクトをクエリするだけ可能です。これらのメタデータはビルドが進むにつれて利用可能になることに注意してください。エクステンションがまだ生成されていないメタデータを取得しようとすると、 <code>null</code> が返されます。どのエクステンションがどのメタデータにアクセスできるかをまとめてみました。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">AnnotationsTransformer</dt>
<dd>
<p>ブートストラップのどのフェーズでもいつでも使えるので、メタデータに頼るべきではありません。</p>
</dd>
<dt class="hdlist1">ContextRegistrar</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> . <code>STEREOTYPES</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">InjectionPointsTransformer</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> . <code>STEREOTYPES</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">ObserverTransformer</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> . <code>STEREOTYPES</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">BeanRegistrar</dt>
<dd>
<p><code>ANNOTATION_STORE</code>, <code>QUALIFIERS</code>, <code>INTERCEPTOR_BINDINGS</code>, <code>STEREOTYPES</code>, <code>BEANS</code> (class-based beans only), <code>OBSERVERS</code> (class-based observers only), <code>INJECTION_POINTS</code> にアクセスできます。</p>
</dd>
<dt class="hdlist1">ObserverRegistrar</dt>
<dd>
<p><code>ANNOTATION_STORE</code> , <code>QUALIFIERS</code> , <code>INTERCEPTOR_BINDINGS</code> , <code>STEREOTYPES</code> , <code>BEANS</code> , <code>OBSERVERS</code> (クラスベースのオブザーバーのみ), <code>INJECTION_POINTS</code> にアクセス可能です。</p>
</dd>
<dt class="hdlist1">BeanDeploymentValidator</dt>
<dd>
<p>すべてのビルドメタデータにアクセスできます</p>
</dd>
</dl>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">Japanese</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
