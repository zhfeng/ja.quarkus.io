<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Getting started with Reactive - 1.11</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/1.11/guides/getting-started-reactive" />
  <meta property="og:title" content="Quarkus - Getting started with Reactive - 1.11" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/getting-started-reactive">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >ENGLISH</a></li>
          <li><a href="https://ja.quarkus.io/">JAPANESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/1.11/guides/"> Back to Guides</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">Select Guide Version</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.9 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" selected>1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">Quarkus - Getting started with Reactive </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#前提条件">前提条件</a></li>
<li><a href="#ソリューション">ソリューション</a></li>
<li><a href="#the-multiple-reactive-facets-of-quarkus">The multiple reactive facets of Quarkus</a></li>
<li><a href="#mutiny">Mutiny - A reactive programming library</a></li>
<li><a href="#プロジェクトのブートストラップ">プロジェクトのブートストラップ</a>
<ul class="sectlevel2">
<li><a href="#リアクティブな-jax-rs-リソース">リアクティブな JAX-RS リソース</a></li>
</ul>
</li>
<li><a href="#ストリームの取り扱い">ストリームの取り扱い</a></li>
<li><a href="#リアクティブ-api-の使用">リアクティブ API の使用</a>
<ul class="sectlevel2">
<li><a href="#using-quarkus-reactive-apis">Using Quarkus reactive APIs</a></li>
<li><a href="#using-vert-x-clients">Using Vert.x clients</a></li>
<li><a href="#using-rxjava-or-reactor-apis">Using RxJava or Reactor APIs</a></li>
<li><a href="#using-completionstages-or-publisher-api">Using CompletionStages or Publisher API</a></li>
</ul>
</li>
<li><a href="#次のステップ">次のステップ</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkusを使用してリアクティブアプリケーションを作成する方法と、Quarkusが提供するさまざまなリアクティブ機能について説明します。このガイドでは、以下の内容を説明します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkusエンジンの概要と、それがどのようにリアクティブを可能にしているかを簡単に説明します。</p>
</li>
<li>
<p>概説Mutiny - Quarkusによって使用されているリアクティブプログラミングライブラリ</p>
</li>
<li>
<p>The difference between RESTEasy, RESTEasy Reactive and Reactive Routes</p>
</li>
<li>
<p>The bootstrap of a reactive application using RESTEasy Reactive</p>
</li>
<li>
<p>リアクティブな JAX-RS エンドポイントの作成（非同期、ストリーム&#8230;&#8203;）</p>
</li>
<li>
<p>リアクティブデータベースアクセス</p>
</li>
<li>
<p>その他のリアクティブAPIの使用</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="前提条件"><a class="anchor" href="#前提条件"></a>前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドを完成させるには、以下が必要です:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>less than 15 minutes</p>
</li>
<li>
<p>IDE</p>
</li>
<li>
<p>JDK 8 or 11+ installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p>Apache Maven 3.6.2+</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ソリューション"><a class="anchor" href="#ソリューション"></a>ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#bootstrapping-the-project">プロジェクトのブートストラップ</a>とそれ以降の解説に従って、ステップバイステップでアプリを作成していくことをお勧めします。</p>
</div>
<div class="paragraph">
<p>しかしながら、完成した例をすぐ確認することもできます。</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">アーカイブ</a> をダウンロードするか、gitレポジトリをクローンします：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone https://github.com/quarkusio/quarkus-quickstarts.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>ソリューションは <code>getting-started-reactive</code> と <code>getting-started-reactive-crud</code> のディレクトリにあります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-multiple-reactive-facets-of-quarkus"><a class="anchor" href="#the-multiple-reactive-facets-of-quarkus"></a>The multiple reactive facets of Quarkus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkusはリアクティブです。ボンネットの下を見ると、Quarkusアプリケーションの動力源となっているリアクティブエンジンを見つけることができます。このエンジンはEclipse Vert.x（ <a href="https://vertx.io" class="bare">https://vertx.io</a> ）です。すべてのネットワークI/Oは、ノンブロッキングでリアクティブなVert.xエンジンを通過します。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/quarkus-reactive-stack.png" alt="Quarkusはリアクティブなエンジンをベースとしている" width="70%"></span></p>
</div>
<div class="paragraph">
<p>2つの例を挙げて、その仕組みを説明してみましょう。入ってくるHTTPリクエストを想像してみてください。Quarkusに組み込まれたHTTPサーバー（Vert.x）がリクエストを受信し、アプリケーションにルーティングします。リクエストが <em>命令的な</em> メソッド（従来のJAX-RS、 <code>@Blocking</code> &#8230;&#8203;でアノテーションされたコード）をターゲットにしている場合、ルーティング層は <em>ワーカースレッド</em> でリソースメソッドを呼び出し、データが利用可能になるとレスポンスを書き込みます。今のところ、目新しいものも目立ったものもありません。次の図は、この動作を示しています。この場合、アプリケーションコードはワーカースレッドで呼び出され、ビジネスロジックはそのスレッドをブロックすることができます。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/http-blocking-sequence.png" alt="命令的な route を使ったときの挙動" width="70%"></span></p>
</div>
<div class="paragraph">
<p>しかし、HTTPリクエストがリアクティブなメソッド（RESTEasy Reactiveを使用したJAX-RS、リアクティブなルート、 <code>@Incoming</code> メソッドは <code>@Blocking</code> &#8230;&#8203;でアノテーションされていない）をターゲットにしている場合、ルーティング層はI/Oスレッド上でルートを呼び出し、より高い同時実行性とパフォーマンスなどの多くの利点を与えます。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/http-reactive-sequence.png" alt="リアクティブな route を使ったときの挙動" width="70%"></span></p>
</div>
<div class="paragraph">
<p>QuarkusはI/Oスレッドを使用してコードを呼び出すため、コンテキストスイッチを節約し、大規模なスレッドプール管理を回避し、リソースの利用率を向上させます。ただし、コードはそのスレッドをブロックしてはいけ <strong>ませ</strong> ん。なぜでしょうか？なぜなら、I/O スレッドは複数の同時リクエストを処理するために使用されます。リクエストの処理がいくつかのI/Oを実行する必要があるために進行できなくなるとすぐに、これらのI/Oをスケジュールし、継続(continuation)を渡します。別のリクエストを処理できるスレッドを解放します。スケジュールされたI/Oが完了すると、I/Oスレッドに戻って継続(continuation)が実行されます。</p>
</div>
<div class="paragraph">
<p>結果として、多くのQuarkusコンポーネントは、データベースアクセス（PostgreSQL、MySQL、Mongoなど）、アプリケーションサービス（メール、テンプレートエンジンなど）、メッセージング（Kafka、AMQPなど）など、リアクティブを念頭に置いて設計されています。しかし、このモデルの恩恵を十分に受けるためには、アプリケーションコードはノンブロッキングで書かれなければなりません。そこで、リアクティブ API を持つことが究極の武器となります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mutiny"><a class="anchor" href="#mutiny"></a>Mutiny - A reactive programming library</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/smallrye/smallrye-mutiny">Mutiny</a> は、非同期アクションを表現したり構成したりすることができるリアクティブプログラミングライブラリです。2つのタイプがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io.smallrye.mutiny.Uni</code> - for asynchronous action providing 0 or 1 result</p>
</li>
<li>
<p><code>io.smallrye.mutiny.Multi</code> - マルチアイテム（バックプレッシャー付き）ストリーム用</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>どちらのタイプも lazy で、サブスクリプションパターンに従います。計算は、実際に必要とされる場合にのみ開始されます (すなわち、サブスクライバがエンリストした場合)。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">uni.subscribe().with(
    result -&gt; System.out.println("result is " + result),
    failure -&gt; failure.printStackTrace()
);

multi.subscribe().with(
    item -&gt; System.out.println("Got " + item),
    failure -&gt; failure.printStackTrace()
);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Uni</code> も <code>Multi</code> もイベント駆動型の API を公開しています: 与えられたイベント (成功、失敗など) に対して何をしたいかを表現します。これらのAPIはグループ(操作の種類)に分けられており、より表現力を高め、1つのクラスに100個ものメソッドをアタッチすることを避けています。主な操作の種類は、失敗に反応するもの、完了するもの、アイテムを操作するもの、抽出するもの、収集するものなどです。ナビゲーション可能なAPIでスムーズなコーディングを実現し、結果的にリアクティブ周りの知識をあまり必要としないようにしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">httpCall
    .onFailure().recoverWithItem("my fallback");</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.reactive-streams.org/" class="bare">https://www.reactive-streams.org/</a> <code>Multi</code> は Reactive Streams <code>Publisher</code> を実装しているので、Reactive Streams のバックプレッシャーメカニズムを実装しています。 <code>Uni</code> へのサブスクリプションは結果に興味があることを示すのに十分なので、 <code>Uni</code> は <code>Publisher</code> を実装していません。これは、Reactive Streams のサブスクリプション/リクエスト式がより複雑であるため、よりシンプルでスムーズな API のアイデアを念頭に置いたものです。</p>
</div>
<div class="paragraph">
<p>Quarkusのリアクティブな面と命令的な面の統合を受け入れた <code>Uni</code> と <code>Multi</code> は、両方とも命令的構造への橋渡しをしてくれます。たとえば、 <code>Multi</code> を <code>Iterable</code> に変換したり、 <code>Uni</code> .NET で生成されたアイテムを <em>待っ</em> たりすることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Block until the result is available
String result = uni.await().indefinitely();

// Transform an asynchronous stream into a blocking iterable
stream.subscribe().asIterable().forEach(s -&gt; System.out.println("Item is " + s));</code></pre>
</div>
</div>
<div class="paragraph">
<p>この時点で、あなたがRxJavaやReactorのユーザーであれば、お馴染みの <code>Flowable</code> , <code>Single</code> , <code>Flux</code> , , <code>Mono</code> &#8230;&#8203; Mutinyでは、 <code>Unis</code> と <code>Multis</code> をRX JavaやReactorの型に変換することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Maybe&lt;String&gt; maybe = uni.convert().with(UniRxConverters.toMaybe());
Flux&lt;String&gt; flux = multi.convert().with(MultiReactorConverters.toFlux());</code></pre>
</div>
</div>
<div class="paragraph">
<p>しかし、Vert.xはどうでしょうか？Vert.xのAPIはMutiny型を使っても利用できます。以下のスニペットは、Vert.x Web Clientの使い方を示しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Use io.vertx.mutiny.ext.web.client.WebClient
client = WebClient.create(vertx,
                new WebClientOptions().setDefaultHost("fruityvice.com").setDefaultPort(443).setSsl(true)
                        .setTrustAll(true));
// ...
Uni&lt;JsonObject&gt; uni =
    client.get("/api/fruit/" + name)
        .send()
        .onItem().transform(resp -&gt; {
            if (resp.statusCode() == 200) {
                return resp.bodyAsJsonObject();
            } else {
                return new JsonObject()
                        .put("code", resp.statusCode())
                        .put("message", resp.bodyAsString());
            }
        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後になりますが、MutinyにはMicroProfile Context Propagationとの統合が組み込まれているので、リアクティブパイプラインでトランザクションやトレーサビリティデータなどを伝搬することができます。</p>
</div>
<div class="paragraph">
<p>話はもういい、手を汚すんだ！</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="プロジェクトのブートストラップ"><a class="anchor" href="#プロジェクトのブートストラップ"></a>プロジェクトのブートストラップ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkusでリアクティブアプリケーションを実装するには、いくつかの方法があります。このガイドでは、Quarkusのリアクティブエンジンの恩恵を受けるRESTEasyの実装であるRESTEasy Reactiveを使用します。デフォルトでは、I/Oスレッド上のHTTPエンドポイントを呼び出します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<em>従来の</em> RESTEasy を使用することは可能ですが、 <code>quarkus-resteasy-mutiny</code> エクステンションを追加する必要があり、メソッドは <em>ワーカースレッド</em> 上で呼び出されます。つまり、リアクティブプログラミングを使用するとはいえ、ワーカースレッドを必要とし、その目的は達成されません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>新しいQuarkusプロジェクトを作成する最も簡単な方法は、ターミナルを開いて以下のコマンドを実行することです：</p>
</div>
<div class="paragraph">
<p>For Linux and macOS users</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:1.11.7.Final:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=getting-started-reactive \
    -DclassName="org.acme.getting.started.ReactiveGreetingResource" \
    -Dpath="/hello" \
    -Dextensions="resteasy-reactive"
cd getting-started-reactive</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Windows users</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cmd を使用する場合は、(前方スラッシュを使用しないでください <code>\</code> )</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:1.11.7.Final:create -DprojectGroupId=org.acme -DprojectArtifactId=getting-started-reactive -DclassName="org.acme.getting.started.ReactiveGreetingResource" -Dpath="/hello" -Dextensions="resteasy-reactive"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Powershell を使用する場合は、 <code>-D</code> のパラメータを二重引用符で囲みます。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:1.11.7.Final:create "-DprojectGroupId=org.acme" "-DprojectArtifactId=getting-started-reactive" "-DclassName=org.acme.getting.started.ReactiveGreetingResource" "-Dpath=/hello" "-Dextensions=resteasy-reactive"</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>./getting-started-reactive</code> 内に以下が生成されます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mavenの構造</p>
</li>
<li>
<p><code>/hello</code> で公開されている <code>org.acme.quickstart.ReactiveGreetingResource</code> リソース</p>
</li>
<li>
<p>an associated unit test</p>
</li>
<li>
<p>a landing page that is accessible on <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code> after starting the application</p>
</li>
<li>
<p><code>src/main/docker</code> にある <code>native</code> と <code>jvm</code> の両方のモード用の <code>Dockerfile</code> ファイルの例</p>
</li>
<li>
<p>the application configuration file</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="リアクティブな-jax-rs-リソース"><a class="anchor" href="#リアクティブな-jax-rs-リソース"></a>リアクティブな JAX-RS リソース</h3>
<div class="paragraph">
<p>プロジェクト作成時に、 <code>src/main/java/org/acme/getting/started/ReactiveGreetingResource.java</code> ファイルは以下の内容で作成されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

@Path("/hello")
public class ReactiveGreetingResource {

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "Hello RESTEasy Reactive";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは非常にシンプルなRESTエンドポイントで、"/hello"上のリクエストに対して"Hello RESTEasy Reactive"を返します。RESTEAsy Reactiveを使用しているので、このメソッドはI/Oスレッド上で呼び出されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>ワーカースレッド</em> でこのメソッドを呼び出すようにQuarkusに指示するには、 <code>io.smallrye.common.annotation.Blocking</code> アノテーションを付けます。メソッドやクラスで <code>@Blocking</code> を使用したり、 <code>Application</code> クラスをアノテーションすることで、アプリケーション全体で を使用できるようにすることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.ws.rs.ApplicationPath;
import javax.ws.rs.core.Application;
import io.smallrye.common.annotation.Blocking;

@ApplicationPath("/")
@Blocking
public class RestBlockingApplication extends Application {
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>それでは、以下の内容の <code>ReactiveGreetingService</code> クラスを作成してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started;

import io.smallrye.mutiny.Multi;
import io.smallrye.mutiny.Uni;

import javax.enterprise.context.ApplicationScoped;
import java.time.Duration;

@ApplicationScoped
public class ReactiveGreetingService {

    public Uni&lt;String&gt; greeting(String name) {
        return Uni.createFrom().item(name)
                .onItem().transform(n -&gt; String.format("hello %s", n));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、 <code>ReactiveGreetingResource</code> クラスを以下の内容に合わせて編集します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started;

import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

import io.smallrye.mutiny.Multi;
import io.smallrye.mutiny.Uni;
import org.reactivestreams.Publisher;

@Path("/hello")
public class ReactiveGreetingResource {

    @Inject
    ReactiveGreetingService service;

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    @Path("/greeting/{name}")
    public Uni&lt;String&gt; greeting(String name) {
        return service.greeting(name);
    }

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "hello";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ReactiveGreetingService</code> クラスには、 <code>Uni</code> を生成する簡単なメソッドが含まれています。この例では、結果として得られるアイテムがすぐに出力されますが、非同期 API で <code>Uni</code> を生成することは想像できます。これについては、このガイドで後ほど説明します。</p>
</div>
<div class="paragraph">
<p>それでは、以下でアプリケーションを起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>実行したら、 <a href="http://localhost:8080/hello/greeting/neo" class="bare">http://localhost:8080/hello/greeting/neo</a> を開いて、期待通りのグリーティングメッセージが表示されているか確認してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ストリームの取り扱い"><a class="anchor" href="#ストリームの取り扱い"></a>ストリームの取り扱い</h2>
<div class="sectionbody">
<div class="paragraph">
<p>これまでは、非同期の結果を返すだけでした。このセクションでは、複数のアイテムを伝えるストリームを使ってアプリケーションを拡張します。これらのストリームは Kafka や他のデータソースからのものでも構いませんが、物事をシンプルに保つために、定期的にグリーティングメッセージを生成するだけにします。</p>
</div>
<div class="paragraph">
<p><code>ReactiveGreetingService</code> で、以下のメソッドを追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public Multi&lt;String&gt; greetings(int count, String name) {
  return Multi.createFrom().ticks().every(Duration.ofSeconds(1))
        .onItem().transform(n -&gt; String.format("hello %s - %d", name, n))
        .transform().byTakingFirstItems(count);
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>import io.smallrye.mutiny.Multi;</code> と <code>import java.time.Duration;</code> のステートメントを追加する必要があるかもしれません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>1秒ごとに greeting メッセージを生成し、 <code>count</code> メッセージの後に停止します。</p>
</div>
<div class="paragraph">
<p><code>ReactiveGreetingResource</code> で、以下のメソッドを追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@GET
@Produces(MediaType.APPLICATION_JSON)
@Path("/greeting/{count}/{name}")
public Multi&lt;String&gt; greetings(int count, String name) {
  return service.greetings(count, name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このエンドポイントは、アイテムをJSON配列としてクライアントにストリームします。メッセージの名前と数は、パスパラメータを使用してパラメータ化されます。</p>
</div>
<div class="paragraph">
<p>そのため、エンドポイントを呼び出すと、次のようなものが生成されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl http://localhost:8080/hello/greeting/3/neo
["hello neo - 0", "hello neo - 1", "hello neo - 2"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、 <code>Multi</code> を返すことで Server-Sent Event レスポンスを生成することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@GET
@Produces(MediaType.SERVER_SENT_EVENTS)
@RestSseElementType(MediaType.TEXT_PLAIN)
@Path("/stream/{count}/{name}")
public Multi&lt;String&gt; greetingsAsStream(int count, String name) {
    return service.greetings(count, name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>先ほどのスニペットとの違いは、生成される型と、各イベントの型を示す <code>@RestSseElementType</code> アノテーションだけです。 <code>@Produces</code> アノテーションは <code>SERVER_SENT_EVENTS</code> を定義しているので、JAX-RS は各（入れ子になった）イベントのコンテンツタイプを知るために必要です。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>import org.jboss.resteasy.reactive.RestSseElementType;</code> の文を追加する必要があるかもしれません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下で結果を見ることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl -N http://localhost:8080/hello/stream/5/neo
data: hello neo - 0

data: hello neo - 1

data: hello neo - 2

data: hello neo - 3

data: hello neo - 4</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="リアクティブ-api-の使用"><a class="anchor" href="#リアクティブ-api-の使用"></a>リアクティブ API の使用</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="using-quarkus-reactive-apis"><a class="anchor" href="#using-quarkus-reactive-apis"></a>Using Quarkus reactive APIs</h3>
<div class="paragraph">
<p>QuarkusはMutinyモデルを使用した多くのリアクティブAPIを提供しています。このセクションでは、リアクティブPostgreSQLドライバを使用して、ノンブロッキングでリアクティブな方法でデータベースと対話する方法を見ていきます。</p>
</div>
<div class="paragraph">
<p>以下で新規プロジェクトを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:1.11.7.Final:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=getting-started-reactive-crud \
    -DclassName="org.acme.reactive.crud.FruitResource" \
    -Dpath="/fruits" \
    -Dextensions="resteasy-reactive,resteasy-reactive-jackson,reactive-pg-client"
cd getting-started-reactive-crud</code></pre>
</div>
</div>
<div class="paragraph">
<p>このアプリケーションはPostgreSQLデータベースと対話しているので、DBが必要です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run --ulimit memlock=-1:-1 -it --rm=true --memory-swappiness=0 \
           --name postgres-quarkus-reactive -e POSTGRES_USER=quarkus_test \
           -e POSTGRES_PASSWORD=quarkus_test -e POSTGRES_DB=quarkus_test \
           -p 5432:5432 postgres:11.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>続いて、データソースを設定してみましょう。 <code>src/main/resources/application.properties</code> を開き、以下の内容を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=quarkus_test
quarkus.datasource.password=quarkus_test
quarkus.datasource.reactive.url=postgresql://localhost:5432/quarkus_test
myapp.schema.create=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>最初の3行はデータソースを定義しています。最後の行は、アプリケーションが初期化されたときにいくつかの項目を挿入するかどうかを示すためにアプリケーションで使用されます。</p>
</div>
<div class="paragraph">
<p>では、 <em>エンティティを</em> 作成しましょう。以下の内容で <code>org.acme.reactive.crud.Fruit</code> クラスを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.reactive.crud;

import io.smallrye.mutiny.Multi;
import io.smallrye.mutiny.Uni;
import io.vertx.mutiny.pgclient.PgPool;
import io.vertx.mutiny.sqlclient.Row;
import io.vertx.mutiny.sqlclient.RowSet;
import io.vertx.mutiny.sqlclient.Tuple;

import java.util.stream.StreamSupport;

public class Fruit {

    public Long id;

    public String name;

    public Fruit() {
        // default constructor.
    }

    public Fruit(String name) {
        this.name = name;
    }

    public Fruit(Long id, String name) {
        this.id = id;
        this.name = name;
    }

    public static Multi&lt;Fruit&gt; findAll(PgPool client) {
        return client.query("SELECT id, name FROM fruits ORDER BY name ASC").execute()
                // Create a Multi from the set of rows:
                .onItem().transformToMulti(set -&gt; Multi.createFrom().items(() -&gt; StreamSupport.stream(set.spliterator(), false)))
                // For each row create a fruit instance
                .onItem().transform(Fruit::from);
    }

    public static Uni&lt;Fruit&gt; findById(PgPool client, Long id) {
        return client.preparedQuery("SELECT id, name FROM fruits WHERE id = $1").execute(Tuple.of(id))
                .onItem().transform(RowSet::iterator)
                .onItem().transform(iterator -&gt; iterator.hasNext() ? from(iterator.next()) : null);
    }

    public Uni&lt;Long&gt; save(PgPool client) {
        return client.preparedQuery("INSERT INTO fruits (name) VALUES ($1) RETURNING (id)").execute(Tuple.of(name))
                .onItem().transform(pgRowSet -&gt; pgRowSet.iterator().next().getLong("id"));
    }

    public Uni&lt;Boolean&gt; update(PgPool client) {
        return client.preparedQuery("UPDATE fruits SET name = $1 WHERE id = $2").execute(Tuple.of(name, id))
                .onItem().transform(pgRowSet -&gt; pgRowSet.rowCount() == 1);
    }

    public static Uni&lt;Boolean&gt; delete(PgPool client, Long id) {
        return client.preparedQuery("DELETE FROM fruits WHERE id = $1").execute(Tuple.of(id))
                .onItem().transform(pgRowSet -&gt; pgRowSet.rowCount() == 1);
    }

    private static Fruit from(Row row) {
        return new Fruit(row.getLong("id"), row.getString("name"));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この <em>エンティティに</em> は、データベースから行を検索、更新、削除するためのいくつかのフィールドとメソッドが含まれています。これらのメソッドは、結果が取得されると非同期的に生成されるので、 <code>Unis</code> または <code>Multis</code> のいずれかを返します。反応型PostgreSQLクライアントは既に <code>Uni</code> と <code>Multi</code> のインスタンスを提供していることに注意してください。つまり、データベースからの結果を <em>ビジネスに適した</em> オブジェクトに変換するだけです。</p>
</div>
<div class="paragraph">
<p>アプリケーションの起動時にデータベースを初期化する目的で、以下の内容の <code>DBInit</code> という名前のクラスを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.reactive.crud;

import io.quarkus.runtime.StartupEvent;
import io.vertx.mutiny.pgclient.PgPool;
import org.eclipse.microprofile.config.inject.ConfigProperty;

import javax.enterprise.context.ApplicationScoped;
import javax.enterprise.event.Observes;

@ApplicationScoped
public class DBInit {

    private final PgPool client;
    private final boolean schemaCreate;

    public DBInit(PgPool client, @ConfigProperty(name = "myapp.schema.create", defaultValue = "true") boolean schemaCreate) {
        this.client = client;
        this.schemaCreate = schemaCreate;
    }

    void onStart(@Observes StartupEvent ev) {
        if (schemaCreate) {
            initdb();
        }
    }

    private void initdb() {
        client.query("DROP TABLE IF EXISTS fruits").execute()
                .flatMap(r -&gt; client.query("CREATE TABLE fruits (id SERIAL PRIMARY KEY, name TEXT NOT NULL)").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Kiwi')").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Durian')").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Pomelo')").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Lychee')").execute())
                .await().indefinitely();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、この <code>Fruit</code> クラスを <code>FruitResource</code> . <code>FruitResource</code> クラスを以下の内容に合わせて編集します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.reactive.crud;

import java.net.URI;

import javax.ws.rs.Consumes;
import javax.ws.rs.DELETE;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.ResponseBuilder;
import javax.ws.rs.core.Response.Status;

import io.smallrye.mutiny.Multi;
import io.smallrye.mutiny.Uni;
import io.vertx.mutiny.pgclient.PgPool;

@Path("fruits")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class FruitResource {

    private final PgPool client;

    public FruitResource(PgPool client) {
        this.client = client;
    }

    private void initdb() {
        client.query("DROP TABLE IF EXISTS fruits").execute()
                .flatMap(r -&gt; client.query("CREATE TABLE fruits (id SERIAL PRIMARY KEY, name TEXT NOT NULL)").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Kiwi')").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Durian')").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Pomelo')").execute())
                .flatMap(r -&gt; client.query("INSERT INTO fruits (name) VALUES ('Lychee')").execute())
                .await().indefinitely();
    }

    @GET
    public Multi&lt;Fruit&gt; get() {
        return Fruit.findAll(client);
    }

    @GET
    @Path("{id}")
    public Uni&lt;Response&gt; getSingle(Long id) {
        return Fruit.findById(client, id)
                .onItem().transform(fruit -&gt; fruit != null ? Response.ok(fruit) : Response.status(Status.NOT_FOUND))
                .onItem().transform(ResponseBuilder::build);
    }

    @POST
    public Uni&lt;Response&gt; create(Fruit fruit) {
        return fruit.save(client)
                .onItem().transform(id -&gt; URI.create("/fruits/" + id))
                .onItem().transform(uri -&gt; Response.created(uri).build());
    }

    @PUT
    @Path("{id}")
    public Uni&lt;Response&gt; update(Long id, Fruit fruit) {
        return fruit.update(client)
                .onItem().transform(updated -&gt; updated ? Status.OK : Status.NOT_FOUND)
                .onItem().transform(status -&gt; Response.status(status).build());
    }

    @DELETE
    @Path("{id}")
    public Uni&lt;Response&gt; delete(Long id) {
        return Fruit.delete(client, id)
                .onItem().transform(deleted -&gt; deleted ? Status.NO_CONTENT : Status.NOT_FOUND)
                .onItem().transform(status -&gt; Response.status(status).build());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このリソースは、 <code>Fruit</code> クラスが生成した結果に基づいて <code>Uni</code> と <code>Multi</code> のインスタンスを返します。</p>
</div>
</div>
<div class="sect2">
<h3 id="using-vert-x-clients"><a class="anchor" href="#using-vert-x-clients"></a>Using Vert.x clients</h3>
<div class="paragraph">
<p>先ほどの例では、Quarkusが提供する <em>サービス</em> を使用しています。また、Vert.xクライアントを直接使用することもできます。</p>
</div>
<div class="paragraph">
<p>まず、 <code>quarkus-vertx</code> の エクステンションが存在することを確認してください。存在しない場合は、以下のコマンドを実行して エクステンションを有効にします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:1.11.7.Final:add-extensions \
    -Dextensions=vertx</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、手動で <code>quarkus-vertx</code> を依存関係に追加してください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
	&lt;groupId&gt;io.quarkus&lt;/groupId&gt;
	&lt;artifactId&gt;quarkus-vertx&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vert.x APIのMutinyバージョンがあります。このAPIは独立してインポートできるいくつかのアーティファクトに分かれています。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">groupId:artifactId</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-core</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for Vert.x Core</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-mail-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x Mail Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-web-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x Web Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-mongo-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x Mongo Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-redis-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x Redis Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-cassandra-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x Cassandra Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-consul-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x Consul Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-kafka-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x Kafka Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-amqp-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x AMQP Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.smallrye.reactive:smallrye-mutiny-vertx-rabbitmq-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mutiny API for the Vert.x RabbitMQ Client</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>また、 <a href="http://smallrye.io/smallrye-reactive-utils/apidocs/" class="bare">http://smallrye.io/smallrye-reactive-utils/apidocs/</a> で利用可能な API を確認できます。</p>
</div>
<div class="paragraph">
<p>例を挙げてみましょう。以下の依存関係をアプリケーションに追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.smallrye.reactive&lt;/groupId&gt;
    &lt;artifactId&gt;smallrye-mutiny-vertx-web-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vert.x Web ClientのMutiny APIを提供します。すると、以下のようにWebクライアントを利用することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.vertx;

import io.smallrye.mutiny.Uni;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.client.WebClientOptions;
import io.vertx.mutiny.core.Vertx;
import io.vertx.mutiny.ext.web.client.WebClient;
import org.jboss.resteasy.annotations.jaxrs.PathParam;

import javax.annotation.PostConstruct;
import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

@Path("/fruit-data")
public class ResourceUsingWebClient {

    @Inject
    Vertx vertx;

    private WebClient client;

    @PostConstruct
    void initialize() {
        this.client = WebClient.create(vertx,
                new WebClientOptions().setDefaultHost("fruityvice.com").setDefaultPort(443).setSsl(true)
                        .setTrustAll(true));
    }

    @GET
    @Produces(MediaType.APPLICATION_JSON)
    @Path("/{name}")
    public Uni&lt;JsonObject&gt; getFruitData(@PathParam("name") String name) {
        return client.get("/api/fruit/" + name)
                .send()
                .map(resp -&gt; {
                    if (resp.statusCode() == 200) {
                        return resp.bodyAsJsonObject();
                    } else {
                        return new JsonObject()
                                .put("code", resp.statusCode())
                                .put("message", resp.bodyAsString());
                    }
                });
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>重要なポイントは2つあります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>インジェクションされた Vert.x インスタンスは、Vert.x の Mutiny バリアントである <code>io.vertx.mutiny.core.Vertx</code> タイプを持っています。</p>
</li>
<li>
<p>Web クライアントは <code>io.vertx.mutiny.ext.web.client.WebClient</code> から作成されます。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vert.x APIのMutinyバージョンも提供しています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sendAndAwait</code> . <code>andAwait</code> のような <code>andAwait</code> メソッドは、結果が得られるまで呼び出し元のスレッドがブロックされていることを示しています。そのような方法でイベントループ/IOスレッドをブロックしないように注意してください。</p>
</li>
<li>
<p><code>andForget</code> <code>writeAndForget</code> のような <code>Uni</code> を返すメソッドが利用可能です。<code>andForget</code> は操作の成否を示す結果の <code>Uni</code> を必要としないことを示しています。しかし、サブスクライブしないと操作が発動しないことを覚えておいてください。<code>andForget</code> はこれを管理してくれるうえに、サブスクリプションも管理します。</p>
</li>
<li>
<p><code>toMulti</code> methods allowing to transform a Vert.x <code>ReadStream</code> into a <code>Multi</code></p>
</li>
<li>
<p><code>toBlockingIterable</code> / <code>toBlockingStream</code> メソッドは、Vert.x <code>ReadStream</code> をブロッキング可能な iterable またはブロッキング可能な <code>java.util.Stream</code> に変換することができます。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-rxjava-or-reactor-apis"><a class="anchor" href="#using-rxjava-or-reactor-apis"></a>Using RxJava or Reactor APIs</h3>
<div class="paragraph">
<p>Mutiny は RxJava 2 と Project Reactor の型を <code>Uni</code> と <code>Multi</code> に変換するユーティリティを提供します。</p>
</div>
<div class="paragraph">
<p>RxJava 2のコンバータは以下の依存関係にあります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.smallrye.reactive&lt;/groupId&gt;
    &lt;artifactId&gt;mutiny-rxjava&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>そこで、RxJava 2 の型を返す API ( <code>Completable</code> , <code>Single</code> , <code>Maybe</code> , <code>Observable</code> , <code>Flowable</code> ) を持っている場合は、以下のように <code>Unis</code> と <code>Multis</code> を作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.smallrye.mutiny.converters.multi.MultiRxConverters;
import io.smallrye.mutiny.converters.uni.UniRxConverters;
// ...
Uni&lt;Void&gt; uniFromCompletable = Uni.createFrom().converter(UniRxConverters.fromCompletable(), completable);
Uni&lt;String&gt; uniFromSingle = Uni.createFrom().converter(UniRxConverters.fromSingle(), single);
Uni&lt;String&gt; uniFromMaybe = Uni.createFrom().converter(UniRxConverters.fromMaybe(), maybe);
Uni&lt;String&gt; uniFromEmptyMaybe = Uni.createFrom().converter(UniRxConverters.fromMaybe(), emptyMaybe);
Uni&lt;String&gt; uniFromObservable = Uni.createFrom().converter(UniRxConverters.fromObservable(), observable);
Uni&lt;String&gt; uniFromFlowable = Uni.createFrom().converter(UniRxConverters.fromFlowable(), flowable);

Multi&lt;Void&gt; multiFromCompletable = Multi.createFrom().converter(MultiRxConverters.fromCompletable(), completable);
Multi&lt;String&gt; multiFromSingle = Multi.createFrom().converter(MultiRxConverters.fromSingle(), single);
Multi&lt;String&gt; multiFromMaybe = Multi.createFrom().converter(MultiRxConverters.fromMaybe(), maybe);
Multi&lt;String&gt; multiFromEmptyMaybe = Multi.createFrom().converter(MultiRxConverters.fromMaybe(), emptyMaybe);
Multi&lt;String&gt; multiFromObservable = Multi.createFrom().converter(MultiRxConverters.fromObservable(), observable);
Multi&lt;String&gt; multiFromFlowable = Multi.createFrom().converter(MultiRxConverters.fromFlowable(), flowable);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Unis</code> と <code>Multis</code> を RxJava 型に変換することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Completable completable = uni.convert().with(UniRxConverters.toCompletable());
Single&lt;Optional&lt;String&gt;&gt; single = uni.convert().with(UniRxConverters.toSingle());
Single&lt;String&gt; single2 = uni.convert().with(UniRxConverters.toSingle().failOnNull());
Maybe&lt;String&gt; maybe = uni.convert().with(UniRxConverters.toMaybe());
Observable&lt;String&gt; observable = uni.convert().with(UniRxConverters.toObservable());
Flowable&lt;String&gt; flowable = uni.convert().with(UniRxConverters.toFlowable());
// ...
Completable completable = multi.convert().with(MultiRxConverters.toCompletable());
Single&lt;Optional&lt;String&gt;&gt; single = multi.convert().with(MultiRxConverters.toSingle());
Single&lt;String&gt; single2 = multi.convert().with(MultiRxConverters
        .toSingle().onEmptyThrow(() -&gt; new Exception("D'oh!")));
Maybe&lt;String&gt; maybe = multi.convert().with(MultiRxConverters.toMaybe());
Observable&lt;String&gt; observable = multi.convert().with(MultiRxConverters.toObservable());
Flowable&lt;String&gt; flowable = multi.convert().with(MultiRxConverters.toFlowable());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Project Reactorコンバータは、以下の依存関係で利用できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.smallrye.reactive&lt;/groupId&gt;
    &lt;artifactId&gt;mutiny-reactor&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>そこで、Reactorの型を返すAPI( <code>Mono</code> , <code>Flux</code> )を持っている場合は、以下のように <code>Unis</code> と <code>Multis</code> を作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.smallrye.mutiny.converters.multi.MultiReactorConverters;
import io.smallrye.mutiny.converters.uni.UniReactorConverters;
// ...
Uni&lt;String&gt; uniFromMono = Uni.createFrom().converter(UniReactorConverters.fromMono(), mono);
Uni&lt;String&gt; uniFromFlux = Uni.createFrom().converter(UniReactorConverters.fromFlux(), flux);

Multi&lt;String&gt; multiFromMono = Multi.createFrom().converter(MultiReactorConverters.fromMono(), mono);
Multi&lt;String&gt; multiFromFlux = Multi.createFrom().converter(MultiReactorConverters.fromFlux(), flux);</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、 <code>Unis</code> と <code>Multis</code> を Reactor タイプに変換することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Mono&lt;String&gt; mono = uni.convert().with(UniReactorConverters.toMono());
Flux&lt;String&gt; flux = uni.convert().with(UniReactorConverters.toFlux());

Mono&lt;String&gt; mono2 = multi.convert().with(MultiReactorConverters.toMono());
Flux&lt;String&gt; flux2 = multi.convert().with(MultiReactorConverters.toFlux());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-completionstages-or-publisher-api"><a class="anchor" href="#using-completionstages-or-publisher-api"></a>Using CompletionStages or Publisher API</h3>
<div class="paragraph">
<p><code>CompletionStage</code> , <code>CompletableFuture</code> , <code>Publisher</code> を使った API に対面している場合、双方向に変換することができます。まず、 <code>Uni</code> も <code>Multi</code> も <code>CompletionStage</code> から作成することも、 <code>Supplier&lt;CompletionStage&gt;</code> から作成することもできます。例えば、以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CompletableFuture&lt;String&gt; future = Uni
        // Create from a Completion Stage
        .createFrom().completionStage(CompletableFuture.supplyAsync(() -&gt; "hello"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Uni</code> 上で、あなたはまた、 <code>subscribeAsCompletionStage()</code> を使用して <code>CompletionStage</code> を生成することができます。 <code>Uni</code> によって放出されたアイテムまたは障害を取得するだろう <code>CompletionStage</code> を生成します。</p>
</div>
<div class="paragraph">
<p><code>createFrom().publisher(Publisher)</code> を使って <code>Unis</code> と <code>Multis</code> を <code>Publisher</code> のインスタンスから作成することもできます。 <code>Uni</code> を <code>toMulti</code> を使って <code>Publisher</code> に変換することもできます。実際、 <code>Multi</code> は <code>Publisher</code> を実装しています。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="次のステップ"><a class="anchor" href="#次のステップ"></a>次のステップ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドでは、Quarkusでのリアクティブについて紹介します。Quarkusの機能の中には、すでにリアクティブになっているものがたくさんあります。以下のリストでは、いくつかの例を紹介します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="rest-json#reactive">Using Mutiny with RestEasy</a></p>
</li>
<li>
<p><a href="mailer">メール送信</a></p>
</li>
<li>
<p><a href="mongodb#reactive">MongoDB</a> と <a href="mongodb-panache#reactive">MongoDBをPanacheで</a> <a href="mongodb#reactive">使う</a></p>
</li>
<li>
<p><a href="reactive-sql-clients">Reactive Database Clients</a></p>
</li>
<li>
<p><a href="vertx">Using Vert.x</a></p>
</li>
<li>
<p><a href="kafka">Interacting with Kafka</a> and <a href="amqp">Interacting with AMQP</a></p>
</li>
<li>
<p><a href="neo4j#reactive">Using Neo4J</a></p>
</li>
<li>
<p><a href="reactive-routes">リアクティブルートの使用</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">Japanese</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
