<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - ネイティブリファレンスガイド</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/guides/native-reference" />
  <meta property="og:title" content="ネイティブリファレンスガイド" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/native-reference">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >ENGLISH</a></li>
          <li><a href="https://ja.quarkus.io/">JAPANESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/guides/"> Back to Guides</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">Select Guide Version</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" selected>2.9 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
      
        
        
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">ネイティブリファレンスガイド </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#要件と前提条件">要件と前提条件</a></li>
<li><a href="#プロジェクトのブートストラップ">プロジェクトのブートストラップ</a></li>
<li><a href="#configure-quarkus-properties">Configure Quarkus properties</a></li>
<li><a href="#デバッグの最初のステップ">デバッグの最初のステップ</a></li>
<li><a href="#inspecting-native-executables">Inspecting Native Executables</a></li>
<li><a href="#ネイティブレポート">ネイティブレポート</a>
<ul class="sectlevel2">
<li><a href="#コールツリーレポート">コールツリーレポート</a></li>
<li><a href="#使用されているパッケージクラスメソッドのレポート">使用されているパッケージ/クラス/メソッドのレポート</a></li>
<li><a href="#更なるレポート">更なるレポート</a></li>
</ul>
</li>
<li><a href="#ビルド時と実行時の初期化">ビルド時と実行時の初期化</a></li>
<li><a href="#実行時動作のプロファイリング">実行時動作のプロファイリング</a>
<ul class="sectlevel2">
<li><a href="#シングルスレッド">シングルスレッド</a></li>
<li><a href="#マルチスレッド">マルチスレッド</a></li>
</ul>
</li>
<li><a href="#ネイティブクラッシュのデバッグ">ネイティブ・クラッシュのデバッグ</a></li>
<li><a href="#よくある質問">よくある質問</a>
<ul class="sectlevel2">
<li><a href="#ネイティブ実行可能ファイルを生成するプロセスが遅いのはなぜですか">ネイティブ実行可能ファイルを生成するプロセスが遅いのはなぜですか？</a></li>
<li><a href="#jvmモードと比較してネイティブ実行可能ファイルの実行時パフォーマンスが劣るのはなぜですか">JVMモードと比較して、ネイティブ実行可能ファイルの実行時パフォーマンスが劣るのはなぜですか？</a></li>
<li><a href="#なぜネイティブ実行可能ファイルは大きいのですか">なぜネイティブ実行可能ファイルは大きいのですか？</a></li>
<li><a href="#バイナリの生成に使用したmandrelのバージョンは">バイナリの生成に使用したMandrelのバージョンは？</a></li>
<li><a href="#ネイティブ実行可能ファイルでgcロギングを有効にするにはどうすればいいですか">ネイティブ実行可能ファイルでGCロギングを有効にするにはどうすればいいですか？</a></li>
<li><a href="#ネイティブ実行可能ファイルのヒープダンプを取得することはできますか-例えばメモリ不足になった場合などです">ネイティブ実行可能ファイルのヒープダンプを取得することはできますか？ 例えば、メモリ不足になった場合などです。</a></li>
<li><a href="#このサンプルをコンテナの外でlinuxでビルドして実行することは可能ですか">このサンプルをコンテナの外でLinuxでビルドして実行することは可能ですか？</a></li>
<li><a href="#フレームグラフの生成に時間がかかったりエラーが発生したりするのですがどうすればいいですか">フレームグラフの生成に時間がかかったり、エラーが発生したりするのですが、どうすればいいですか？</a></li>
<li><a href="#native-imageのバグを見つけたようなのですがideでどのようにデバッグすればいいのでしょうか">native-imageのバグを見つけたようなのですが、IDEでどのようにデバッグすればいいのでしょうか？</a></li>
<li><a href="#jfrjmcを使ってネイティブバイナリのデバッグやプロファイリングはできますか">JFR/JMCを使って、ネイティブバイナリのデバッグやプロファイリングはできますか？</a></li>
</ul>
</li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>このガイドは、 <a href="building-native-image">ネイティブ実行可能ファイルのビルド</a>、 <a href="native-and-ssl">ネイティブイメージでのSSLの使用</a>、 <a href="writing-native-applications-tips">ネイティブアプリケーションの作成</a>の各ガイドに付随するものです。このガイドでは、開発時や本番時に発生する可能性のあるQuarkusのネイティブ実行可能ファイルの問題をデバッグするための詳細を説明しています。</p>
</div>
<div class="paragraph">
<p>This reference guide takes as input the application developed in the <a href="getting-started">Getting Started Guide</a>. You can find instructions on how to quickly set up this application in this guide.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="要件と前提条件"><a class="anchor" href="#要件と前提条件"></a>要件と前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドには、次の要件があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 11 がインストールされ、 <code>JAVA_HOME</code> が適切に設定されていること</p>
</li>
<li>
<p>Apache Maven 3.8.1+</p>
</li>
<li>
<p>動作するコンテナーランタイム(Docker, podman)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guide builds and executes Quarkus native executables within a Linux environment. To offer a homogeneous experience across all environments, the guide relies on a container runtime environment to build and run the native executables. The instructions below use Docker as example, but very similar commands should work on alternative container runtimes, e.g. podman.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Building native executables is an expensive process, so make sure the container runtime has enough CPU and memory to do this. A minimum of 4 CPUs and 4GB of memory is required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, this guide assumes the use of the <a href="https://github.com/graalvm/mandrel">Mandrel distribution</a> of GraalVM for building native executables, and these are built within a container so there is no need for installing Mandrel on the host.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="プロジェクトのブートストラップ"><a class="anchor" href="#プロジェクトのブートストラップ"></a>プロジェクトのブートストラップ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start by creating a new Quarkus project. Open a terminal and run the following command:</p>
</div>
<div class="paragraph">
<p>For Linux &amp; MacOS users</p>
</div>
<div class="sidebarblock primary asciidoc-tabs-sync-cli">
<div class="content">
<div class="title">CLI</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus create app org.acme:debugging-native \
    --extension=resteasy-reactive,container-image-docker
cd debugging-native</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>--gradle</code> or <code>--gradle-kotlin-dsl</code> option.</p>
</div>
<div class="paragraph">
<p><em>For more information about how to install the Quarkus CLI and use it, please refer to <a href="cli-tooling">the Quarkus CLI guide</a>.</em></p>
</div>
</div>
</div>
<div class="sidebarblock secondary asciidoc-tabs-sync-maven">
<div class="content">
<div class="title">Maven</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus.platform:quarkus-maven-plugin:2.9.0.Final:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=debugging-native \
    -Dextensions="resteasy-reactive,container-image-docker"
cd debugging-native</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a Gradle project, add the <code>-DbuildTool=gradle</code> or <code>-DbuildTool=gradle-kotlin-dsl</code> option.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>For Windows users</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cmd を使っている場合 (バックスラッシュは使わず、全て同じ行にしてください)</p>
</li>
<li>
<p>If using Powershell , wrap <code>-D</code> parameters in double quotes e.g. <code>"-DprojectArtifactId=debugging-native"</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-quarkus-properties"><a class="anchor" href="#configure-quarkus-properties"></a>Configure Quarkus properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some Quarkus configuration options will be used constantly throughout this guide, so to help declutter command line invocations, it&#8217;s recommended to add these options to the <code>application.properties</code> file. So, go ahead and add the following options to that file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.container-build=true
quarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel:22.0-java11
quarkus.container-image.build=true
quarkus.container-image.group=test</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="デバッグの最初のステップ"><a class="anchor" href="#デバッグの最初のステップ"></a>デバッグの最初のステップ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a first step, change to the project directory and build the native executable for the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>アプリケーションを実行して、期待通りに動作することを確認します。一つのターミナルで以下を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT</code></pre>
</div>
</div>
<div class="paragraph">
<p>別のターミナルで以下を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -w '\n' http://localhost:8080/hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of this section explores ways to build the native executable with extra information, but first, stop the running application. We can obtain this information while building the native executable by adding additional native-image build options using <code>-Dquarkus.native.additional-build-args</code>, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.additional-build-args=--native-image-info</code></pre>
</div>
</div>
<div class="paragraph">
<p>これを実行すると、次のような追加の出力行が得られます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">...
# Printing compilation-target information to: /project/reports/target_info_20220223_100915.txt
…
# Printing native-library information to: /project/reports/native_library_info_20220223_100925.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>ターゲット情報ファイルには、ターゲットプラットフォーム、実行ファイルのコンパイルに使用されたツールチェーン、使用されているCライブラリなどの情報が含まれています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cat target/*/reports/target_info_*.txt
Building image for target platform: org.graalvm.nativeimage.Platform$LINUX_AMD64
Using native toolchain:
   Name: GNU project C and C++ compiler (gcc)
   Vendor: redhat
   Version: 8.5.0
   Target architecture: x86_64
   Path: /usr/bin/gcc
Using CLibrary: com.oracle.svm.core.posix.linux.libc.GLib</code></pre>
</div>
</div>
<div class="paragraph">
<p>ネイティブライブラリ情報ファイルには、バイナリに追加されるスタティックライブラリと、実行ファイルに動的にリンクされるその他のライブラリの情報が含まれています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ cat target/*/reports/native_library_info_*.txt
Static libraries:
   ../opt/mandrel/lib/svm/clibraries/linux-amd64/liblibchelper.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libnet.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libextnet.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libnio.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libjava.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libfdlibm.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libsunec.a
   ../opt/mandrel/lib/static/linux-amd64/glibc/libzip.a
   ../opt/mandrel/lib/svm/clibraries/linux-amd64/libjvm.a
Other libraries: stdc++,pthread,dl,z,rt</code></pre>
</div>
</div>
<div class="paragraph">
<p>ネイティブイメージビルドの追加引数として <code>--verbose</code> を渡すことで、さらに詳細な情報を得ることができます。このオプションは、Quarkusを介して高いレベルで渡されたオプションがネイティブ実行可能ファイルの生成に渡されているのか、あるいはサードパーティのjarにネイティブイメージの設定が埋め込まれていて、それがネイティブイメージの呼び出しに届いているのかを検出するのに非常に役立ちます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.additional-build-args=--verbose</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--verbose</code> で実行すると、ネイティブイメージのビルドプロセスが2つの連続したJavaプロセスであることが分かります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1番目は非常に短いJavaプロセスで、基本的な検証を行い、2つ目のプロセスのための引数を組み立てます（GraalVMの純正ディストリビューションでは、これはネイティブコードとして実行されます）。</p>
</li>
<li>
<p>2番目のJavaプロセスでは、ネイティブ実行可能ファイル作成の主要部分が行われます。 <code>--verbose</code> オプションは、実際に実行されたJavaプロセスを表示します。出力を受けて、自分で実行することもできます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>また、複数のネイティブ・ビルド・オプションをコンマで区切って組み合わせることもできます。例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.additional-build-args=--native-image-info,--verbose</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>-Dquarkus.native.additional-build-args</code> の引数に <code>,</code> シンボルが含まれている場合、正しく処理するためには、 <code>\\,</code> のようにエスケープする必要があることを覚えておいてください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inspecting-native-executables"><a class="anchor" href="#inspecting-native-executables"></a>Inspecting Native Executables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Given a native executable, various Linux tools can be used to inspect it. To allow supporting a variety of environments, inspections will be done from within a Linux container. Let&#8217;s create a Linux container image with all the tools required for this guide:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-dockerfile hljs" data-lang="dockerfile">FROM fedora:35

RUN dnf install -y \
binutils \
gdb \
git \
perf \
perl-open

ENV FG_HOME /opt/FlameGraph

RUN git clone https://github.com/brendangregg/FlameGraph $FG_HOME

WORKDIR /data

ENTRYPOINT /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using docker in the non-Linux environment, you can create an image using this Dockerfile via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker build -t fedora-tools:v1 .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, go to the root of the project and run the Docker container we have just created as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run -t -i --rm -v ${PWD}:/data -p 8080:8080 fedora-tools:v1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ldd</code> は、実行可能ファイルの共有ライブラリの依存関係を表示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ldd ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>strings</code> は、バイナリ内のテキストメッセージを探すのに使用できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">strings ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep Hello</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>strings</code> を使えば、指定されたバイナリのMandrel情報を得ることもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">strings ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep core.VM</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に、 <code>readelf</code> を使って、バイナリのさまざまなセクションを調べることができます。例えば、ヒープセクションとテキストセクションがバイナリの大半を占めていることがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">readelf -SW ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ネイティブレポート"><a class="anchor" href="#ネイティブレポート"></a>ネイティブレポート</h2>
<div class="sectionbody">
<div class="paragraph">
<p>オプションとして、ネイティブビルドプロセスでは、バイナリに何が入っているかを示すレポートを生成することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.enable-reports</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reports will be created under <code>target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/reports/</code>. These reports are some of the most useful resources when encountering issues with missing methods/classes, or encountering forbidden methods by Mandrel.</p>
</div>
<div class="sect2">
<h3 id="コールツリーレポート"><a class="anchor" href="#コールツリーレポート"></a>コールツリーレポート</h3>
<div class="paragraph">
<p><code>call_tree</code> テキストファイルレポートは、 <code>-Dquarkus.native.enable-reports</code> オプションが渡されたときに生成されるデフォルトのレポートの1つです。これは、あるメソッド/クラスがなぜバイナリに含まれているのかについて、おおよその見当をつけるのに便利です。しかし、テキスト形式のため非常に読みづらく、多くのスペースを必要とします。</p>
</div>
<div class="paragraph">
<p>Since Mandrel 21.3.0.0, the call tree is also reported as a group of CSV files. The CSV output can be enabled by adding <code>-H:PrintAnalysisCallTreeType=CSV</code> to the additional native arguments. E.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.enable-reports \
    -Dquarkus.native.additional-build-args=-H:PrintAnalysisCallTreeType=CSV</code></pre>
</div>
</div>
<div class="paragraph">
<p>These can in turn be imported into a graph database, such as Neo4j, to inspect them more easily and run queries against the call tree. Let’s see this in action.</p>
</div>
<div class="paragraph">
<p>まず、Neo4jのインスタンスを起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export NEO_PASS=...
docker run \
    --detach \
    --rm \
    --name testneo4j \
    -p7474:7474 -p7687:7687 \
    --env NEO4J_AUTH=neo4j/${NEO_PASS} \
    neo4j:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the container is running, you can access the <a href="http://localhost:7474">Neo4j browser</a>. Use <code>neo4j</code> as the username and the value of <code>NEO_PASS</code> as the password to log in.</p>
</div>
<div class="paragraph">
<p>CSVファイルをインポートするためには、CSVファイル内のデータをインポートし、グラフデータベースのノードとエッジを作成する以下のcypherスクリプトが必要です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">CREATE CONSTRAINT unique_vm_id ON (v:VM) ASSERT v.vmId IS UNIQUE;
CREATE CONSTRAINT unique_method_id ON (m:Method) ASSERT m.methodId IS UNIQUE;

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_vm.csv' AS row
MERGE (v:VM {vmId: row.Id, name: row.Name})
RETURN count(v);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_methods.csv' AS row
MERGE (m:Method {methodId: row.Id, name: row.Name, type: row.Type, parameters: row.Parameters, return: row.Return, display: row.Display})
RETURN count(m);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_virtual_methods.csv' AS row
MERGE (m:Method {methodId: row.Id, name: row.Name, type: row.Type, parameters: row.Parameters, return: row.Return, display: row.Display})
RETURN count(m);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_entry_points.csv' AS row
MATCH (m:Method {methodId: row.Id})
MATCH (v:VM {vmId: '0'})
MERGE (v)-[:ENTRY]-&gt;(m)
RETURN count(*);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_direct_edges.csv' AS row
MATCH (m1:Method {methodId: row.StartId})
MATCH (m2:Method {methodId: row.EndId})
MERGE (m1)-[:DIRECT {bci: row.BytecodeIndexes}]-&gt;(m2)
RETURN count(*);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_override_by_edges.csv' AS row
MATCH (m1:Method {methodId: row.StartId})
MATCH (m2:Method {methodId: row.EndId})
MERGE (m1)-[:OVERRIDEN_BY]-&gt;(m2)
RETURN count(*);

LOAD CSV WITH HEADERS FROM 'file:///reports/call_tree_virtual_edges.csv' AS row
MATCH (m1:Method {methodId: row.StartId})
MATCH (m2:Method {methodId: row.EndId})
MERGE (m1)-[:VIRTUAL {bci: row.BytecodeIndexes}]-&gt;(m2)
RETURN count(*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>スクリプトの内容を <code>import.cypher</code> というファイルにコピー＆ペーストします。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Mandrel 22.0.0 contains a bug where the symbolic links used by the import cypher file are not correctly set when generating reports within a container (for more details see <a href="https://github.com/oracle/graal/issues/4355">here</a>). This can be worked around by copying the following script into a file and executing it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">set -e

project="debugging-native"

pushd target/*-native-image-source-jar/reports

rm -f call_tree_vm.csv
ln -s call_tree_vm_${project}-* call_tree_vm.csv

rm -f call_tree_direct_edges.csv
ln -s call_tree_direct_edges_${project}-* call_tree_direct_edges.csv

rm -f call_tree_entry_points.csv
ln -s call_tree_entry_points_${project}-* call_tree_entry_points.csv

rm -f call_tree_methods.csv
ln -s call_tree_methods_${project}-* call_tree_methods.csv

rm -f call_tree_virtual_edges.csv
ln -s call_tree_virtual_edges_${project}-* call_tree_virtual_edges.csv

rm -f call_tree_virtual_methods.csv
ln -s call_tree_virtual_methods_${project}-* call_tree_virtual_methods.csv

rm -f call_tree_override_by_edges.csv
ln -s call_tree_override_by_edges_${project}-* call_tree_override_by_edges.csv

popd</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に、インポートサイファースクリプトとCSVファイルをNeo4jのインポートフォルダにコピーします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker cp \
    target/*-native-image-source-jar/reports \
    testneo4j:/var/lib/neo4j/import

docker cp import.cypher testneo4j:/var/lib/neo4j</code></pre>
</div>
</div>
<div class="paragraph">
<p>すべてのファイルをコピーしたら、インポートスクリプトを起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker exec testneo4j bin/cypher-shell -u neo4j -p ${NEO_PASS} -f import.cypher</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the import completes (shouldn&#8217;t take more than a couple of minutes), go to the <a href="http://localhost:7474">Neo4j browser</a>, and you&#8217;ll be able to observe a small summary of the data in the graph:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/native-reference-neo4j-db-info.png" alt="Neo4j database information after import">
</div>
</div>
<div class="paragraph">
<p>上のデータでは、<sub>60000のメソッドがあり、それらの間には</sub>200000のエッジがあることがわかります。ここでデモされているQuarkusアプリケーションは非常に基本的なものなので、調べられることは多くありませんが、グラフをより詳細に調べるために実行できるクエリの例をいくつか紹介します。典型的な例としては、あるメソッドを探すことから始めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">match (m:Method) where m.name = "hello" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>そこから、特定の型の特定のメソッドに絞ることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">match (m:Method) where m.name = "hello" and m.type =~ ".*GreetingResource" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>探している特定のメソッドのノードを見つけたら、答えを得たい典型的な質問は、「なぜこのメソッドはコールツリーに含まれるのか」です。そのためには、終点のメソッドから始まる所定の深さの到着接続を探します。たとえば、あるメソッドを直接呼び出すメソッドは、以下のようにして見つけることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">match (m:Method) &lt;- [*1..1] - (o) where m.name = "hello" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>そうすれば、深さ2の直接呼び出しを探すことができます。つまり、対象のメソッドを呼び出すメソッドを呼び出すメソッドを探すことになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cypher hljs" data-lang="cypher">match (m:Method) &lt;- [*1..2] - (o) where m.name = "hello" return *</code></pre>
</div>
</div>
<div class="paragraph">
<p>階層を上がっていくことはできますが、残念ながらノードの数が多すぎる深度に到達すると、Neo4jブラウザはそれらすべてを可視化することができません。そのような場合は、代わりにcypher shellに対して直接クエリを実行することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker exec testneo4j bin/cypher-shell -u neo4j -p ${NEO_PASS} \
  "match (m:Method) &lt;- [*1..10] - (o) where m.name = 'hello' return *"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For further information, check out this <a href="https://quarkus.io/blog/quarkus-native-neo4j-call-tree">blog post</a> that explores the Quarkus Hibernate ORM quickstart using the techniques explained above.</p>
</div>
</div>
<div class="sect2">
<h3 id="使用されているパッケージクラスメソッドのレポート"><a class="anchor" href="#使用されているパッケージクラスメソッドのレポート"></a>使用されているパッケージ/クラス/メソッドのレポート</h3>
<div class="paragraph">
<p><code>used_packages</code>, <code>used_classes</code>, <code>used_methods</code> テキストファイルレポートは、アプリケーションの異なるバージョンを比較する際に便利です。例えば、イメージ作成に時間がかかるのはなぜか？また、なぜイメージが大きくなったのか？</p>
</div>
</div>
<div class="sect2">
<h3 id="更なるレポート"><a class="anchor" href="#更なるレポート"></a>更なるレポート</h3>
<div class="paragraph">
<p>Mandrelは、 <code>-Dquarkus.native.enable-reports</code> オプションで有効になっているレポート以外にも、様々なレポートを作成することができます。これらはエキスパートオプションと呼ばれ、以下を実行することで詳細を知ることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run quay.io/quarkus/ubi-quarkus-mandrel:22.0-java11 --expert-options-all</code></pre>
</div>
</div>
<div class="paragraph">
<p>これらのエキスパートオプションを使用するには、 <code>-Dquarkus.native.additional-build-args</code> パラメータにコンマで区切って追加します。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ビルド時と実行時の初期化"><a class="anchor" href="#ビルド時と実行時の初期化"></a>ビルド時と実行時の初期化</h2>
<div class="sectionbody">
<div class="paragraph">
<p>QuarkusはMandrelに対し、ビルド時に可能な限り初期化するよう指示し、実行時の起動を可能な限り高速化しています。これは、起動速度がアプリケーションの動作準備の早さに大きな影響を与えるコンテナ環境では重要です。また、ビルド時の初期化は、サポートされていない機能が実行時の初期化によって到達可能になることによる実行時の失敗のリスクを最小限にし、Quarkusの信頼性を高めています。</p>
</div>
<div class="paragraph">
<p>ビルド時に初期化されるコードの最も一般的な例は、静的変数とブロックです。Mandrelはこれらをデフォルトでは実行時に実行しますが、Quarkusでは先程の理由でビルド時に実行するように指示しています。</p>
</div>
<div class="paragraph">
<p>つまり、インラインで初期化されたスタティック変数や、スタティックブロックで初期化されたスタティック変数は、アプリケーションを再起動しても同じ値を維持します。これは、Javaとして実行した場合とは異なる動作です。</p>
</div>
<div class="paragraph">
<p>To see this in action with a very basic example, add a new <code>TimestampResource</code> to the application that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

@Path("/timestamp")
public class TimestampResource {

    static long firstAccess = System.currentTimeMillis();

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String timestamp() {
        return "First access " + firstAccess;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>次のようにバイナリを再ビルドします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the application in one terminal (make sure you stop any other native executable container runs before executing this):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT</code></pre>
</div>
</div>
<div class="paragraph">
<p>別のターミナルから <code>GET</code> リクエストを複数回送信してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -w '\n' http://localhost:8080/timestamp # run this multiple times</code></pre>
</div>
</div>
<div class="paragraph">
<p>現在の時刻がどのようにバイナリに焼き付けられているかを確認できます。この時刻は、バイナリのビルド時に計算されたものなので、アプリケーションの再起動が影響しません。</p>
</div>
<div class="paragraph">
<p>In some situations, built time initializations can lead to errors when building native executables. One example is when a value gets computed at build time which is forbidden to reside in the heap of the JVM that gets baked into the binary. To see this in action, add this REST resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import javax.crypto.Cipher;
import javax.crypto.NoSuchPaddingException;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import java.nio.charset.StandardCharsets;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.NoSuchAlgorithmException;

@Path("/encrypt-decrypt")
public class EncryptDecryptResource {

    static final KeyPairGenerator KEY_PAIR_GEN;
    static final Cipher CIPHER;

    static {
        try {
            KEY_PAIR_GEN = KeyPairGenerator.getInstance("RSA");
            KEY_PAIR_GEN.initialize(1024);

            CIPHER = Cipher.getInstance("RSA");
        } catch (NoSuchAlgorithmException | NoSuchPaddingException e) {
            throw new RuntimeException(e);
        }
    }

    @GET
    @Path("/{message}")
    public String encryptDecrypt(String message) throws Exception {
        KeyPair keyPair = KEY_PAIR_GEN.generateKeyPair();

        byte[] text = message.getBytes(StandardCharsets.UTF_8);

        // Encrypt with private key
        CIPHER.init(Cipher.ENCRYPT_MODE, keyPair.getPrivate());
        byte[] encrypted = CIPHER.doFinal(text);

        // Decrypt with public key
        CIPHER.init(Cipher.DECRYPT_MODE, keyPair.getPublic());
        byte[] unencrypted = CIPHER.doFinal(encrypted);

        return new String(unencrypted, StandardCharsets.UTF_8);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>アプリケーションを再ビルドしようとすると、エラーが発生します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative
...
Error: Unsupported features in 2 methods
Detailed message:
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  To see how this object got instantiated use --trace-object-instantiation=java.security.SecureRandom. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field java.security.KeyPairGenerator$Delegate.initRandom of
		constant java.security.KeyPairGenerator$Delegate@58b0fe1b reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  To see how this object got instantiated use --trace-object-instantiation=java.security.SecureRandom. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field sun.security.rsa.RSAKeyPairGenerator.random of
		constant sun.security.rsa.RSAKeyPairGenerator$Legacy@3248a092 reached by
	reading field java.security.KeyPairGenerator$Delegate.spi of
		constant java.security.KeyPairGenerator$Delegate@58b0fe1b reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, what the message above is telling us is that our application caches a value that is supposed to be random as a constant. This is not desirable because something that&#8217;s supposed to be random is no longer so, because the seed is baked in the image. The message above makes it quite clear what is causing this, but in other situations the cause might be more obfuscated. As a next step, we&#8217;ll add some extra flags to the native executable generation to get more information.</p>
</div>
<div class="paragraph">
<p>As suggested by the message, let&#8217;s start by adding an option to track object instantiation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.additional-build-args="--trace-object-instantiation=java.security.SecureRandom"
...
Error: Unsupported features in 2 methods
Detailed message:
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  Object has been initialized by the com.sun.jndi.dns.DnsClient class initializer with a trace:
 	at java.security.SecureRandom.&lt;init&gt;(SecureRandom.java:218)
	at sun.security.jca.JCAUtil$CachedSecureRandomHolder.&lt;clinit&gt;(JCAUtil.java:59)
	at sun.security.jca.JCAUtil.getSecureRandom(JCAUtil.java:69)
	at com.sun.jndi.dns.DnsClient.&lt;clinit&gt;(DnsClient.java:82)
. Try avoiding to initialize the class that caused initialization of the object. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field java.security.KeyPairGenerator$Delegate.initRandom of
		constant java.security.KeyPairGenerator$Delegate@4a5058f9 reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN
Error: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  Object has been initialized by the com.sun.jndi.dns.DnsClient class initializer with a trace:
 	at java.security.SecureRandom.&lt;init&gt;(SecureRandom.java:218)
	at sun.security.jca.JCAUtil$CachedSecureRandomHolder.&lt;clinit&gt;(JCAUtil.java:59)
	at sun.security.jca.JCAUtil.getSecureRandom(JCAUtil.java:69)
	at com.sun.jndi.dns.DnsClient.&lt;clinit&gt;(DnsClient.java:82)
. Try avoiding to initialize the class that caused initialization of the object. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=&lt;class-name&gt;. Or you can write your own initialization methods and call them explicitly from your main entry point.
Trace: Object was reached by
	reading field sun.security.rsa.RSAKeyPairGenerator.random of
		constant sun.security.rsa.RSAKeyPairGenerator$Legacy@71880cf1 reached by
	reading field java.security.KeyPairGenerator$Delegate.spi of
		constant java.security.KeyPairGenerator$Delegate@4a5058f9 reached by
	reading field org.acme.EncryptDecryptResource.KEY_PAIR_GEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>The error messages point to the code in the example, but it can be suprising that a reference to <code>DnsClient</code> appears. Why is that? The key is in what happens inside <code>KeyPairGenerator.initialize()</code> method call. It uses <code>JCAUtil.getSecureRandom()</code> which is why this is problematic, but sometimes the tracing options can show some stack traces that do not represent what happens in reality. The best option is to dig through the source code and use tracing output for guidance but not as full truth.</p>
</div>
<div class="paragraph">
<p><code>KEY_PAIR_GEN.initialize(1024);</code> の呼び出しを、実行時に実行されるメソッド <code>encryptDecrypt</code> に移すことで、この特定の問題を解決できます。</p>
</div>
<div class="paragraph">
<p>どのクラスがどのように初期化されるかについての追加情報は、 <code>-Dquarkus.native.additional-build-args</code> を通じて <code>-H:+PrintClassInitialization</code> フラグを渡すことで得ることができます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="実行時動作のプロファイリング"><a class="anchor" href="#実行時動作のプロファイリング"></a>実行時動作のプロファイリング</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="シングルスレッド"><a class="anchor" href="#シングルスレッド"></a>シングルスレッド</h3>
<div class="paragraph">
<p>この演習では、ネイティブ実行可能ファイルにコンパイルされたQuarkusアプリケーションの実行時動作をプロファイリングし、ボトルネックがどこにあるかを判断します。問題がアプリケーションのネイティブバージョンでのみ発生するために、純粋なJavaバージョンのプロファイリングができないシナリオを想定しています。</p>
</div>
<div class="paragraph">
<p>Add a REST resource with the following code (example courtesy of <a href="https://github.com/apangin/java-profiling-presentation/blob/master/src/demo1/StringBuilderTest.java">Andrei Pangin&#8217;s Java Profiling presentation</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

@Path("/string-builder")
public class StringBuilderResource {

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String appendDelete() {
        StringBuilder sb = new StringBuilder();
        sb.append(new char[1_000_000]);

        do
        {
            sb.append(12345);
            sb.delete(0, 5);
        } while (Thread.currentThread().isAlive());

        return "Never happens";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>アプリケーションを再コンパイルし、バイナリを再ビルドして実行します。単純なcurlを試みても、期待通り完了しません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./mvnw package -DskipTests -Dnative
...
$ docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT
...
$ curl http://localhost:8080/string-builder # this will never complete</code></pre>
</div>
</div>
<div class="paragraph">
<p>しかし、ここで私たちが答えようとしているのは、そのようなコードのボトルネックは何か？文字を追加することか？削除していることか？スレッドが生きているかどうかをチェックしていることか？です。</p>
</div>
<div class="paragraph">
<p>Since we&#8217;re dealing with a linux native executable, we can use tools like <code>perf</code> directly. To use <code>perf</code>, go to the root of the project and start the tools container created earlier as a privileged user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run --privileged -t -i --rm -v ${PWD}:/data -p 8080:8080 fedora-tools:v1</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>なお、 <code>perf</code> を使用してガイドのネイティブ実行可能ファイルをプロファイルするには、コンテナを特権的に実行するか、 <code>--cap-add sys_admin</code> を使用する必要があります。本番環境では特権コンテナは推奨され <strong>ません</strong> ので、このフラグの使用には注意が必要です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>コンテナが稼働したら、カーネルがプロファイリングの演習に対応できるようにしておく必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo -1 | sudo tee /proc/sys/kernel/perf_event_paranoid
echo 0 | sudo tee /proc/sys/kernel/kptr_restrict</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The kernel modifications above also apply to Linux virtual machines. If running on a bare metal Linux machine, tweaking only <code>perf_event_paranoid</code> is enough.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, from inside the tools container we execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf record -F 1009 -g -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>perf record</code> の実行中に、別のウィンドウを開き、エンドポイントにアクセスします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/string-builder # this will never complete</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a few seconds, halt the <code>perf record</code> process. This will generate a <code>perf.data</code> file. We could use <code>perf report</code> to inspect the perf data, but you can often get a better picture showing that data as a flame graph. To generate flame graphs, we will use <a href="https://github.com/brendangregg/FlameGraph">FlameGraph GitHub repository</a>, which has already been installed inside the tools container.</p>
</div>
<div class="paragraph">
<p>Next, generate a flame graph using the data captured via <code>perf record</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ perf script -i perf.data | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
$ ${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="paragraph">
<p>フレームグラフは、FirefoxなどのWebブラウザで簡単に表示できるsvgファイルです。上記の2つのコマンドが完了すると、ブラウザで <code>flamegraph.svg</code> を開くことができます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/native-reference-perf-flamegraph-no-symbols.svg" alt="Perf flamegraph without symbols">
</div>
</div>
<div class="paragraph">
<p>We see a big majority of time spent in what is supposed to be our main, but we see no trace of the <code>StringBuilderResource</code> class, nor the <code>StringBuilder</code> class we&#8217;re calling. We should look at the symbol table of the binary: can we find symbols for our class and <code>StringBuilder</code>? We need those in order to get meaningful data. From within the tools container, query the symbol table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">objdump -t ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep StringBuilder
[no output]</code></pre>
</div>
</div>
<div class="paragraph">
<p>No output appears when querying the symbol table. This is why we don&#8217;t see any call graphs in the flame graphs. This is a deliberate decision that native-image makes. By default, it removes symbols from the binary.</p>
</div>
<div class="paragraph">
<p>To regain the symbols, we need to rebuild the binary instructing GraalVM not to delete the symbols. On top of that, enable DWARF debug info so that the stack traces can be populated with that information. From outside the tools container, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.debug.enabled \
    -Dquarkus.native.additional-build-args=-H:-DeleteLocalSymbols</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, re-enter the tools container if you exited, and inspect the native executable with <code>objdump</code>, and see how the symbols are now present:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ objdump -t ./target/debugging-native-1.0.0-SNAPSHOT-runner | grep StringBuilder
000000000050a940 l     F .text	0000000000000091              .hidden ReflectionAccessorHolder_StringBuilderResource_appendDelete_9e06d4817d0208a0cce97ebcc0952534cac45a19_e22addf7d3eaa3ad14013ce01941dc25beba7621
000000000050a9e0 l     F .text	00000000000000bb              .hidden ReflectionAccessorHolder_StringBuilderResource_constructor_0f8140ea801718b80c05b979a515d8a67b8f3208_12baae06bcd6a1ef9432189004ae4e4e176dd5a4
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a long list of symbols that match that pattern.</p>
</div>
<div class="paragraph">
<p>次に、実行ファイルを perf で実行すると、 <strong>コールグラフが dwarf であることがわかります</strong>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf record -F 1009 --call-graph dwarf -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>もう一度curlコマンドを実行し、バイナリを停止し、フレームグラフを生成して開きます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf script -i perf.data | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="paragraph">
<p>フレームグラフを見ると、どこがボトルネックになっているかがわかります。それは、 <code>StringBuilder.delete()</code> が呼び出され、 <code>System.arraycopy()</code> を呼び出すときです。問題は、100万文字を非常に小さな単位でシフトさせる必要があることです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/native-reference-perf-flamegraph-symbols.svg" alt="Perf flamegraph with symbols">
</div>
</div>
</div>
<div class="sect2">
<h3 id="マルチスレッド"><a class="anchor" href="#マルチスレッド"></a>マルチスレッド</h3>
<div class="paragraph">
<p>Multi-threaded programs might require special attention when trying to understand their runtime behaviour. To demonstrate this, add this <code>MulticastResource</code> code to your project (example courtesy of <a href="https://github.com/apangin/java-profiling-presentation/blob/master/src/demo6/DatagramTest.java">Andrei Pangin&#8217;s Java Profiling presentation</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.DatagramChannel;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.atomic.AtomicInteger;

@Path("/multicast")
public class MulticastResource
{
    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String send() throws Exception {
        sendMulticasts();
        return "Multicast packets sent";
    }

    static void sendMulticasts() throws Exception {
        DatagramChannel ch = DatagramChannel.open();
        ch.bind(new InetSocketAddress(5555));
        ch.configureBlocking(false);

        ExecutorService pool =
            Executors.newCachedThreadPool(new ShortNameThreadFactory());
        for (int i = 0; i &lt; 10; i++) {
            pool.submit(() -&gt; {
                final ByteBuffer buf = ByteBuffer.allocateDirect(1000);
                final InetSocketAddress remoteAddr =
                    new InetSocketAddress("127.0.0.1", 5556);

                while (true) {
                    buf.clear();
                    ch.send(buf, remoteAddr);
                }
            });
        }

        System.out.println("Warming up...");
        Thread.sleep(3000);

        System.out.println("Benchmarking...");
        Thread.sleep(5000);
    }

    private static final class ShortNameThreadFactory implements ThreadFactory {

        private final AtomicInteger threadNumber = new AtomicInteger(1);
        private final String namePrefix = "thread-";

        public Thread newThread(Runnable r) {
            return new Thread(r, namePrefix + threadNumber.getAndIncrement());
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>デバッグ情報付きでネイティブ実行可能ファイルをビルドします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.debug.enabled \
    -Dquarkus.native.additional-build-args=-H:-DeleteLocalSymbols</code></pre>
</div>
</div>
<div class="paragraph">
<p>From inside the tools container (as privileged user) run the native executable through <code>perf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf record -F 1009 --call-graph dwarf -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Invoke the endpoint to send the multicast packets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -w '\n' http://localhost:8080/multicast</code></pre>
</div>
</div>
<div class="paragraph">
<p>フレームグラフを作成して開いてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf script -i perf.data | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/native-reference-multi-flamegraph-separate-threads.svg" alt="Muti-thread perf flamegraph with separate threads">
</div>
</div>
<div class="paragraph">
<p>作成されたフレームグラフは奇妙に見えます。すべてのスレッドが同じ作業をしているにもかかわらず、各スレッドが独立して扱われています。これでは、プログラムのボトルネックを明確に把握することができません。</p>
</div>
<div class="paragraph">
<p>これは、 <code>perf</code> の観点から見ると、各スレッドが異なるコマンドであるために起こっています。 <code>perf report</code> を確認するとわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf report --stdio
# Children      Self  Command          Shared Object       Symbol
# ........  ........  ...............  ......................................  ......................................................................................
...
     6.95%     0.03%  thread-2         debugging-native-1.0.0-SNAPSHOT-runner  [.] MulticastResource_lambda$sendMulticasts$0_cb1f7b5dcaed7dd4e3f90d18bad517d67eae4d88
...
     4.60%     0.02%  thread-10        debugging-native-1.0.0-SNAPSHOT-runner  [.] MulticastResource_lambda$sendMulticasts$0_cb1f7b5dcaed7dd4e3f90d18bad517d67eae4d88
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、すべてのスレッドが同じ名前になるように、perfの出力にいくつかの変更を加えることで回避できます。例えば、以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf script | sed -E "s/thread-[0-9]*/thread/" | ${FG_HOME}/stackcollapse-perf.pl &gt; out.perf-folded
${FG_HOME}/flamegraph.pl out.perf-folded &gt; flamegraph.svg</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/native-reference-multi-flamegraph-joined-threads.svg" alt="Muti-thread perf flamegraph with joined threads">
</div>
</div>
<div class="paragraph">
<p>フレームグラフを開くと、すべてのスレッドの作業が1つの領域に折りたたまれているのがわかります。そして、パフォーマンスに影響を与える可能性のあるロックがあることがはっきりとわかります。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ネイティブクラッシュのデバッグ"><a class="anchor" href="#ネイティブクラッシュのデバッグ"></a>ネイティブ・クラッシュのデバッグ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the drawbacks of using native executables is that they cannot be debugged using the standard Java debuggers, instead we need to debug them using <code>gdb</code>, the GNU Project debugger. To demonstrate how to do this, we are going to generate a native Quarkus application that crashes due to a Segmentation Fault when accessing <a href="http://localhost:8080/crash" class="bare">http://localhost:8080/crash</a>. To achieve this, add the following REST resource to the project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import sun.misc.Unsafe;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import java.lang.reflect.Field;

@Path("/crash")
public class CrashResource {

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        Field theUnsafe = null;
        try {
            theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
            theUnsafe.setAccessible(true);
            Unsafe unsafe = (Unsafe) theUnsafe.get(null);
            unsafe.copyMemory(0, 128, 256);
        } catch (NoSuchFieldException | IllegalAccessException e) {
            e.printStackTrace();
        }
        return "Never happens";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコードは、アドレス <code>0x0</code> から <code>0x80</code> へ 256 バイトをコピーしようとするため、セグメンテーション・フォールトが発生します。これを確認するには、サンプルアプリケーションをコンパイルして実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./mvnw package -DskipTests -Dnative
...
$ docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT
...
$ curl http://localhost:8080/crash</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより、次のような出力が得られます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ docker run -i --rm -p 8080:8080 test/debugging-native:1.0.0-SNAPSHOT
...
Segfault detected, aborting process. Use runtime option -R:-InstallSegfaultHandler if you don't want to use SubstrateSegfaultHandler.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The omitted output above contains clues to what caused the issue, but in this exercise we are going to assume that no information was provided. Let’s try to debug the segmentation fault using <code>gdb</code>. To do that, go to the root of the project and enter the tools container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run -t -i --rm -v ${PWD}:/data -p 8080:8080 fedora-tools:v1 /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then start the application in <code>gdb</code> and execute <code>run</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">gdb ./target/debugging-native-1.0.0-SNAPSHOT-runner
...
Reading symbols from ./target/debugging-native-1.0.0-SNAPSHOT-runner...
(No debugging symbols found in ./target/debugging-ntaive-1.0.0-SNAPSHOT-runner)
(gdb) run
Starting program: /data/target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, try to access <a href="http://localhost:8080/crash" class="bare">http://localhost:8080/crash</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/crash</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより、 <code>gdb</code> に次のようなメッセージが表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Thread 4 "ecutor-thread-0" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fe103dff640 (LWP 190)]
0x0000000000461f6e in ?? ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>このクラッシュの原因となったバックトレースの情報を得ようとすると、十分な情報が得られないことがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) bt
#0  0x0000000000418b5e in ?? ()
#1  0x00007ffff6f2d328 in ?? ()
#2  0x0000000000418a04 in ?? ()
#3  0x00007ffff44062a0 in ?? ()
#4  0x00000000010c3dd3 in ?? ()
#5  0x0000000000000100 in ?? ()
#6  0x0000000000000000 in ?? ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is because we didn’t compile the Quarkus application with <code>-Dquarkus.native.debug.enabled</code>, so <code>gdb</code> cannot find debugging symbols for our native executable, as indicated by the "<em>No debugging symbols found in ./target/debugging-native-1.0.0-SNAPSHOT-runner</em>" message in the beginning of <code>gdb</code>.</p>
</div>
<div class="paragraph">
<p><code>-Dquarkus.native.debug.enabled</code> でQuarkusアプリケーションを再コンパイルし、 <code>gdb</code> で再実行すると、クラッシュの原因を明らかにするバックトレースを得ることができます。さらに、 <code>-H:-OmitInlinedMethodDebugLineInfo</code> オプションを追加すると、インライン化されたメソッドがバックトレースから省略されるのを防ぐことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.debug.enabled \
    -Dquarkus.native.additional-build-args=-H:-OmitInlinedMethodDebugLineInfo
...
$ gdb ./target/debugging-native-1.0.0-SNAPSHOT-runner
Reading symbols from ./target/debugging-native-1.0.0-SNAPSHOT-runner...
(gdb) run
Starting program: /data/target/debugging-native-1.0.0-SNAPSHOT-runner
...
$ curl http://localhost:8080/crash</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより、 <code>gdb</code> に次のようなメッセージが表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Thread 4 "ecutor-thread-0" received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fffeffff640 (LWP 362984)]
com.oracle.svm.core.UnmanagedMemoryUtil::copyLongsBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) ()
	at com/oracle/svm/core/UnmanagedMemoryUtil.java:169
169    com/oracle/svm/core/UnmanagedMemoryUtil.java: No such file or directory.</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>gdb</code> は、どのメソッドがクラッシュの原因となったのか、それがソースコードのどこにあるのかを教えてくれることがすでにわかりました。また、この状態に至ったコールグラフのバックトレースも得ることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) bt
#0  com.oracle.svm.core.UnmanagedMemoryUtil::copyLongsBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:169
#1  0x0000000000461e14 in com.oracle.svm.core.UnmanagedMemoryUtil::copyBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:110
#2  0x0000000000461dc8 in com.oracle.svm.core.UnmanagedMemoryUtil::copy(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:67
#3  0x000000000045d3c0 in com.oracle.svm.core.JavaMemoryUtil::unsafeCopyMemory(java.lang.Object *, long, java.lang.Object *, long, long) () at com/oracle/svm/core/JavaMemoryUtil.java:276
#4  0x00000000013277de in jdk.internal.misc.Unsafe::copyMemory0 () at com/oracle/svm/core/jdk/SunMiscSubstitutions.java:125
#5  jdk.internal.misc.Unsafe::copyMemory(java.lang.Object *, long, java.lang.Object *, long, long) () at jdk/internal/misc/Unsafe.java:788
#6  0x00000000013b1a3f in jdk.internal.misc.Unsafe::copyMemory () at jdk/internal/misc/Unsafe.java:799
#7  sun.misc.Unsafe::copyMemory () at sun/misc/Unsafe.java:585
#8  org.acme.CrashResource::hello(void) () at org/acme/CrashResource.java:22</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, we can get a backtrace of the call graph of other threads.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, we can list the available threads with:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) info threads
  Id   Target Id                                             Frame
  1    Thread 0x7fcc62a07d00 (LWP 322) "debugging-nativ" 0x00007fcc62b8b77a in __futex_abstimed_wait_common () from /lib64/libc.so.6
  2    Thread 0x7fcc60eff640 (LWP 326) "gnal Dispatcher" 0x00007fcc62b8b77a in __futex_abstimed_wait_common () from /lib64/libc.so.6
* 4    Thread 0x7fcc5b7fe640 (LWP 328) "ecutor-thread-0" com.oracle.svm.core.UnmanagedMemoryUtil::copyLongsBackward(org.graalvm.word.Pointer *, org.graalvm.word.Pointer *, org.graalvm.word.UnsignedWord *) () at com/oracle/svm/core/UnmanagedMemoryUtil.java:169
  5    Thread 0x7fcc5abff640 (LWP 329) "-thread-checker" 0x00007fcc62b8b77a in __futex_abstimed_wait_common () from /lib64/libc.so.6
  6    Thread 0x7fcc59dff640 (LWP 330) "ntloop-thread-0" 0x00007fcc62c12c9e in epoll_wait () from /lib64/libc.so.6
...</code></pre>
</div>
</div>
</li>
<li>
<p>select the thread we want to inspect, e.g. thread 1:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) thread 1
[Switching to thread 1 (Thread 0x7ffff7a58d00 (LWP 1028851))]
#0  __futex_abstimed_wait_common64 (private=0, cancel=true, abstime=0x0, op=393, expected=0, futex_word=0x2cd7adc) at futex-internal.c:57
57	    return INTERNAL_SYSCALL_CANCEL (futex_time64, futex_word, op, expected,</code></pre>
</div>
</div>
</li>
<li>
<p>and, finally, print the stack trace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) bt
#0  __futex_abstimed_wait_common64 (private=0, cancel=true, abstime=0x0, op=393, expected=0, futex_word=0x2cd7adc) at futex-internal.c:57
#1  __futex_abstimed_wait_common (futex_word=futex_word@entry=0x2cd7adc, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0, private=private@entry=0,
    cancel=cancel@entry=true) at futex-internal.c:87
#2  0x00007ffff7bdd79f in __GI___futex_abstimed_wait_cancelable64 (futex_word=futex_word@entry=0x2cd7adc, expected=expected@entry=0, clockid=clockid@entry=0, abstime=abstime@entry=0x0,
    private=private@entry=0) at futex-internal.c:139
#3  0x00007ffff7bdfeb0 in __pthread_cond_wait_common (abstime=0x0, clockid=0, mutex=0x2ca07b0, cond=0x2cd7ab0) at pthread_cond_wait.c:504
#4  ___pthread_cond_wait (cond=0x2cd7ab0, mutex=0x2ca07b0) at pthread_cond_wait.c:619
#5  0x00000000004e2014 in com.oracle.svm.core.posix.headers.Pthread::pthread_cond_wait () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:252
#6  com.oracle.svm.core.posix.thread.PosixParkEvent::condWait(void) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:252
#7  0x0000000000547070 in com.oracle.svm.core.thread.JavaThreads::park(void) () at com/oracle/svm/core/thread/JavaThreads.java:764
#8  0x0000000000fc5f44 in jdk.internal.misc.Unsafe::park(boolean, long) () at com/oracle/svm/core/thread/Target_jdk_internal_misc_Unsafe_JavaThreads.java:49
#9  0x0000000000eac1ad in java.util.concurrent.locks.LockSupport::park(java.lang.Object *) () at java/util/concurrent/locks/LockSupport.java:194
#10 0x0000000000ea5d68 in java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject::awaitUninterruptibly(void) ()
    at java/util/concurrent/locks/AbstractQueuedSynchronizer.java:2018
#11 0x00000000008b6b30 in io.quarkus.runtime.ApplicationLifecycleManager::run(io.quarkus.runtime.Application *, java.lang.Class *, java.util.function.BiConsumer *, java.lang.String[] *) ()
    at io/quarkus/runtime/ApplicationLifecycleManager.java:144
#12 0x00000000008bc055 in io.quarkus.runtime.Quarkus::run(java.lang.Class *, java.util.function.BiConsumer *, java.lang.String[] *) () at io/quarkus/runtime/Quarkus.java:67
#13 0x000000000045c88b in io.quarkus.runtime.Quarkus::run () at io/quarkus/runtime/Quarkus.java:41
#14 io.quarkus.runtime.Quarkus::run () at io/quarkus/runtime/Quarkus.java:120
#15 0x000000000045c88b in io.quarkus.runner.GeneratedMain::main ()
#16 com.oracle.svm.core.JavaMainWrapper::runCore () at com/oracle/svm/core/JavaMainWrapper.java:150
#17 com.oracle.svm.core.JavaMainWrapper::run(int, org.graalvm.nativeimage.c.type.CCharPointerPointer *) () at com/oracle/svm/core/JavaMainWrapper.java:186
#18 0x000000000048084d in com.oracle.svm.core.code.IsolateEnterStub::JavaMainWrapper_run_5087f5482cc9a6abc971913ece43acb471d2631b(int, org.graalvm.nativeimage.c.type.CCharPointerPointer *)
    () at com/oracle/svm/core/JavaMainWrapper.java:280</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Alternatively, we can list the backtraces of all threads with a single command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) thread apply all backtrace

Thread 22 (Thread 0x7fffc8dff640 (LWP 1028872) "tloop-thread-15"):
#0  0x00007ffff7c64c2e in epoll_wait (epfd=8, events=0x2ca3880, maxevents=1024, timeout=-1) at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
#1  0x000000000166e01c in Java_sun_nio_ch_EPoll_wait ()
#2  0x00000000011bfece in sun.nio.ch.EPoll::wait(int, long, int, int) () at com/oracle/svm/core/stack/JavaFrameAnchors.java:42
#3  0x00000000011c08d2 in sun.nio.ch.EPollSelectorImpl::doSelect(java.util.function.Consumer *, long) () at sun/nio/ch/EPollSelectorImpl.java:120
#4  0x00000000011d8977 in sun.nio.ch.SelectorImpl::lockAndDoSelect(java.util.function.Consumer *, long) () at sun/nio/ch/SelectorImpl.java:124
#5  0x0000000000705720 in sun.nio.ch.SelectorImpl::select () at sun/nio/ch/SelectorImpl.java:141
#6  io.netty.channel.nio.SelectedSelectionKeySetSelector::select(void) () at io/netty/channel/nio/SelectedSelectionKeySetSelector.java:68
#7  0x0000000000703c2e in io.netty.channel.nio.NioEventLoop::select(long) () at io/netty/channel/nio/NioEventLoop.java:813
#8  0x0000000000701a5f in io.netty.channel.nio.NioEventLoop::run(void) () at io/netty/channel/nio/NioEventLoop.java:460
#9  0x00000000008496df in io.netty.util.concurrent.SingleThreadEventExecutor$4::run(void) () at io/netty/util/concurrent/SingleThreadEventExecutor.java:986
#10 0x0000000000860762 in io.netty.util.internal.ThreadExecutorMap$2::run(void) () at io/netty/util/internal/ThreadExecutorMap.java:74
#11 0x0000000000840da4 in io.netty.util.concurrent.FastThreadLocalRunnable::run(void) () at io/netty/util/concurrent/FastThreadLocalRunnable.java:30
#12 0x0000000000b7dd04 in java.lang.Thread::run(void) () at java/lang/Thread.java:829
#13 0x0000000000547dcc in com.oracle.svm.core.thread.JavaThreads::threadStartRoutine(org.graalvm.nativeimage.ObjectHandle *) () at com/oracle/svm/core/thread/JavaThreads.java:597
#14 0x00000000004e15b1 in com.oracle.svm.core.posix.thread.PosixJavaThreads::pthreadStartRoutine(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:194
#15 0x0000000000480984 in com.oracle.svm.core.code.IsolateEnterStub::PosixJavaThreads_pthreadStartRoutine_e1f4a8c0039f8337338252cd8734f63a79b5e3df(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:182
#16 0x00007ffff7be0b1a in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:443
#17 0x00007ffff7c65650 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81

Thread 21 (Thread 0x7fffc97fa640 (LWP 1028871) "tloop-thread-14"):
#0  0x00007ffff7c64c2e in epoll_wait (epfd=53, events=0x2cd0970, maxevents=1024, timeout=-1) at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
#1  0x000000000166e01c in Java_sun_nio_ch_EPoll_wait ()
#2  0x00000000011bfece in sun.nio.ch.EPoll::wait(int, long, int, int) () at com/oracle/svm/core/stack/JavaFrameAnchors.java:42
#3  0x00000000011c08d2 in sun.nio.ch.EPollSelectorImpl::doSelect(java.util.function.Consumer *, long) () at sun/nio/ch/EPollSelectorImpl.java:120
#4  0x00000000011d8977 in sun.nio.ch.SelectorImpl::lockAndDoSelect(java.util.function.Consumer *, long) () at sun/nio/ch/SelectorImpl.java:124
#5  0x0000000000705720 in sun.nio.ch.SelectorImpl::select () at sun/nio/ch/SelectorImpl.java:141
#6  io.netty.channel.nio.SelectedSelectionKeySetSelector::select(void) () at io/netty/channel/nio/SelectedSelectionKeySetSelector.java:68
#7  0x0000000000703c2e in io.netty.channel.nio.NioEventLoop::select(long) () at io/netty/channel/nio/NioEventLoop.java:813
#8  0x0000000000701a5f in io.netty.channel.nio.NioEventLoop::run(void) () at io/netty/channel/nio/NioEventLoop.java:460
#9  0x00000000008496df in io.netty.util.concurrent.SingleThreadEventExecutor$4::run(void) () at io/netty/util/concurrent/SingleThreadEventExecutor.java:986
#10 0x0000000000860762 in io.netty.util.internal.ThreadExecutorMap$2::run(void) () at io/netty/util/internal/ThreadExecutorMap.java:74
#11 0x0000000000840da4 in io.netty.util.concurrent.FastThreadLocalRunnable::run(void) () at io/netty/util/concurrent/FastThreadLocalRunnable.java:30
#12 0x0000000000b7dd04 in java.lang.Thread::run(void) () at java/lang/Thread.java:829
#13 0x0000000000547dcc in com.oracle.svm.core.thread.JavaThreads::threadStartRoutine(org.graalvm.nativeimage.ObjectHandle *) () at com/oracle/svm/core/thread/JavaThreads.java:597
#14 0x00000000004e15b1 in com.oracle.svm.core.posix.thread.PosixJavaThreads::pthreadStartRoutine(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:194
#15 0x0000000000480984 in com.oracle.svm.core.code.IsolateEnterStub::PosixJavaThreads_pthreadStartRoutine_e1f4a8c0039f8337338252cd8734f63a79b5e3df(com.oracle.svm.core.thread.JavaThreads$ThreadStartData *) () at com/oracle/svm/core/posix/thread/PosixJavaThreads.java:182
#16 0x00007ffff7be0b1a in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:443
#17 0x00007ffff7c65650 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81

Thread 20 (Thread 0x7fffc9ffb640 (LWP 1028870) "tloop-thread-13"):
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, however, that despite being able to get a backtrace we can still not list the source code at point with the <code>list</code> command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) list
164    in com/oracle/svm/core/UnmanagedMemoryUtil.java</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is because <code>gdb</code> is not aware of the location of the source files. We are running the executable outside of the target directory. To fix this we can either rerun <code>gdb</code> from the target directory or, run <code>directory target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/sources</code> e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(gdb) directory target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/sources
Source directories searched: /data/target/debugging-native-1.0.0-SNAPSHOT-native-image-source-jar/sources:$cdir:$cwd
(gdb) list
164        	UnsignedWord offset = size;
165        	while (offset.aboveOrEqual(32)) {
166            	offset = offset.subtract(32);
167            	Pointer src = from.add(offset);
168            	Pointer dst = to.add(offset);
169            	long l24 = src.readLong(24);
170            	long l16 = src.readLong(16);
171            	long l8 = src.readLong(8);
172            	long l0 = src.readLong(0);
173            	dst.writeLong(24, l24);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>169</code> 行を調べて、何が問題なのか最初のヒントを得ることができます（この場合、アドレス <code>0x0000</code> を含む src からの最初の読み取りに失敗していることがわかります）。また、 <code>gdb</code> の <code>up</code> コマンドを使ってスタックをさかのぼり、コードのどの部分がこのような状況を引き起こしたかを確認することができます。ネイティブ実行可能ファイルをデバッグするためのgdbの使い方については、 <a href="https://github.com/oracle/graal/blob/master/docs/reference-manual/native-image/DebugInfo.md">こちら</a>をご覧ください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="よくある質問"><a class="anchor" href="#よくある質問"></a>よくある質問</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="ネイティブ実行可能ファイルを生成するプロセスが遅いのはなぜですか"><a class="anchor" href="#ネイティブ実行可能ファイルを生成するプロセスが遅いのはなぜですか"></a>ネイティブ実行可能ファイルを生成するプロセスが遅いのはなぜですか？</h3>
<div class="paragraph">
<p>ネイティブ実行可能ファイルの生成は、複数のステップで構成されています。その中でも解析とコンパイルのステップは最もコストがかかるため、ネイティブ実行可能ファイルの生成にかかる時間の大半を占めます。</p>
</div>
<div class="paragraph">
<p>解析フェーズでは、プログラムのメインメソッドから静的なPoint-to 解析を開始し、到達可能なものを見つけ出します。新しいクラスが発見されると、設定に応じてこのプロセス中にその一部が初期化されます。次のステップでは、ヒープがスナップショットされ、どのタイプが実行時に利用可能である必要があるかのチェックが行われます。初期化とヒープのスナップショットにより、新しい型が発見されることがありますが、その場合はこのプロセスが繰り返されます。このプロセスは、到達可能なプログラムがこれ以上成長しないという固定点に達したときに停止します。</p>
</div>
<div class="paragraph">
<p>コンパイルのステップは非常に簡単で、到達可能なすべてのコードを単純にコンパイルします。</p>
</div>
<div class="paragraph">
<p>解析とコンパイルの段階でかかる時間は、アプリケーションの大きさによって異なります。アプリケーションが大きければ大きいほど、コンパイルにかかる時間は長くなります。ただし、指数関数的な効果をもたらす機能もあります。例えば、リフレクションアクセスのために型やメソッドを登録する場合、解析はその型やメソッドの背後にあるものを簡単に見ることができないため、解析ステップを完了するためにはより多くの仕事をしなければなりません。</p>
</div>
</div>
<div class="sect2">
<h3 id="jvmモードと比較してネイティブ実行可能ファイルの実行時パフォーマンスが劣るのはなぜですか"><a class="anchor" href="#jvmモードと比較してネイティブ実行可能ファイルの実行時パフォーマンスが劣るのはなぜですか"></a>JVMモードと比較して、ネイティブ実行可能ファイルの実行時パフォーマンスが劣るのはなぜですか？</h3>
<div class="paragraph">
<p>多くの場合、JVMモードではなくネイティブコンパイルを選択すると、いくつかのトレードオフが発生します。そのため、アプリケーションによっては、ネイティブアプリケーションの実行時パフォーマンスがJVMモードに比べて遅くなることがありますが、絶対にそうであるとは限りません。</p>
</div>
<div class="paragraph">
<p>JVMによるアプリケーションの実行には、実行中に蓄積されるプロファイル情報を利用したコードの実行時最適化が含まれます。これには、より多くのコードをインライン化したり、ホットコードをダイレクトパスに配置したり（つまり、より良い命令キャッシュのローカリティを確保する）、コールドパスにある多くのコードをカットしたりする機会が含まれます（JVMでは、多くのコードが何かが実行しようとするまでコンパイルされず、最適化解除や再コンパイルを引き起こすトラップに置き換えられます）。コールドパスを取り除くことで、コンパイルされる少量のホットコードの分岐の複雑さや組み合わせロジックが大幅に削減されるため、先行してコンパイルする場合よりも多くの最適化の機会が得られます。</p>
</div>
<div class="paragraph">
<p>一方、ネイティブ実行可能ファイルのコンパイルでは、オフラインでコードをコンパイルする際に、すべての可能な実行経路に対応しなければなりません。なぜならば、ホットパスやコールドパスがわからないため、罠を仕掛けて、それに当たったら再コンパイルするというようなトリックが使えないからです。同じ理由で、ホットパスを隣接して配置することでコードキャッシュの衝突を最小限に抑えるようなサイコロを積むこともできません。ネイティブ実行可能ファイルの生成は、閉じた世界の仮説により、いくつかのコードを削除することができますが、それだけでは、プロファイリングや実行時最適化解除＆再コンパイルがJVM JITコンパイラに提供するすべての利点を補うことはできません。</p>
</div>
<div class="paragraph">
<p>ただし、JVMの速度が向上する可能性があるため、その代償として、リソース（CPUとメモリの両方）の使用量と起動時間が増加することに注意してください。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>JITが作動してコードを完全に最適化するまでに時間がかかります。</p>
</li>
<li>
<p>JIT コンパイラは、アプリケーションが利用できるリソースを消費します。</p>
</li>
<li>
<p>JVMは、より良い最適化をサポートするために、より多くのメタデータやコンパイラ/プロファイラのデータを保持しなければなりません。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>1)の理由は、コードはしばらくの間、インタプリタ実行する必要があり、場合によっては、以下を担保する全ての潜在的な最適化が実現される前に、何度もコンパイルする必要があるからです。</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>そのコードパスをコンパイルする価値があるかどうか、つまり十分な回数実行されているかどうか、そして</p>
</li>
<li>
<p>意味のある最適化を行うのに十分なプロファイリングデータを持っていること</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>1)の意味するところは、小規模で短命なアプリケーションには、ネイティブ実行可能ファイルの方が適しているということです。コンパイルされたコードは最適化されていませんが、すぐに利用できます。</p>
</div>
<div class="paragraph">
<p>2)の理由は、JVMは基本的に実行時にアプリケーションと並行してコンパイラを実行しているからです。ネイティブ実行可能ファイルの場合、コンパイラは事前に実行されるため、アプリケーションと並行してコンパイラを実行する必要がありません。</p>
</div>
<div class="paragraph">
<p>3)にはいくつかの理由があります。JVMは閉じた世界を想定していません。そのため、新しいクラスのロードにより、コンパイル時の楽観的な仮定を修正する必要がある場合には、コードを再コンパイルできなければなりません。例えば、あるインターフェイスの実装が1つだけの場合、そのコードに直接コールジャンプすることができます。しかし、2つ目の実装クラスがロードされた場合には、レシーバのインスタンスのタイプをテストして、そのクラスに属するコードにジャンプするようにコールサイトを修正する必要があります。このような最適化をサポートするには、ネイティブ実行可能ファイルよりもクラスベースの詳細を記録しておく必要があります。これには、完全なクラスとインターフェイスの階層、どのメソッドが他のメソッドをオーバーライドするかの詳細、すべてのメソッドのバイトコードなどが含まれます。ネイティブ実行可能ファイルでは、クラス構造やバイトコードの詳細のほとんどは実行時には無視できます。</p>
</div>
<div class="paragraph">
<p>また、JVMはクラスベースや実行プロファイルの変更にも対応しなければならず、その結果、スレッドが以前のコールドパスを通ることになります。その時点で、JVMはコンパイルされたコードからインタープリタにジャンプし、以前のコールドパスを含む新しい実行プロファイルに対応するためにコードを再コンパイルしなければなりません。そのためには、コンパイルされたスタックフレームを1つまたは複数のインタープリタフレームに置き換えることができる実行時情報を保持する必要があります。また、実行されたもの、されなかったものを追跡するために、ランタイムの拡張可能なプロファイルカウンタを割り当て、更新する必要があります。</p>
</div>
</div>
<div class="sect2">
<h3 id="なぜネイティブ実行可能ファイルは大きいのですか"><a class="anchor" href="#なぜネイティブ実行可能ファイルは大きいのですか"></a>なぜネイティブ実行可能ファイルは大きいのですか？</h3>
<div class="paragraph">
<p>これには様々な理由があります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ネイティブ実行可能ファイルには、アプリケーションのコードだけでなく、ライブラリのコードやJDKのコードも含まれています。そのため、ネイティブ実行可能ファイルのサイズは、アプリケーションのサイズに加えて、使用するライブラリのサイズとJDKのサイズを加えたものと比較するのが、より公平な比較となります。特にJDKの部分は、HelloWorldのようなシンプルなアプリケーションでも無視できません。イメージの中で何が引き出されているかを把握するために、ネイティブ実行可能ファイルをビルドする際に <code>-H:+PrintUniverse</code> を使用することができます。</p>
</li>
<li>
<p>ネイティブ実行可能ファイルには、実行時に実際には使われないかもしれないのに、必ず含まれている機能があります。そのような機能の例として、ガベージコレクションがあります。コンパイル時には、アプリケーションが実行時にガベージコレクションを実行する必要があるかどうかはわかりません。そのため、ガベージコレクションは、必要がないにもかかわらず、常にネイティブ実行可能ファイルに含まれ、サイズが大きくなります。ネイティブ実行可能ファイルの生成は、どのコードパスが到達可能かを特定するために、静的なコード解析に依存していますが、静的なコード解析は不正確な場合があり、実際に必要なコードよりも多くのコードがイメージに入ってしまうことがあります。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>この話題については、 <a href="https://github.com/oracle/graal/issues/287">GraalVMアップストリーム課題</a>で興味深い議論が行われています。</p>
</div>
</div>
<div class="sect2">
<h3 id="バイナリの生成に使用したmandrelのバージョンは"><a class="anchor" href="#バイナリの生成に使用したmandrelのバージョンは"></a>バイナリの生成に使用したMandrelのバージョンは？</h3>
<div class="paragraph">
<p>どのバージョンのMandrelを使ってバイナリを生成したかは、バイナリを以下のように検査すればわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ strings target/debugging-native-1.0.0-SNAPSHOT-runner | grep GraalVM
com.oracle.svm.core.VM=GraalVM 22.0.0.2-Final Java 11 Mandrel Distribution</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ネイティブ実行可能ファイルでgcロギングを有効にするにはどうすればいいですか"><a class="anchor" href="#ネイティブ実行可能ファイルでgcロギングを有効にするにはどうすればいいですか"></a>ネイティブ実行可能ファイルでGCロギングを有効にするにはどうすればいいですか？</h3>
<div class="paragraph">
<p>ネイティブ実行可能ファイルに <code>-XX:PrintFlags=</code> を付けて実行すると、ネイティブ実行可能ファイルに渡すことのできるフラグのリストが表示されます。様々なレベルのGCロギングのために、次のように使用することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./target/debugging-native-1.0.0-SNAPSHOT-runner -XX:PrintFlags=
...
  -XX:±PrintGC                                 Print summary GC information after each collection. Default: - (disabled).
  -XX:±PrintGCSummary                          Print summary GC information after application main method returns. Default: - (disabled).
  -XX:±PrintGCTimeStamps                       Print a time stamp at each collection, if +PrintGC or +VerboseGC. Default: - (disabled).
  -XX:±PrintGCTimes                            Print the time for each of the phases of each collection, if +VerboseGC. Default: - (disabled).
  -XX:±PrintHeapShape                          Print the shape of the heap before and after each collection, if +VerboseGC. Default: - (disabled).
...
  -XX:±TraceHeapChunks                         Trace heap chunks during collections, if +VerboseGC and +PrintHeapShape. Default: - (disabled).
  -XX:±VerboseGC                               Print more information about the heap before and after each collection. Default: - (disabled).</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ネイティブ実行可能ファイルのヒープダンプを取得することはできますか-例えばメモリ不足になった場合などです"><a class="anchor" href="#ネイティブ実行可能ファイルのヒープダンプを取得することはできますか-例えばメモリ不足になった場合などです"></a>ネイティブ実行可能ファイルのヒープダンプを取得することはできますか？ 例えば、メモリ不足になった場合などです。</h3>
<div class="paragraph">
<p>残念ながら、VisualVMやEclipse MATなどのツールで開くことができるhprof形式のヒープダンプを生成することは、 <a href="https://www.graalvm.org/reference-manual/native-image/NativeImageHeapdump">GraalVM Enterprise Edition</a>でしか実現できません。GraalVM Community EditionをベースにしたMandrelには、この機能はありません。</p>
</div>
<div class="paragraph">
<p>Mandrelはデバッグシンボルを生成することができ、その中にはポインターフィールドとプリミティブフィールドの違いなど、オブジェクトのレイアウトに関するかなりの情報が含まれていますが、この情報をそのままメモリリークの検出や支配的なオブジェクトの発見に使用することはできません。これは、何がルートポインタを構成するのか、また、それらのルートから再帰的にポインタをトレースする方法がわからないからです。</p>
</div>
</div>
<div class="sect2">
<h3 id="このサンプルをコンテナの外でlinuxでビルドして実行することは可能ですか"><a class="anchor" href="#このサンプルをコンテナの外でlinuxでビルドして実行することは可能ですか"></a>このサンプルをコンテナの外でLinuxでビルドして実行することは可能ですか？</h3>
<div class="paragraph">
<p>Quarkusのネイティブ実行可能ファイルのデバッグは、Linux環境で行うのが最適です。一部のデバッグ手順を実行するために必要なパッケージをインストールする場合や、 <code>perf</code> でカーネルのイベントを収集できるようにする場合を除き、ルートアクセスは必要ありません。macOSやWindows環境でのデバッグは、コンテナ環境でも機能します（ <a href="#macwindows">FAQエントリ</a>を参照）。</p>
</div>
<div class="paragraph">
<p>これらのパッケージは、様々なデバッグの節を実行するために、Linux環境で必要となるものです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># dnf (rpm-based)
sudo dnf install binutils gdb perf perl-open
# Debian-based distributions:
sudo apt install binutils gdb perf</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="フレームグラフの生成に時間がかかったりエラーが発生したりするのですがどうすればいいですか"><a class="anchor" href="#フレームグラフの生成に時間がかかったりエラーが発生したりするのですがどうすればいいですか"></a>フレームグラフの生成に時間がかかったり、エラーが発生したりするのですが、どうすればいいですか？</h3>
<div class="paragraph">
<p>Mandrelが作成したネイティブ実行可能ファイルをプロファイリングする方法は複数あります。すべての方法で、 <code>-H:-DeleteLocalSymbols</code> オプションを渡す必要があります。</p>
</div>
<div class="paragraph">
<p>このリファレンス・ガイドで紹介する方法は、DWARFのデバッグ情報を含むバイナリを生成し、 <code>perf record</code> を通して実行し、 <code>perf script</code> とフレーム・グラフ・ツールを使用してフレーム・グラフを生成します。しかし、このバイナリで行われる <code>perf script</code> の後処理ステップは、時間がかかったり、DWARF のエラーが表示されたりすることがあります。</p>
</div>
<div class="paragraph">
<p>フレームグラフを生成する別の方法として、ネイティブ実行可能ファイルを生成する際に、DWARFのデバッグ情報を生成する代わりに、 <code>-H:+PreserveFramePointer</code> を渡す方法があります。これは、フレームポインタに追加のレジスタを使用するようにバイナリに指示します。これにより、 <code>perf</code> は、実行時の動作をプロファイリングするためにスタックウォーキングを行うことができます。これらのフラグを使用してネイティブ実行可能ファイルを生成するには、以下のようにします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative
    -Dquarkus.native.additional-build-args=-H:+PreserveFramePointer,-H:-DeleteLocalSymbols</code></pre>
</div>
</div>
<div class="paragraph">
<p>実行時プロファイリング情報をネイティブ実行可能ファイルから取得するには、単純に次のようにします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf record -F 1009 -g -a ./target/debugging-native-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>実行時プロファイリング情報を生成する方法としては、フレームポインタを保持したバイナリを生成するよりも、デバッグ情報を使用することを推奨します。これは、ネイティブ実行可能ファイルのビルドプロセスにデバッグ情報を追加しても、実行時のパフォーマンスには何の影響もないのに対し、フレームポインタの保持は影響があるためです。</p>
</div>
<div class="paragraph">
<p>DWARFのデバッグ情報は、別のファイルに生成され、デフォルトのデプロイメントでは省略することもでき、プロファイリングやデバッグの目的で必要なときだけ転送して使用することができます。さらに、デバッグ情報があることで、 <code>perf</code> は関連するソースコード行も表示することができ、ネイティブ実行可能ファイル自体を肥大化させることはありません。そのためには、 <code>perf report</code> にソースコード行を表示するパラメータを追加して呼び出すだけです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">perf report --stdio -F+srcline
...
83.69%     0.00%  GreetingResource.java:20 ...
...
83.69%     0.00%  AbstractStringBuilder.java:1025 ...
...
83.69%     0.00%  ArraycopySnippets.java:95 ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>フレームポインタを保持することによる性能上のペナルティは、スタックウォーキングのために余分なレジスタを使用することによるもので、特に <code>aarch64</code> と比較して <code>x86_64</code> では使用できるレジスタの数が少なくなります。この余分なレジスタを使用すると、他の作業に使用できるレジスタの数が減るため、性能上のペナルティが発生します。</p>
</div>
</div>
<div class="sect2">
<h3 id="native-imageのバグを見つけたようなのですがideでどのようにデバッグすればいいのでしょうか"><a class="anchor" href="#native-imageのバグを見つけたようなのですがideでどのようにデバッグすればいいのでしょうか"></a>native-imageのバグを見つけたようなのですが、IDEでどのようにデバッグすればいいのでしょうか？</h3>
<div class="paragraph">
<p>コンテナ内のプロセスをリモートデバッグすることは可能ですが、Mandrelをローカルにインストールしてシェルプロセスのパスに追加することで、native-imageをステップバイステップでデバッグする方が簡単かもしれません。</p>
</div>
<div class="paragraph">
<p>ネイティブ実行可能ファイルの生成は、2つのJavaプロセスが順次実行された結果です。最初のプロセスは非常に短く、主な仕事は2番目のプロセスのために物事を準備することです。2つ目のプロセスは、ほとんどの作業を行うものです。一方のプロセスをデバッグするための手順は、若干異なります。</p>
</div>
<div class="paragraph">
<p>まず、最もデバッグしたいと思われる2番目のプロセスのデバッグ方法について説明します。2番目のプロセスのスタートポイントは、 <code>com.oracle.svm.hosted.NativeImageGeneratorRunner</code> クラスです。このプロセスをデバッグするには、ビルド時の引数として <code>--debug-attach=*:8000</code> を追加するだけです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.additional-build-args=--debug-attach=*:8000</code></pre>
</div>
</div>
<div class="paragraph">
<p>1番目のプロセスのスタートポイントとなるのは、 <code>com.oracle.svm.driver.NativeImages</code> クラスです。GraalVM CEのディストリビューションでは、この最初のプロセスはバイナリなので、従来のようにJava IDEを使ってデバッグすることはできません。しかし、Mandrelのディストリビューション（またはローカルにビルドされたGraalVM CEインスタンス）では、これを通常のJavaプロセスとして保持しているため、 <code>--vm.agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=*:8000</code> を追加のビルド引数として追加することで、このプロセスをリモートデバッグすることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./mvnw package -DskipTests -Dnative \
    -Dquarkus.native.additional-build-args=--vm.agentlib:jdwp=transport=dt_socket\\,server=y\\,suspend=y\\,address=*:8000</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jfrjmcを使ってネイティブバイナリのデバッグやプロファイリングはできますか"><a class="anchor" href="#jfrjmcを使ってネイティブバイナリのデバッグやプロファイリングはできますか"></a>JFR/JMCを使って、ネイティブバイナリのデバッグやプロファイリングはできますか？</h3>
<div class="paragraph">
<p><a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH170">Java Flight Recorder(JFR)</a>と <a href="https://www.oracle.com/java/technologies/jdk-mission-control.html">JDK Mission Control(JMC)</a>は、GraalVM CE 21.2.0以降、プロファイル・ネイティブ・バイナリのデバッグに使用することができます。 しかし、GraalVMのJFRは現在、HotSpotと比較して機能が大幅に制限されています。カスタムイベントAPIは完全にサポートされていますが、多くのVMレベルの機能は利用できません。これらは将来のリリースで追加される予定です。現在の制限事項は以下の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>最小限のVMレベルのイベント</p>
</li>
<li>
<p>oldオブジェクトのサンプリングはありません</p>
</li>
<li>
<p>スタックトレースのトレースがありません</p>
</li>
<li>
<p>JDK 17にはストリーミングAPIはありません</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JFRを使用するには、アプリケーションのプロパティ <code>-Dquarkus.native.enable-vm-inspection=true</code> を追加します。例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -DskipTests -Dnative -Dquarkus.native.container-build=true \
    -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel:22.0-java11 \
    -Dquarkus.native.enable-vm-inspection=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>イメージのコンパイルが完了したら、ランタイムフラグ <code>-XX:+FlightRecorder</code> と <code>-XX:StartFlightRecording</code> を使ってJFRを有効にし、起動します。例えば、以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./target/debugging-native-1.0.0-SNAPSHOT-runner \
    -XX:+FlightRecorder \
    -XX:StartFlightRecording="filename=recording.jfr"</code></pre>
</div>
</div>
<div class="paragraph">
<p>JFRの利用方法については <a href="https://www.graalvm.org/reference-manual/native-image/JFR">こちら</a>をご覧ください。</p>
</div>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">Japanese</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
