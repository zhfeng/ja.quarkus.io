<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Testing Your Application - 1.11</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/1.11/guides/getting-started-testing" />
  <meta property="og:title" content="Quarkus - Testing Your Application - 1.11" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/getting-started-testing">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >ENGLISH</a></li>
          <li><a href="https://ja.quarkus.io/">JAPANESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/1.11/guides/"> Back to Guides</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">Select Guide Version</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.9 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" selected>1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">Quarkus - Testing Your Application </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#前提条件">1. 前提条件</a></li>
<li><a href="#アーキテクチャ">2. アーキテクチャ</a></li>
<li><a href="#ソリューション">3. ソリューション</a></li>
<li><a href="#recap-of-http-based-testing-in-jvm-mode">4. Recap of HTTP based Testing in JVM mode</a>
<ul class="sectlevel2">
<li><a href="#テストポートの制御">4.1. テストポートの制御</a></li>
<li><a href="#controlling-http-interaction-timeout">4.2. Controlling HTTP interaction timeout</a></li>
<li><a href="#injecting-a-uri">4.3. Injecting a URI</a></li>
</ul>
</li>
<li><a href="#特定のエンドポイントのテスト">5. 特定のエンドポイントのテスト</a>
<ul class="sectlevel2">
<li><a href="#テストhttpリソース">5.1. テストHTTPリソース</a></li>
<li><a href="#restassured">5.2. RESTassured</a></li>
</ul>
</li>
<li><a href="#テストへの注入">6. テストへの注入</a></li>
<li><a href="#テストへのインターセプターの適用">7. テストへのインターセプターの適用</a></li>
<li><a href="#テストとトランザクション">8. テストとトランザクション</a></li>
<li><a href="#enrichment-via-quarkustestcallback">9. Enrichment via QuarkusTest*Callback</a></li>
<li><a href="#testing_different_profiles">10. 異なるプロファイルのテスト</a>
<ul class="sectlevel2">
<li><a href="#プロフィールの書き方">10.1. プロフィールの書き方</a></li>
</ul>
</li>
<li><a href="#モックサポート">11. モックサポート</a>
<ul class="sectlevel2">
<li><a href="#cdi-alternative-メカニズム">11.1. CDI <code>@Alternative</code>  メカニズム</a></li>
<li><a href="#quarkus_mock">11.2. Mocking using QuarkusMock</a></li>
<li><a href="#mocking-with-panache">11.3. Mocking with Panache</a></li>
</ul>
</li>
<li><a href="#セキュリティーのテスト">12. セキュリティーのテスト</a></li>
<li><a href="#quarkus-test-resource">13. Starting services before the Quarkus application starts</a></li>
<li><a href="#ネイティブ実行可能ファイルテスト">14. ネイティブ実行可能ファイルテスト</a></li>
<li><a href="#test-from-ide">15. IDE から <code>@QuarkusTest</code>  を実行する</a>
<ul class="sectlevel2">
<li><a href="#eclipse-separate-jre-definition">15.1. Eclipse separate JRE definition</a></li>
<li><a href="#vscode-run-with-設定">15.2. VSCode "run with" 設定</a></li>
<li><a href="#intellij-junit-template">15.3. IntelliJ JUnit template</a></li>
</ul>
</li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkusアプリケーションのテスト方法について説明します。このガイドでは、以下の内容について説明します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Testing in JVM mode</p>
</li>
<li>
<p>ネイティブモードでのテスト</p>
</li>
<li>
<p>テストへのリソースの注入</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="前提条件"><a class="anchor" href="#前提条件"></a>1. 前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドを完成させるには、以下が必要です:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>less than 15 minutes</p>
</li>
<li>
<p>IDE</p>
</li>
<li>
<p>JDK 1.8+ がインストールされ、 <code>JAVA_HOME</code> が適切に設定されていること</p>
</li>
<li>
<p>Apache Maven 3.6.2+</p>
</li>
<li>
<p><a href="getting-started">入門ガイド</a>の完成済のgreeterアプリケーション</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="アーキテクチャ"><a class="anchor" href="#アーキテクチャ"></a>2. アーキテクチャ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドでは、入門ガイドの一部として作成された最初のテストを拡張します。テストへのインジェクションと、ネイティブ実行可能ファイルをテストする方法もカバーしています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ソリューション"><a class="anchor" href="#ソリューション"></a>3. ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の章で紹介する手順に沿って、ステップを踏んでアプリを作成することをお勧めします。ただし、完成した例にそのまま進んでも構いません。</p>
</div>
<div class="paragraph">
<p>Gitレポジトリをクローンするか <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code> 、 <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">アーカイブ</a> をダウンロードします。</p>
</div>
<div class="paragraph">
<p>ソリューションは <code>getting-started-testing</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/getting-started-testing">ディレクトリー</a> にあります。</p>
</div>
<div class="paragraph">
<p>このガイドでは、 <code>getting-started</code> ディレクトリーの完成したアプリケーションをすでに持っていることを前提としています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="recap-of-http-based-testing-in-jvm-mode"><a class="anchor" href="#recap-of-http-based-testing-in-jvm-mode"></a>4. Recap of HTTP based Testing in JVM mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>はじめにのサンプルから始めた場合は、正しい <code>pom.xml</code> の設定を含めて、すでにテストが完了しているはずです。</p>
</div>
<div class="paragraph">
<p><code>pom.xml</code> ファイルには、2つのテスト依存関係があるはずです:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-junit5&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.rest-assured&lt;/groupId&gt;
    &lt;artifactId&gt;rest-assured&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>quarkus-junit5</code> は、テストフレームワークを制御する <code>@QuarkusTest</code> アノテーションを提供するため、テストには必須です。 <code>rest-assured</code> は必須ではありませんが、HTTP エンドポイントをテストするのに便利な方法です。</p>
</div>
<div class="paragraph">
<p>JUnit 5を使用しているので、 <a href="https://maven.apache.org/surefire/maven-surefire-plugin/">Surefire Maven Plugin</a>のバージョンを設定する必要があります。デフォルトのバージョンはJUnit 5をサポートしていない為です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
    &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;
    &lt;configuration&gt;
       &lt;systemPropertyVariables&gt;
          &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;
          &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;
       &lt;/systemPropertyVariables&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、 <code>java.util.logging.manager</code> システムプロパティーを設定して、テストが正しい logmanager と <code>maven.home</code> を使用して、 <code>${maven.home}/conf/settings.xml</code> からのカスタム設定が適用されるようにしています (存在する場合)。</p>
</div>
<div class="paragraph">
<p>プロジェクトには簡単なテストも含まれているはずです:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started.testing;

import io.quarkus.test.junit.QuarkusTest;
import org.junit.jupiter.api.Test;

import java.util.UUID;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.is;

@QuarkusTest
public class GreetingResourceTest {

    @Test
    public void testHelloEndpoint() {
        given()
          .when().get("/hello")
          .then()
             .statusCode(200)
             .body(is("hello"));
    }

    @Test
    public void testGreetingEndpoint() {
        String uuid = UUID.randomUUID().toString();
        given()
          .pathParam("name", uuid)
          .when().get("/hello/greeting/{name}")
          .then()
            .statusCode(200)
            .body(is("hello " + uuid));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このテストはHTTPを使用して、RESTエンドポイントを直接テストします。テストが実行されると、テストが実行される前にアプリケーションが開始されます。</p>
</div>
<div class="sect2">
<h3 id="テストポートの制御"><a class="anchor" href="#テストポートの制御"></a>4.1. テストポートの制御</h3>
<div class="paragraph">
<p>Quarkusはデフォルトではポート <code>8080</code> をリッスンしますが、テストを実行する場合はデフォルトで <code>8081</code> をリッスンします。これにより、アプリケーションを並行して実行しながらテストを実行することができます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">テストポートの変更</div>
<div class="literalblock">
<div class="content">
<pre>`application.properties` の `quarkus.http.test-port` を設定することで、を HTTP 用にテストで使われるポートを設定出来、 `quarkus.http.test-ssl-port` を設定することで HTTPS 用にテストで使用するポートを設定することが出来ます。</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">quarkus.http.test-port=8083
quarkus.http.test-ssl-port=8446</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>0</code> を使用すると、(オペレーティングシステムによって割り当てられた)ランダムなポートが使用されることになります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Quarkusはまた、テストを実行する前にRestAssuredによって使用されるデフォルトのポートを更新するRestAssuredインテグレーションも提供しているため、追加の設定は必要ありません。</p>
</div>
</div>
<div class="sect2">
<h3 id="controlling-http-interaction-timeout"><a class="anchor" href="#controlling-http-interaction-timeout"></a>4.2. Controlling HTTP interaction timeout</h3>
<div class="paragraph">
<p>テストで REST Assured を使用する場合、接続と応答のタイムアウトは 30 秒に設定されます。この設定は <code>quarkus.http.test-timeout</code> プロパティーでオーバーライドできます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">quarkus.http.test-timeout=10s</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="injecting-a-uri"><a class="anchor" href="#injecting-a-uri"></a>4.3. Injecting a URI</h3>
<div class="paragraph">
<p>URLをテストに直接注入することも可能で、別のクライアントを使用するのが簡単になります。これは <code>@TestHTTPResource</code> アノテーションで行います。</p>
</div>
<div class="paragraph">
<p>静的なリソースをロードするための簡単なテストを書いてみましょう。まず、シンプルなHTMLファイルを <code>src/main/resources/META-INF/resources/index.html</code> に作成します:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Testing Guide&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        Information about testing
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>これが正しく提供されているかどうかを確認するための簡単なテストを作成します:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started.testing;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URL;
import java.nio.charset.StandardCharsets;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import io.quarkus.test.common.http.TestHTTPResource;
import io.quarkus.test.junit.QuarkusTest;

@QuarkusTest
public class StaticContentTest {

    @TestHTTPResource("index.html") <i class="conum" data-value="1"></i><b>(1)</b>
    URL url;

    @Test
    public void testIndexHtml() throws Exception {
        try (InputStream in = url.openStream()) {
            String contents = readStream(in);
            Assertions.assertTrue(contents.contains("&lt;title&gt;Testing Guide&lt;/title&gt;"));
        }
    }

    private static String readStream(InputStream in) throws IOException {
        byte[] data = new byte[1024];
        int r;
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        while ((r = in.read(data)) &gt; 0) {
            out.write(data, 0, r);
        }
        return new String(out.toByteArray(), StandardCharsets.UTF_8);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>このアノテーションを使用すると、QuarkusインスタンスのURLを直接注入することができます。アノテーションの値は、URLのパス部分になります。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>今のところ <code>@TestHTTPResource</code> では、URL の <code>URI</code> , <code>URL</code> , <code>String</code> 表現を注入することができます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="特定のエンドポイントのテスト"><a class="anchor" href="#特定のエンドポイントのテスト"></a>5. 特定のエンドポイントのテスト</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RESTassured と <code>@TestHTTPResource</code> の両方で、パスをハードコーディングするのではなく、テストするエンドポイントクラスを指定することができます。これは現在、JAX-RS エンドポイント、サーブレット、リアクティブルートの両方をサポートしています。これにより、特定のテストがどのエンドポイントをテストしているかを正確に確認することが非常に簡単になりました。</p>
</div>
<div class="paragraph">
<p>これらの例では、以下のようなエンドポイントを想定しています:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/hello")
public class GreetingResource {

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        return "hello";
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
これは現在、JAX-RS のコンテキストパスを設定するための <code>@ApplicationPath()</code> アノテーションをサポートしていません。カスタムのコンテキストパスを設定したい場合は、代わりに <code>quarkus.resteasy.path</code> の設定値を使用してください。
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="テストhttpリソース"><a class="anchor" href="#テストhttpリソース"></a>5.1. テストHTTPリソース</h3>
<div class="paragraph">
<p><code>io.quarkus.test.common.http.TestHTTPEndpoint</code> アノテーションを使用してエンドポイントのパスを指定することが出来、指定されたエンドポイントからパスが抽出されます。 <code>TestHTTPResource</code> エンドポイントにも値を指定すると、エンドポイントパスの最後に追加されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started.testing;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URL;
import java.nio.charset.StandardCharsets;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import io.quarkus.test.common.http.TestHTTPEndpoint;
import io.quarkus.test.common.http.TestHTTPResource;
import io.quarkus.test.junit.QuarkusTest;

@QuarkusTest
public class StaticContentTest {

    @TestHTTPEndpoint(GreetingResource.class)  <i class="conum" data-value="1"></i><b>(1)</b>
    @TestHTTPResource
    URL url;

    @Test
    public void testIndexHtml() throws Exception {
        try (InputStream in = url.openStream()) {
            String contents = readStream(in);
            Assertions.assertTrue(contents.equals("hello"));
        }
    }

    private static String readStream(InputStream in) throws IOException {
        byte[] data = new byte[1024];
        int r;
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        while ((r = in.read(data)) &gt; 0) {
            out.write(data, 0, r);
        }
        return new String(out.toByteArray(), StandardCharsets.UTF_8);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>GreetingResource</code> は <code>@Path("/hello")</code> とアノテーションされているので、注入された URL は <code>/hello</code> で終わります。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="restassured"><a class="anchor" href="#restassured"></a>5.2. RESTassured</h3>
<div class="paragraph">
<p>RESTassured ベースパス (すなわち、すべてのリクエストのルートとなるデフォルトパス) を制御するには、 <code>io.quarkus.test.common.http.TestHTTPEndpoint</code> アノテーションを使用できます。これはクラスやメソッドレベルで適用できます。グリーティングリソースをテストするには、以下のようにします:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started.testing;

import io.quarkus.test.junit.QuarkusTest;
import io.quarkus.test.common.http.TestHTTPEndpoint;
import org.junit.jupiter.api.Test;

import java.util.UUID;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.is;

@QuarkusTest
@TestHTTPEndpoint(GreetingResource.class) <i class="conum" data-value="1"></i><b>(1)</b>
public class GreetingResourceTest {

    @Test
    public void testHelloEndpoint() {
        given()
          .when().get()    <i class="conum" data-value="2"></i><b>(2)</b>
          .then()
             .statusCode(200)
             .body(is("hello"));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>これにより、RESTAssured はすべてのリクエストの前に <code>/hello</code> を付けます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>このテストでは <code>/hello</code> がデフォルトなので、ここでパスを指定する必要はないことに注意してください。</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="テストへの注入"><a class="anchor" href="#テストへの注入"></a>6. テストへの注入</h2>
<div class="sectionbody">
<div class="paragraph">
<p>これまでは、HTTP エンドポイントを介してアプリをテストする統合スタイルのテストしか取り上げてきませんでしたが、ユニットテストを行い、Beanを直接テストしたい場合はどうでしょうか?</p>
</div>
<div class="paragraph">
<p>Quarkusでは、 <code>@Inject</code> アノテーションを介してテストにCDI Beanを注入できるようにすることで、これをサポートしています(実際、Quarkusのテストは完全なCDI Beanなので、すべてのCDI機能を使用することができます)。HTTPを使用せずにグリーティングサービスを直接テストするシンプルなテストを作成してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started.testing;

import javax.inject.Inject;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import io.quarkus.test.junit.QuarkusTest;

@QuarkusTest
public class GreetingServiceTest {

    @Inject <i class="conum" data-value="1"></i><b>(1)</b>
    GreetingService service;

    @Test
    public void testGreetingService() {
        Assertions.assertEquals("hello Quarkus", service.greeting("Quarkus"));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>GreetingService</code> Beanがテストに注入されます。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="テストへのインターセプターの適用"><a class="anchor" href="#テストへのインターセプターの適用"></a>7. テストへのインターセプターの適用</h2>
<div class="sectionbody">
<div class="paragraph">
<p>前述したように、Quarkusのテストは実際には完全なCDI Beanであり、通常のようにCDIインターセプターを適用することができます。例えば、トランザクションのコンテキスト内でテストメソッドを実行したい場合、 <code>@Transactional</code> アノテーションをメソッドに適用するだけで、トランザクションインターセプターがそれを処理します。</p>
</div>
<div class="paragraph">
<p>これに加えて、独自のテスト・ステレオタイプを作成することもできます。例えば、次のように <code>@TransactionalQuarkusTest</code> を作成することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@Stereotype
@Transactional
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface TransactionalQuarkusTest {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このアノテーションをテストクラスに適用すると、 <code>@QuarkusTest</code> と <code>@Transactional</code> の両方のアノテーションを適用したかのように動作します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@TransactionalQuarkusTest
public class TestStereotypeTestCase {

    @Inject
    UserTransaction userTransaction;

    @Test
    public void testUserTransaction() throws Exception {
        Assertions.assertEquals(Status.STATUS_ACTIVE, userTransaction.getStatus());
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="テストとトランザクション"><a class="anchor" href="#テストとトランザクション"></a>8. テストとトランザクション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>テストでは標準のQuarkus <code>@Transactional</code> アノテーションを使用することができますが、これは、テストでデータベースに加えた変更が永続化されることを意味します。テストの終了時に変更をロールバックしたい場合は、 <code>io.quarkus.test.TestTransaction</code> アノテーションを使用することができます。これは、トランザクション内でテストメソッドを実行しますが、テストメソッドが完了したらロールバックして、データベースの変更を元に戻します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enrichment-via-quarkustestcallback"><a class="anchor" href="#enrichment-via-quarkustestcallback"></a>9. Enrichment via QuarkusTest*Callback</h2>
<div class="sectionbody">
<div class="paragraph">
<p>インターセプターの代わりに、あるいはインターセプターに加えて、以下のコールバックインターフェースを実装することで、 <strong>すべての</strong> <code>@QuarkusTest</code> クラスを充実させることができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io.quarkus.test.junit.callback.QuarkusTestBeforeClassCallback</code></p>
</li>
<li>
<p><code>io.quarkus.test.junit.callback.QuarkusTestAfterConstructCallback</code></p>
</li>
<li>
<p><code>io.quarkus.test.junit.callback.QuarkusTestBeforeEachCallback</code></p>
</li>
<li>
<p><code>io.quarkus.test.junit.callback.QuarkusTestAfterEachCallback</code></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>io.quarkus.test.junit.callback.QuarkusTestBeforeAllCallback</code> は <code>io.quarkus.test.junit.callback.QuarkusTestAfterConstructCallback</code> に代わって非推奨となり、Quarkusの将来のリリースでは削除される予定です。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>このようなコールバックの実装は、 <code>java.util.ServiceLoader</code> で定義されている「サービスプロバイダ」として登録する必要があります。</p>
</div>
<div class="paragraph">
<p>例えば、以下のようなサンプルコールバックです:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started.testing;

import io.quarkus.test.junit.callback.QuarkusTestBeforeEachCallback;
import io.quarkus.test.junit.callback.QuarkusTestMethodContext;

public class MyQuarkusTestBeforeEachCallback implements QuarkusTestBeforeEachCallback {

    @Override
    public void beforeEach(QuarkusTestMethodContext context) {
        System.out.println("Executing " + context.getTestMethod());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>has to be registered via <code>src/main/resources/META-INF/services/io.quarkus.test.junit.callback.QuarkusTestBeforeEachCallback</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">org.acme.getting.started.testing.MyQuarkusTestBeforeEachCallback</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
テストクラスやメソッドからアノテーションを読み込んで、コールバックが何をするかを制御することができます。
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>BeforeEachCallback</code> のような JUnit Jupiter コールバックインターフェイスを使うことも可能ですが、QuarkusはJUnitが把握しないカスタムクラスローダーでテストを実行する必要がある為、クラスローディングの問題にぶつかるかもしれません。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing_different_profiles"><a class="anchor" href="#testing_different_profiles"></a>10. 異なるプロファイルのテスト</h2>
<div class="sectionbody">
<div class="paragraph">
<p>これまでのところ、すべての例では、すべてのテストに対して一度だけQuarkusを起動しています。最初のテストが実行される前にQuarkusが起動し、次にすべてのテストが実行され、最後にQuarkusがシャットダウンします。これにより、非常に高速なテストが可能になりますが、異なる設定をテストすることができないため、少し制限があります。</p>
</div>
<div class="paragraph">
<p>この問題を回避するために、Quarkusはテストプロファイルの考え方をサポートしています。以前に実行したテストとは異なるプロファイルを持つテストがある場合、Quarkusはテストを実行する前にシャットダウンされ、新しいプロファイルで開始されます。これは、テスト時間にシャットダウン/起動サイクルが追加されるため、明らかに少し遅くなりますが、非常に大きな柔軟性が得られます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Quarkusの再起動の回数を減らすために、特定のプロファイルを必要とするすべてのテストを独自のパッケージに入れ、アルファベット順にテストを実行することをお勧めします。
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="プロフィールの書き方"><a class="anchor" href="#プロフィールの書き方"></a>10.1. プロフィールの書き方</h3>
<div class="paragraph">
<p>テストプロファイルを実装するには、 <code>io.quarkus.test.junit.QuarkusTestProfile</code> .</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.getting.started.testing;

import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Set;

import io.quarkus.test.junit.QuarkusTestProfile;
import io.quarkus.test.junit.QuarkusTestProfile.TestResourceEntry;

public class MockGreetingProfile implements QuarkusTestProfile {

    @Override
    public Map&lt;String, String&gt; getConfigOverrides() { <i class="conum" data-value="1"></i><b>(1)</b>
        return Collections.singletonMap("quarkus.resteasy.path","/api");
    }

    @Override
    public Set&lt;Class&lt;?&gt;&gt; getEnabledAlternatives() { <i class="conum" data-value="2"></i><b>(2)</b>
        return Collections.singleton(MockGreetingService.class);
    }


    @Override
    public String getConfigProfile() { <i class="conum" data-value="3"></i><b>(3)</b>
        return "test";
    }

    @Override
    public List&lt;TestResourceEntry&gt; testResources() { <i class="conum" data-value="4"></i><b>(4)</b>
        return Collections.singletonList(new TestResourceEntry(CustomWireMockServerManager.class));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>この方法では、設定プロパティーをオーバーライドすることができます。ここでは、JAX-RSのルートパスを変更しています。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>このメソッドを使うことで、CDI <code>@Alternative</code> Beanを有効にすることができます。これにより、特定のBeanの機能を簡単にモックアウトすることができます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>これは設定プロファイルを変更するために使用できます。このデフォルトは <code>test</code> なので、これは何もしませんが、完全性を保つために含まれています。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>このメソッドを使用すると、このプロファイル専用の <code>QuarkusTestResourceLifecycleManager</code> クラスを <strong>追加で</strong> 適用することができます。このメソッドがオーバーライドされていない場合は、 <code>@QuarkusTestResource</code> クラスアノテーションを介して有効化された <code>QuarkusTestResourceLifecycleManager</code> クラスのみが、このプロファイルを使用するテストに使用されます (これは、プロファイルを全く使用しないテストと同じ動作です)。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>プロファイルを定義したので、それをテストクラスに含める必要があります。 <code>@TestProfile(MockGreetingProfile.class)</code> で、これを行うことが出来ます。</p>
</div>
<div class="paragraph">
<p>テストプロファイルの設定はすべて単一のクラスに保存されているので、前回のテストが同じ設定で実行されたかどうかが簡単にわかります。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="モックサポート"><a class="anchor" href="#モックサポート"></a>11. モックサポート</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkusでは、2つの異なるアプローチを使用したモックオブジェクトの使用をサポートしています。CDIの代替品を使用してすべてのテストクラスのBeanをモックアウトするか、 <code>QuarkusMock</code> を使用してテストごとにBeanをモックアウトすることができます。</p>
</div>
<div class="sect2">
<h3 id="cdi-alternative-メカニズム"><a class="anchor" href="#cdi-alternative-メカニズム"></a>11.1. CDI <code>@Alternative</code>  メカニズム</h3>
<div class="paragraph">
<p>これを使用するには、 <code>src/test/java</code> ディレクトリーのクラスでモックしたいBeanをオーバーライドし、 <code>@Alternative</code> と <code>@Priority(1)</code> アノテーションをBeanに配置するだけです。あるいは、便利な <code>io.quarkus.test.Mock</code> ステレオタイプアノテーションを使用することもできます。この組み込みステレオタイプは、 <code>@Alternative</code> 、 <code>@Priority(1)</code> 、 <code>@Dependent</code> を宣言します。例えば、以下のようなサービスがあるとします:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class ExternalService {

    public String service() {
        return "external";
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>src/test/java</code> で以下のクラスでモックできました:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mock
@ApplicationScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class MockExternalService extends ExternalService {

    @Override
    public String service() {
        return "mock";
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Mock</code> ステレオタイプで宣言された <code>@Dependent</code> スコープをオーバーライドします。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>代替品が <code>src/main/java</code> ではなく <code>src/test/java</code> ディレクトリーに存在することが重要です。そうでなければ、テスト以外も常に有効になってしまいます。</p>
</div>
<div class="paragraph">
<p>現在のところ、このアプローチはネイティブイメージテストでは機能しないことに注意してください。テスト代替品がネイティブイメージに焼き込まれる必要がある為です。</p>
</div>
</div>
<div class="sect2">
<h3 id="quarkus_mock"><a class="anchor" href="#quarkus_mock"></a>11.2. Mocking using QuarkusMock</h3>
<div class="paragraph">
<p><code>io.quarkus.test.junit.QuarkusMock</code> クラスは、通常のスコープ付きBeanを一時的にモックアウトするために使用することができます。 <code>@BeforeAll</code> メソッドでこのメソッドを使用した場合、モックは現在のクラスのすべてのテストに対して有効になりますが、test メソッドでこれを使用した場合、モックは現在のテストの間のみ有効になります。</p>
</div>
<div class="paragraph">
<p>この方法は、通常のスコープ付き CDI Bean(例: <code>@ApplicationScoped</code> , <code>@RequestScoped</code> など、 <code>@Singleton</code> と <code>@Dependent</code> 以外の基本的にすべてのスコープ)に対して使用することができます。</p>
</div>
<div class="paragraph">
<p>使用例は次のようになります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class MockTestCase {

    @Inject
    MockableBean1 mockableBean1;

    @Inject
    MockableBean2 mockableBean2;

    @BeforeAll
    public static void setup() {
        MockableBean1 mock = Mockito.mock(MockableBean1.class);
        Mockito.when(mock.greet("Stuart")).thenReturn("A mock for Stuart");
        QuarkusMock.installMockForType(mock, MockableBean1.class);  <i class="conum" data-value="1"></i><b>(1)</b>
    }

    @Test
    public void testBeforeAll() {
        Assertions.assertEquals("A mock for Stuart", mockableBean1.greet("Stuart"));
        Assertions.assertEquals("Hello Stuart", mockableBean2.greet("Stuart"));
    }

    @Test
    public void testPerTestMock() {
        QuarkusMock.installMockForInstance(new BonjourGreeter(), mockableBean2); <i class="conum" data-value="2"></i><b>(2)</b>
        Assertions.assertEquals("A mock for Stuart", mockableBean1.greet("Stuart"));
        Assertions.assertEquals("Bonjour Stuart", mockableBean2.greet("Stuart"));
    }

    @ApplicationScoped
    public static class MockableBean1 {

        public String greet(String name) {
            return "Hello " + name;
        }
    }

    @ApplicationScoped
    public static class MockableBean2 {

        public String greet(String name) {
            return "Hello " + name;
        }
    }

    public static class BonjourGreeter extends MockableBean2 {
        @Override
        public String greet(String name) {
            return "Bonjour " + name;
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>インジェクションされたインスタンスはここでは利用できないので、 <code>installMockForType</code> を使用します。このモックは両方のテストメソッドに使用されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>私たちは <code>installMockForInstance</code> を使用して注入されたBeanを置き換えます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mockitoには依存しないことに注意してください。好きなモッキングライブラリを使うことができますし、必要な動作を提供するためにオブジェクトを手動でオーバーライドすることもできます。</p>
</div>
<div class="sect3">
<h4 id="injectmock-での更なる単純化"><a class="anchor" href="#injectmock-での更なる単純化"></a>11.2.1. <code>@InjectMock</code> での更なる単純化</h4>
<div class="paragraph">
<p><code>QuarkusMock</code> で提供されている機能をベースに、Quarkusでは、 <code>QuarkusMock</code> でサポートされているBeanをモックするために <a href="https://site.mockito.org/">Mockito を</a>簡単に利用できるようにしています。この機能は、 <code>quarkus-junit5-mockito</code> 依存関係で利用可能な <code>@io.quarkus.test.junit.mockito.InjectMock</code> アノテーションを介して利用できます。</p>
</div>
<div class="paragraph">
<p><code>@InjectMock</code> を使用すると、先ほどの例は次のように書くことができます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class MockTestCase {

    @InjectMock
    MockableBean1 mockableBean1; <i class="conum" data-value="1"></i><b>(1)</b>

    @InjectMock
    MockableBean2 mockableBean2;

    @BeforeEach
    public void setup() {
        Mockito.when(mockableBean1.greet("Stuart")).thenReturn("A mock for Stuart"); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @Test
    public void firstTest() {
        Assertions.assertEquals("A mock for Stuart", mockableBean1.greet("Stuart"));
        Assertions.assertEquals(null, mockableBean2.greet("Stuart")); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    @Test
    public void secondTest() {
        Mockito.when(mockableBean2.greet("Stuart")).thenReturn("Bonjour Stuart"); <i class="conum" data-value="4"></i><b>(4)</b>
        Assertions.assertEquals("A mock for Stuart", mockableBean1.greet("Stuart"));
        Assertions.assertEquals("Bonjour Stuart", mockableBean2.greet("Stuart"));
    }

    @ApplicationScoped
    public static class MockableBean1 {

        public String greet(String name) {
            return "Hello " + name;
        }
    }

    @ApplicationScoped
    public static class MockableBean2 {

        public String greet(String name) {
            return "Hello " + name;
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@InjectMock</code> により、モックがテストクラスのテストメソッドに存在することになり、利用可能になります (他のテストクラスはこの影響を受け <strong>ません</strong> )。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>クラスのすべてのテストメソッドに対して <code>mockableBean1</code> が設定されています。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>mockableBean2</code> のモックが設定されていないので、デフォルトの Mockito レスポンスを返します。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>このテストでは、 <code>mockableBean2</code> が設定されているので、設定されたレスポンスを返します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上のテストは <code>@InjectMock</code> の機能を示すのには良いですが、実際のテストを上手く表してはいません。実際のテストでは、ほとんどの場合、モックを設定し、モックされたBeanを使用するBeanをテストします。以下に例を示します:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class MockGreetingServiceTest {

    @InjectMock
    GreetingService greetingService;

    @Test
    public void testGreeting() {
        when(greetingService.greet()).thenReturn("hi");
        given()
                .when().get("/greeting")
                .then()
                .statusCode(200)
                .body(is("hi")); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    @Path("greeting")
    public static class GreetingResource {

        final GreetingService greetingService;

        public GreetingResource(GreetingService greetingService) {
            this.greetingService = greetingService;
        }

        @GET
        @Produces("text/plain")
        public String greet() {
            return greetingService.greet();
        }
    }

    @ApplicationScoped
    public static class GreetingService {
        public String greet(){
            return "hello";
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>greetingService</code> をモックとして設定したので、 <code>GreetingService</code> Beanを使用する <code>GreetingResource</code> は、通常の <code>GreetingService</code> Beanのレスポンスの代わりにモックされたレスポンスを取得します。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="injectspy-でモックの代わりにスパイを使用する"><a class="anchor" href="#injectspy-でモックの代わりにスパイを使用する"></a>11.2.2. <code>@InjectSpy</code> で、モックの代わりにスパイを使用する</h4>
<div class="paragraph">
<p><code>InjectMock</code> で提供されている機能をベースに、 <code>QuarkusMock</code> でサポートされているBeanをスパイするために <a href="https://site.mockito.org/">Mockito </a>を簡単に利用できるようにしました。この機能は、 <code>quarkus-junit5-mockito</code> 依存関係で利用可能な <code>@io.quarkus.test.junit.mockito.InjectSpy</code> アノテーションを介して利用できます。</p>
</div>
<div class="paragraph">
<p>テストを行う際に、特定の論理パスが取られたかどうかを確認するだけで済む場合もありますし、Spied クローン上で残りのメソッドを実行している間に、1つのメソッドのレスポンスをスタブアウトするだけで済む場合もあります。Spy パーシャル モックの詳細については <a href="https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html#spy-T-">Mockito のドキュメント</a>を参照してください。いずれの場合も、オブジェクトの Spy が望ましいでしょう。 <code>@InjectSpy</code> を使用して、先ほどの例は次のように書くことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class SpyGreetingServiceTest {

    @InjectSpy
    GreetingService greetingService;

    @Test
    public void testDefaultGreeting() {
        given()
                .when().get("/greeting")
                .then()
                .statusCode(200)
                .body(is("hello"));

        Mockito.verify(greetingService, Mockito.times(1)).greet(); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    @Test
    public void testOverrideGreeting() {
        when(greetingService.greet()).thenReturn("hi"); <i class="conum" data-value="2"></i><b>(2)</b>
        given()
                .when().get("/greeting")
                .then()
                .statusCode(200)
                .body(is("hi")); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    @Path("greeting")
    public static class GreetingResource {

        final GreetingService greetingService;

        public GreetingResource(GreetingService greetingService) {
            this.greetingService = greetingService;
        }

        @GET
        @Produces("text/plain")
        public String greet() {
            return greetingService.greet();
        }
    }

    @ApplicationScoped
    public static class GreetingService {
        public String greet(){
            return "hello";
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>値をオーバーライドするのではなく、 <code>GreetingService</code> の greet メソッドがこのテストで呼び出されたことを確認したいだけです。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここでは、"hello"の代わりに"hi"を返すようにSpyに指示しています。 <code>GreetingResource</code> が <code>GreetingService</code> から挨拶を要求するとき、通常の <code>GreetingService</code> Bean のレスポンスの代わりにモックされたレスポンスを取得します。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>私たちは、スパイからのモックされた応答を得ることを検証しています。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="injectmock-との併用-restclient"><a class="anchor" href="#injectmock-との併用-restclient"></a>11.2.3. <code>@InjectMock</code>  との併用 <code>@RestClient</code></h4>
<div class="paragraph">
<p><code>@RegisterRestClient</code> は、実行時に rest-client の実装を登録しています。Beanは通常のスコープである必要があるため、インターフェイスに <code>@ApplicationScoped</code> を付与する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/")
@ApplicationScoped
@RegisterRestClient
public interface GreetingService {

    @GET
    @Path("/hello")
    @Produces(MediaType.TEXT_PLAIN)
    String hello();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>テストクラスの例です:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class GreetingResourceTest {

    @InjectMock
    @RestClient <i class="conum" data-value="1"></i><b>(1)</b>
    GreetingService greetingService;

    @Test
    public void testHelloEndpoint() {
        Mockito.when(greetingService.hello()).thenReturn("hello from mockito");

        given()
          .when().get("/hello")
          .then()
             .statusCode(200)
             .body(is("hello from mockito"));
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>この注入ポイントが <code>RestClient</code> のインスタンスを使用することを意味していることを示します。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mocking-with-panache"><a class="anchor" href="#mocking-with-panache"></a>11.3. Mocking with Panache</h3>
<div class="paragraph">
<p><code>quarkus-hibernate-orm-panache</code> や <code>quarkus-mongodb-panache</code> のエクステンションを使っている場合は、 <a href="hibernate-orm-panache#mocking">Hibernate ORM とPanache Mocking</a>や <a href="mongodb-panache#mocking">MongoDB とPanache Mocking</a>のドキュメントをチェックして、データアクセスをモックする最も簡単な方法を確認してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="セキュリティーのテスト"><a class="anchor" href="#セキュリティーのテスト"></a>12. セキュリティーのテスト</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus Securityを使用している場合、アプリケーションのセキュリティー機能を簡単にテストする方法については、「 <a href="security-testing">セキュリティーのテスト</a>」のセクションをご覧ください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quarkus-test-resource"><a class="anchor" href="#quarkus-test-resource"></a>13. Starting services before the Quarkus application starts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>非常に一般的なニーズは、Quarkusアプリケーションがテストを開始する前に、Quarkusアプリケーションに依存するいくつかのサービスを開始することです。このニーズに対応するために、Quarkusでは、 <code>@io.quarkus.test.common.QuarkusTestResource</code> と <code>io.quarkus.test.common.QuarkusTestResourceLifecycleManager</code> を提供します。</p>
</div>
<div class="paragraph">
<p>By simply annotating any test in the test suite with <code>@QuarkusTestResource</code>, Quarkus will run the corresponding <code>QuarkusTestResourceLifecycleManager</code> before any tests are run. A test suite is also free to utilize multiple <code>@QuarkusTestResource</code> annotations, in which case all the corresponding <code>QuarkusTestResourceLifecycleManager</code> objects will be run before the tests.</p>
</div>
<div class="paragraph">
<p>Quarkus provides a few implementations of <code>QuarkusTestResourceLifecycleManager</code> out of the box (see <code>io.quarkus.test.h2.H2DatabaseTestResource</code> which starts an H2 database, or <code>io.quarkus.test.kubernetes.client.KubernetesMockServerTestResource</code> which starts a mock Kubernetes API server), but it is common to create custom implementations to address specific application needs. Common cases include starting docker containers using <a href="https://www.testcontainers.org/">Testcontainers</a> (an example of which can be found <a href="https://github.com/quarkusio/quarkus-quickstarts/blob/main/kafka-quickstart/src/test/java/org/acme/kafka/KafkaResource.java">here</a>), or starting a mock HTTP server using <a href="http://wiremock.org/">Wiremock</a> (an example of which can be found <a href="https://github.com/geoand/quarkus-test-demo/blob/master/src/test/java/org/acme/getting/started/country/WiremockCountries.java">here</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ネイティブ実行可能ファイルテスト"><a class="anchor" href="#ネイティブ実行可能ファイルテスト"></a>14. ネイティブ実行可能ファイルテスト</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>@NativeImageTest</code> を使用してネイティブ実行可能ファイルをテストすることも可能です。これは、テストに注入すること(そして、ネイティブ実行可能ファイルは別の非JVMプロセスで実行されることーこれは実際には可能ではありません)を除いて、このガイドで述べたすべての機能をサポートしています。</p>
</div>
<div class="paragraph">
<p>これは <a href="building-native-image">ネイティブ実行可能ファイルガイド</a> で説明されています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-from-ide"><a class="anchor" href="#test-from-ide"></a>15. IDE から <code>@QuarkusTest</code>  を実行する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ほとんどの IDE では、選択したクラスを JUnit テストとして直接実行できるようになっています。そのためには、選択した IDE の設定でいくつかのプロパティーを設定する必要があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.logging.manager</code> (ロ <a href="logging">ギングガイド</a>を参照)</p>
</li>
<li>
<p><code>maven.home</code> (only if there are any custom settings in <code>${maven.home}/conf/settings.xml</code>, see <a href="maven-tooling">Maven Guide</a>)</p>
</li>
<li>
<p><code>maven.settings</code> (カスタム版の <code>settings.xml</code> ファイルをテストに使用する場合)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="eclipse-separate-jre-definition"><a class="anchor" href="#eclipse-separate-jre-definition"></a>15.1. Eclipse separate JRE definition</h3>
<div class="paragraph">
<p>現在の"Installed JRE"定義を新しい定義にコピーし、新しいVMの引数としてプロパティーを追加します:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-Djava.util.logging.manager=org.jboss.logmanager.LogManager</code></p>
</li>
<li>
<p><code>-Dmaven.home=&lt;path-to-your-maven-installation&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このJRE定義をQuarkusプロジェクトのターゲットランタイムとして使用すると、「Run as JUnit」設定に回避策が適用されます。</p>
</div>
</div>
<div class="sect2">
<h3 id="vscode-run-with-設定"><a class="anchor" href="#vscode-run-with-設定"></a>15.2. VSCode "run with" 設定</h3>
<div class="paragraph">
<p>プロジェクトディレクトリーやワークスペースのルートにある <code>settings.json</code> は、テスト設定で回避策が必要です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">"java.test.config": [
    {
        "name": "quarkusConfiguration",
        "vmargs": [ "-Djava.util.logging.manager=org.jboss.logmanager.LogManager -Dmaven.home=&lt;path-to-your-maven-installation&gt; ..." ],
        ...
    },
  ...
]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="intellij-junit-template"><a class="anchor" href="#intellij-junit-template"></a>15.3. IntelliJ JUnit template</h3>
<div class="paragraph">
<p>IntelliJでは何も必要ありません。なぜなら、IDEは <code>systemPropertyVariables</code> を `pom.xml`のsurefireプラグイン設定から取得するからです。</p>
</div>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">Japanese</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
