<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Using the Cassandra Client - main</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/main/guides/cassandra" />
  <meta property="og:title" content="Using the Cassandra Client - main" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/cassandra">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >ENGLISH</a></li>
          <li><a href="https://ja.quarkus.io/">JAPANESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/main/guides/"> Back to Guides</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">Select Guide Version</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" selected>Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.9 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" >1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">Using the Cassandra Client </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#前提条件">前提条件</a></li>
<li><a href="#アーキテクチャ">アーキテクチャ</a></li>
<li><a href="#ソリューション">ソリューション</a></li>
<li><a href="#creating-a-blank-maven-project">Creating a Blank Maven Project</a></li>
<li><a href="#データモデルとデータアクセスオブジェクトの作成">データモデルとデータアクセスオブジェクトの作成</a></li>
<li><a href="#creating-a-service-json-rest-endpoint">Creating a Service &amp; JSON REST Endpoint</a></li>
<li><a href="#connecting-to-the-cassandra-database">Connecting to the Cassandra Database</a>
<ul class="sectlevel2">
<li><a href="#connecting-to-apache-cassandra-or-datastax-enterprise-dse">Connecting to Apache Cassandra or DataStax Enterprise (DSE)</a></li>
<li><a href="#connecting-to-a-datastax-astra-cloud-database">Connecting to a DataStax Astra Cloud Database</a></li>
<li><a href="#advanced-driver-configuration">Advanced Driver Configuration</a></li>
</ul>
</li>
<li><a href="#running-a-local-cassandra-database">Running a Local Cassandra Database</a></li>
<li><a href="#testing-the-rest-api">Testing the REST API</a></li>
<li><a href="#creating-a-frontend">Creating a Frontend</a></li>
<li><a href="#reactive">Reactive Programming with the Cassandra Client</a></li>
<li><a href="#testing-the-reactive-rest-api">Testing the Reactive REST API</a></li>
<li><a href="#creating-a-reactive-frontend">Creating a Reactive Frontend</a></li>
<li><a href="#ヘルスチェック">ヘルスチェック</a></li>
<li><a href="#メトリクス">メトリクス</a>
<ul class="sectlevel2">
<li><a href="#enabling-metrics-with-micrometer">Enabling Metrics with Micrometer</a></li>
<li><a href="#enabling-metrics-with-microprofile-metrics">Enabling Metrics with MicroProfile Metrics</a></li>
<li><a href="#enabling-cassandra-metrics">Enabling Cassandra Metrics</a></li>
</ul>
</li>
<li><a href="#ネイティブモードでの実行">ネイティブモードでの実行</a></li>
<li><a href="#eager-vs-lazy-initialization">Eager vs Lazy Initialization</a></li>
<li><a href="#まとめ">まとめ</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Apache Cassandra®は、フリーでオープンソースの分散型ワイドカラムストアのNoSQLデータベース管理システムで、多くのコモディティサーバーにまたがる大量のデータを処理するように設計されており、単一障害点のない高可用性を提供します。</p>
</div>
<div class="paragraph">
<p>このガイドでは、RESTサービスでCassandraデータベースを使用する方法を見ていきます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このエクステンションはサードパーティによって開発されたもので、Quarkus Platformの一部です。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="前提条件"><a class="anchor" href="#前提条件"></a>前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドを完成させるには、以下が必要です:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>約15分</p>
</li>
<li>
<p>An IDE</p>
</li>
<li>
<p>JDK 11+ がインストールされ、 <code>JAVA_HOME</code> が適切に設定されていること</p>
</li>
<li>
<p>Apache Maven 3.8.1+</p>
</li>
<li>
<p>使用したい場合、 <a href="cli-tooling.html">Quarkus CLI</a></p>
</li>
<li>
<p>ネイティブ実行可能ファイルをビルドしたい場合、MandrelまたはGraalVM（あるいはネイティブなコンテナビルドを使用する場合はDocker）をインストールし、 <a href="building-native-image.html#configuring-graalvm">適切に設定</a>していること</p>
</li>
<li>
<p>稼働中の <a href="https://cassandra.apache.org">Apache Cassandra</a>、 <a href="https://www.datastax.fr/products/datastax-enterprise">DataStax Enterprise</a>（DSE）、または <a href="https://astra.datastax.com">DataStax Astra</a>データベース、あるいはきれいなDockerのインストール</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="アーキテクチャ"><a class="anchor" href="#アーキテクチャ"></a>アーキテクチャ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このクイックスタート・ガイドでは、 <a href="https://docs.datastax.com/en/developer/java-driver/latest">DataStax Javaドライバー</a>を使用してApache Cassandra、DataStax Enterprise（DSE）、またはDataStax Astraデータベースに接続できる <a href="https://github.com/datastax/cassandra-quarkus">Cassandra Quarkusエクステンション</a>を使用してRESTアプリケーションを構築する方法を説明します。</p>
</div>
<div class="paragraph">
<p>This guide will also use the <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/mapper">DataStax Object Mapper</a> – a powerful Java-to-CQL mapping framework that greatly simplifies your application&#8217;s data access layer code by sparing you the hassle of writing your CQL queries by hand.</p>
</div>
<div class="paragraph">
<p>このガイドで構築されたアプリケーションは非常にシンプルです: ユーザーはフォームを使用してリストに要素を追加することができ、アイテムリストが更新されます。ブラウザーとサーバー間の情報はすべてJSONフォーマットで、各要素はCassandraデータベースに保存されます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ソリューション"><a class="anchor" href="#ソリューション"></a>ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の章で紹介する手順に沿って、ステップを踏んでアプリを作成することをお勧めします。ただし、完成した例にそのまま進んでも構いません。</p>
</div>
<div class="paragraph">
<p>ソリューションはCassandra QuarkusエクステンションGitHubレポジトリの <a href="https://github.com/datastax/cassandra-quarkus/tree/main/quickstart">quickstart directory</a> にあります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-blank-maven-project"><a class="anchor" href="#creating-a-blank-maven-project"></a>Creating a Blank Maven Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず、新しいMavenプロジェクトを作成し、 <code>quickstart</code> ディレクトリーに存在する <code>pom.xml</code> ファイルをコピーします。</p>
</div>
<div class="paragraph">
<p><code>pom.xml</code> 、必要なQuarkusのエクステンションや依存関係をすべてインポートしています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="データモデルとデータアクセスオブジェクトの作成"><a class="anchor" href="#データモデルとデータアクセスオブジェクトの作成"></a>データモデルとデータアクセスオブジェクトの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この例では、果物のリストを管理するアプリケーションを作成します。</p>
</div>
<div class="paragraph">
<p>まず、以下のように <code>Fruit</code> クラスであらわされるデータもデールを作成してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
@PropertyStrategy(mutable = false)
public class Fruit {

    @PartitionKey
    private final String name;

    private final String description;

    public Fruit(String name, String description) {
      this.name = name;
      this.description = description;
    }
  // getters, hashCode, equals, toString methods omitted for brevity
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>前述のとおり、ここではDataStax Object Mapperを使用しています。つまり、CQLクエリーを手動で記述するのではなく、データ・モデルにいくつかのアノテーションを付け、裏側でマッパーが適切なCQLクエリーを生成するのです。</p>
</div>
<div class="paragraph">
<p>これが、 <code>Fruit</code> クラスが <code>@Entity</code> でアノテーションされている理由です。このアノテーションは、Cassandraテーブルにマッピングされる _エンティティ・クラス_としてマークされます。このクラスのインスタンスは、Cassandraデータベースに自動的に永続化され、そこから取得されます。ここでは、テーブル名はクラス名から推測されます： <code>fruit</code> 。</p>
</div>
<div class="paragraph">
<p>Also, the <code>name</code> field represents a Cassandra partition key, and so we are annotating it with <code>@PartitionKey</code> – another annotation from the Object Mapper library.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Entity classes are normally required to have a default no-arg constructor, unless they are annotated with <code>@PropertyStrategy(mutable = false)</code>, which is the case here.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next step is to create a DAO (Data Access Object) interface that will manage instances of <code>Fruit</code> entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Dao
public interface FruitDao {
  @Update
  void update(Fruit fruit);

  @Select
  PagingIterable&lt;Fruit&gt; findAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This interface exposes operations that will be used in our REST service. Again, the annotation <code>@Dao</code> comes from the DataStax Object Mapper, which will also automatically generate an implementation of this interface for you.</p>
</div>
<div class="paragraph">
<p>Note also the special return type of the <code>findAll</code> method, <a href="https://docs.datastax.com/en/drivers/java/latest/com/datastax/oss/driver/api/core/PagingIterable.html"><code>PagingIterable</code></a>: it&#8217;s the base type of result sets returned by the driver.</p>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s create the a Mapper interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mapper
public interface FruitMapper {
  @DaoFactory
  FruitDao fruitDao();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Mapper</code> annotation is yet another annotation recognized by the DataStax Object Mapper. A mapper is responsible for constructing instances of DAOs – in this case, out mapper is constructing an instance of our only DAO, <code>FruitDao</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-service-json-rest-endpoint"><a class="anchor" href="#creating-a-service-json-rest-endpoint"></a>Creating a Service &amp; JSON REST Endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s create a <code>FruitService</code> that will be the business layer of our application and store/load the fruits from the Cassandra database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class FruitService {

  @Inject FruitDao dao;

  public void save(Fruit fruit) {
    dao.update(fruit);
  }

  public List&lt;Fruit&gt; getAll() {
    return dao.findAll().all();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the service is being injected a <code>FruitDao</code> instance. This DAO instance is injected automatically.</p>
</div>
<div class="paragraph">
<p>The Cassandra Quarkus extension allows you to inject any of the following beans in your own components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All <code>@Mapper</code>-annotated interfaces in your project.</p>
</li>
<li>
<p>All <code>@Dao</code>-annotated interfaces in your project, as long as they are produced by a corresponding <code>@DaoFactory</code>-annotated method declared in a mapper interface from your project.</p>
</li>
<li>
<p>The <a href="https://javadoc.io/doc/com.datastax.oss.quarkus/cassandra-quarkus-client/latest/com/datastax/oss/quarkus/runtime/api/session/QuarkusCqlSession.html"><code>QuarkusCqlSession</code></a> bean: this application-scoped, singleton bean is your main entry point to the Cassandra client; it is a specialized Cassandra driver session instance with a few methods tailored especially for Quarkus. Read its javadocs carefully!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In our example, both <code>FruitMapper</code> and <code>FruitDao</code> could be injected anywhere. We chose to inject <code>FruitDao</code> in <code>FruitService</code>.</p>
</div>
<div class="paragraph">
<p>最後に必要なのは、GETとPOSTのメソッドを公開するREST APIです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/fruits")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class FruitResource {

  @Inject FruitService fruitService;

  @GET
  public List&lt;FruitDto&gt; getAll() {
    return fruitService.getAll().stream().map(this::convertToDto).collect(Collectors.toList());
  }

  @POST
  public void add(FruitDto fruit) {
    fruitService.save(convertFromDto(fruit));
  }

  private FruitDto convertToDto(Fruit fruit) {
    return new FruitDto(fruit.getName(), fruit.getDescription());
  }

  private Fruit convertFromDto(FruitDto fruitDto) {
    return new Fruit(fruitDto.getName(), fruitDto.getDescription());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how <code>FruitResource</code> is being injected a <code>FruitService</code> instance automatically.</p>
</div>
<div class="paragraph">
<p>It is generally not recommended using the same entity object between the REST API and the data access layer. These layers should indeed be decoupled and use distinct APIs in order to allow each API to evolve independently of the other. This is the reason why our REST API is using a different object: the <code>FruitDto</code> class – the word DTO stands for "Data Transfer Object". This DTO object will be automatically converted to and from JSON in HTTP messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FruitDto {

  private String name;
  private String description;

  public FruitDto() {}

  public FruitDto(String name, String description) {
    this.name = name;
    this.description = description;
  }
  // getters and setters omitted for brevity
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The translation to and from JSON is done automatically by the Quarkus RESTEasy Reactive extension, which is included in this guide&#8217;s pom.xml file. If you want to add it manually to your application, add the below snippet to your application&#8217;s ppm.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-resteasy-reactive&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-resteasy-jackson&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
JSONのシリアライゼーションレイヤーで使用されるDTOクラスは、デフォルトの引数なしのコンストラクタが必要です。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The conversion from DTO to JSON is handled automatically for us, but we still must convert from <code>Fruit</code> to <code>FruitDto</code> and vice versa. This must be done manually, which is why we have two conversion methods declared in <code>FruitResource</code>: <code>convertToDto</code> and <code>convertFromDto</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In our example, <code>Fruit</code> and <code>FruitDto</code> are very similar, so you might wonder why not use <code>Fruit</code> everywhere. In real life cases though, it&#8217;s not uncommon to see DTOs and entities having very different structures.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connecting-to-the-cassandra-database"><a class="anchor" href="#connecting-to-the-cassandra-database"></a>Connecting to the Cassandra Database</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="connecting-to-apache-cassandra-or-datastax-enterprise-dse"><a class="anchor" href="#connecting-to-apache-cassandra-or-datastax-enterprise-dse"></a>Connecting to Apache Cassandra or DataStax Enterprise (DSE)</h3>
<div class="paragraph">
<p>The main properties to configure are: <code>contact-points</code>, to access the Cassandra database; <code>local-datacenter</code>, which is required by the driver; and – optionally – the keyspace to bind to.</p>
</div>
<div class="paragraph">
<p>設定のサンプルは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.contact-points={cassandra_ip}:9042
quarkus.cassandra.local-datacenter={dc_name}
quarkus.cassandra.keyspace={keyspace}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この例では、localhost上で動作する単一のインスタンスを使用しており、データを含むキースペースは <code>k1</code> となっています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.contact-points=127.0.0.1:9042
quarkus.cassandra.local-datacenter=datacenter1
quarkus.cassandra.keyspace=k1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your cluster requires plain text authentication, you must also provide two more settings: <code>username</code> and <code>password</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.auth.username=john
quarkus.cassandra.auth.password=s3cr3t</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="connecting-to-a-datastax-astra-cloud-database"><a class="anchor" href="#connecting-to-a-datastax-astra-cloud-database"></a>Connecting to a DataStax Astra Cloud Database</h3>
<div class="paragraph">
<p>When connecting to <a href="https://astra.datastax.com">DataStax Astra</a>, instead of providing a contact point and a datacenter, you should provide a so-called <em>secure connect bundle</em>, which should point to a valid path to an Astra secure connect bundle file. You can download your secure connect bundle from the Astra web console.</p>
</div>
<div class="paragraph">
<p>You will also need to provide a username and password, since authentication is always required on Astra clusters.</p>
</div>
<div class="paragraph">
<p>DataStax Astraのサンプル構成は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.cloud.secure-connect-bundle=/path/to/secure-connect-bundle.zip
quarkus.cassandra.auth.username=john
quarkus.cassandra.auth.password=s3cr3t
quarkus.cassandra.keyspace=k1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced-driver-configuration"><a class="anchor" href="#advanced-driver-configuration"></a>Advanced Driver Configuration</h3>
<div class="paragraph">
<p>You can configure other Java driver settings using <code>application.conf</code> or <code>application.json</code> files. They need to be located in the classpath of your application. All settings will be passed automatically to the underlying driver configuration mechanism. Settings defined in <code>application.properties</code> with the <code>quarkus.cassandra</code> prefix will have priority over settings defined in <code>application.conf</code> or <code>application.json</code>.</p>
</div>
<div class="paragraph">
<p>設定の全リストを見るには、 <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/reference/">ドライバーの設定リファレンス</a> を参照してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-a-local-cassandra-database"><a class="anchor" href="#running-a-local-cassandra-database"></a>Running a Local Cassandra Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, the Cassandra client is configured to access a local Cassandra database on port 9042 (the default Cassandra port).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
設定 <code>quarkus.cassandra.local-datacenter</code> が、Cassandraクラスターのデータセンターと一致していることを確認してください。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ローカルのデータセンターの名前がわからない場合は、以下の CQL クエリを実行することでこの値を見つけることができます : <code>SELECT data_center FROM system.local</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to use Docker to run a Cassandra database, you can use the following command to launch one in the background:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker run --name local-cassandra-instance -p 9042:9042 -d cassandra</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、アプリケーションで使用するキースペースとテーブルを作成する必要があります。Dockerを使用している場合は、以下のコマンドを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker exec -it local-cassandra-instance cqlsh -e "CREATE KEYSPACE IF NOT EXISTS k1 WITH replication = {'class':'SimpleStrategy', 'replication_factor':1}"
docker exec -it local-cassandra-instance cqlsh -e "CREATE TABLE IF NOT EXISTS k1.fruit(name text PRIMARY KEY, description text)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the CQLSH utility to interactively interrogate your database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker exec -it local-cassandra-instance cqlsh</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-the-rest-api"><a class="anchor" href="#testing-the-rest-api"></a>Testing the REST API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the project root directory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run <code>mvn clean package</code> and then <code>java -jar ./target/cassandra-quarkus-quickstart-*-runner.jar</code> to start the application;</p>
</li>
<li>
<p>Or better yet, run the application in dev mode: <code>mvn clean quarkus:dev</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now you can use curl commands to interact with the underlying REST API.</p>
</div>
<div class="paragraph">
<p>To create a fruit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl --header "Content-Type: application/json" \
  --request POST \
  --data '{"name":"apple","description":"red and tasty"}' \
  http://localhost:8080/fruits</code></pre>
</div>
</div>
<div class="paragraph">
<p>To retrieve fruits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X GET http://localhost:8080/fruits</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-frontend"><a class="anchor" href="#creating-a-frontend"></a>Creating a Frontend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>それでは、 <code>FruitResource</code> と対話するためのシンプルなウェブページを追加してみましょう。</p>
</div>
<div class="paragraph">
<p>Quarkus automatically serves static resources located under the <code>META-INF/resources</code> directory. In the <code>src/main/resources/META-INF/resources</code> directory, add a <code>fruits.html</code> file with the contents from <a href="src/main/resources/META-INF/resources/fruits.html">this file</a> in it.</p>
</div>
<div class="paragraph">
<p>これで、REST サービスと対話できるようになりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you haven&#8217;t done yet, start your application with <code>mvn clean quarkus:dev</code>;</p>
</li>
<li>
<p>Point your browser to <code><a href="http://localhost:8080/fruits.html" class="bare">http://localhost:8080/fruits.html</a></code>;</p>
</li>
<li>
<p>Add new fruits to the list via the form.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactive"><a class="anchor" href="#reactive"></a>Reactive Programming with the Cassandra Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://javadoc.io/doc/com.datastax.oss.quarkus/cassandra-quarkus-client/latest/com/datastax/oss/quarkus/runtime/api/session/QuarkusCqlSession.html"><code>QuarkusCqlSession</code> interface</a> gives you access to a series of reactive methods that integrate seamlessly with Quarkus and its reactive framework, Mutiny.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are not familiar with Mutiny, please check <a href="mutiny-primer">Mutiny - an intuitive reactive programming library</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s rewrite our application using reactive programming with Mutiny.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s to declare another DAO interface that works in a reactive way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Dao
public interface ReactiveFruitDao {

  @Update
  Uni&lt;Void&gt; updateAsync(Fruit fruit);

  @Select
  MutinyMappedReactiveResultSet&lt;Fruit&gt; findAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the usage of <code>MutinyMappedReactiveResultSet</code> - it is a specialized <code>Mutiny</code> type converted from the original <code>Publisher</code> returned by the driver, which also exposes a few extra methods, e.g. to obtain the query execution info. If you don&#8217;t need anything in that interface, you can also simply declare your method to return <code>Multi</code>: <code>Multi&lt;Fruit&gt; findAll()</code>,</p>
</div>
<div class="paragraph">
<p>同様に、メソッド <code>updateAsync</code> は <code>Uni</code> を返します。これは、ドライバーが返す元の結果セットから自動的に変換されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cassandraドライバは、リアクティブコールにReactive Streamsの <code>Publisher</code> APIを使用しています。しかし、QuarkusフレームワークではMutinyを使用しています。そのため、 <code>CqlQuarkusSession</code> インターフェイスは、ドライバが返す <code>Publisher</code> インスタンスを透過的にリアクティブ型の <code>Multi</code> に変換します。 <code>CqlQuarkusSession</code> は <code>Publisher</code> を <code>Uni</code> に変換することもできます - この場合、パブリッシャーは最大で1行を出力し、その後完了することが期待されます。これは書き込みクエリ(行を返さない)や、最大で1行を返すことが 保証されている読み込みクエリ(例えばカウントクエリ)に適しています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, we need to adapt the <code>FruitMapper</code> to construct a <code>ReactiveFruitDao</code> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mapper
public interface FruitMapper {
  // the existing method omitted

  @DaoFactory
  ReactiveFruitDao reactiveFruitDao();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can create a <code>ReactiveFruitService</code> that leverages our reactive DAO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class ReactiveFruitService {

  @Inject ReactiveFruitDao fruitDao;

  public Uni&lt;Void&gt; add(Fruit fruit) {
    return fruitDao.update(fruit);
  }

  public Multi&lt;Fruit&gt; getAll() {
    return fruitDao.findAll();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we can create a <code>ReactiveFruitResource</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/reactive-fruits")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class ReactiveFruitResource {

  @Inject ReactiveFruitService service;

  @GET
  public Multi&lt;FruitDto&gt; getAll() {
    return service.getAll().map(this::convertToDto);
  }

  @POST
  public Uni&lt;Void&gt; add(FruitDto fruitDto) {
    return service.add(convertFromDto(fruitDto));
  }

  private FruitDto convertToDto(Fruit fruit) {
    return new FruitDto(fruit.getName(), fruit.getDescription());
  }

  private Fruit convertFromDto(FruitDto fruitDto) {
    return new Fruit(fruitDto.getName(), fruitDto.getDescription());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above resource is exposing a new endpoint, <code>reactive-fruits</code>. Its capabilities are identical to the ones that we created before with <code>FruitResource</code>, but everything is handled in a reactive fashion, without any blocking operation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>getAll()</code> method above returns <code>Multi</code>, and the <code>add()</code> method returns <code>Uni</code>. These types are the same Mutiny types that we met before; they are automatically recognized by the Quarkus reactive REST API, so we don&#8217;t need to convert them into JSON ourselves.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>RESTEasy Reactive natively supports the Mutiny reactive types e.g. <code>Uni</code> and <code>Multi</code>.</p>
</div>
<div class="paragraph">
<p>This dependency is already included in this guide&#8217;s pom.xml, but if you are starting a new project from scratch, make sure to include it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-the-reactive-rest-api"><a class="anchor" href="#testing-the-reactive-rest-api"></a>Testing the Reactive REST API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the application in dev mode as explained above, then you can use curl commands to interact with the underlying REST API.</p>
</div>
<div class="paragraph">
<p>To create a fruit using the reactive REST endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl --header "Content-Type: application/json" \
  --request POST \
  --data '{"name":"banana","description":"yellow and sweet"}' \
  http://localhost:8080/reactive-fruits</code></pre>
</div>
</div>
<div class="paragraph">
<p>To retrieve fruits with the reactive REST endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X GET http://localhost:8080/reactive-fruits</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-reactive-frontend"><a class="anchor" href="#creating-a-reactive-frontend"></a>Creating a Reactive Frontend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s add a simple web page to interact with our <code>ReactiveFruitResource</code>. In the <code>src/main/resources/META-INF/resources</code> directory, add a <code>reactive-fruits.html</code> file with the contents from <a href="src/main/resources/META-INF/resources/reactive-fruits.html">this file</a> in it.</p>
</div>
<div class="paragraph">
<p>これで、リアクティブな REST サービスと対話できるようになりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you haven&#8217;t done yet, start your application with <code>mvn clean quarkus:dev</code>;</p>
</li>
<li>
<p>Point your browser to <code><a href="http://localhost:8080/reactive-fruits.html" class="bare">http://localhost:8080/reactive-fruits.html</a></code>;</p>
</li>
<li>
<p>Add new fruits to the list via the form.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ヘルスチェック"><a class="anchor" href="#ヘルスチェック"></a>ヘルスチェック</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are using the Quarkus SmallRye Health extension, then the Cassandra client will automatically add a readiness health check to validate the connection to the Cassandra cluster. This extension is already included in this guide&#8217;s pom.xml, but if you need to include it manually in your application, add the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-smallrye-health&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When health checks are available, you can access the <code>/health/ready</code> endpoint of your application and have information about the connection validation status.</p>
</div>
<div class="paragraph">
<p>Running in dev mode with <code>mvn clean quarkus:dev</code>, if you point your browser to <a href="http://localhost:8080/health/ready" class="bare">http://localhost:8080/health/ready</a> you should see an output similar to the following one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">{
    "status": "UP",
    "checks": [
        {
            "name": "DataStax Apache Cassandra Driver health check",
            "status": "UP",
            "data": {
                "cqlVersion": "3.4.4",
                "releaseVersion": "3.11.7",
                "clusterName": "Test Cluster",
                "datacenter": "datacenter1",
                "numberOfNodes": 1
            }
        }
    ]
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you need health checks globally enabled in your application, but don&#8217;t want to activate Cassandra health checks, you can disable Cassandra health checks by setting the <code>quarkus.cassandra.health.enabled</code> property to <code>false</code> in your <code>application.properties</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="メトリクス"><a class="anchor" href="#メトリクス"></a>メトリクス</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Cassandra Quarkus client can provide metrics about the Cassandra session and about individual Cassandra nodes. It supports both Micrometer and MicroProfile.</p>
</div>
<div class="paragraph">
<p>The first step to enable metrics is to add a few additional dependencies depending on the metrics framework you plan to use.</p>
</div>
<div class="sect2">
<h3 id="enabling-metrics-with-micrometer"><a class="anchor" href="#enabling-metrics-with-micrometer"></a>Enabling Metrics with Micrometer</h3>
<div class="paragraph">
<p>Micrometer is the recommended metrics framework in Quarkus applications.</p>
</div>
<div class="paragraph">
<p>To enable Micrometer metrics in your application, you need to add the following to your pom.xml.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.datastax.oss&lt;/groupId&gt;
  &lt;artifactId&gt;java-driver-metrics-micrometer&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This guide uses Micrometer, so the above dependencies are already included in this guide&#8217;s pom.xml.</p>
</div>
</div>
<div class="sect2">
<h3 id="enabling-metrics-with-microprofile-metrics"><a class="anchor" href="#enabling-metrics-with-microprofile-metrics"></a>Enabling Metrics with MicroProfile Metrics</h3>
<div class="paragraph">
<p>Remove any dependency to Micrometer from your pom.xml, then add the following ones instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.datastax.oss&lt;/groupId&gt;
  &lt;artifactId&gt;java-driver-metrics-microprofile&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-smallrye-metrics&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enabling-cassandra-metrics"><a class="anchor" href="#enabling-cassandra-metrics"></a>Enabling Cassandra Metrics</h3>
<div class="paragraph">
<p>Even when metrics are enabled in your application, the Cassandra client will not report any metrics, unless you opt-in for this feature. So your next step is to enable Cassandra metrics in your <code>application.properties</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.metrics.enabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it!</p>
</div>
<div class="paragraph">
<p>The final (and optional) step is to customize which specific Cassandra metrics you would like the Cassandra client to track. Several metrics can be tracked; if you skip this step, a default set of useful metrics will be automatically tracked.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For the full list of available metric names, please refer to the <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/reference/">driver settings reference</a> page; search for the <code>advanced.metrics</code> section. Also, Cassandra driver metrics are covered in detail in the <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/core/metrics/">driver manual</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you do wish to customize which metrics to track, you should use the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>quarkus.cassandra.metrics.session.enabled</code> should contain the session-level metrics to enable (metrics that are global to the session).</p>
</li>
<li>
<p><code>quarkus.cassandra.metrics.node.enabled</code> should contain the node-level metrics to enable (metrics for which each node contacted by the Cassandra client gets its own metric value).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both properties accept a comma-separated list of valid metric names.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s assume that you wish to enable the following three Cassandra metrics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Session-level: <code>session.connected-nodes</code> and <code>session.bytes-sent</code>;</p>
</li>
<li>
<p>Node-level: <code>node.pool.open-connections</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then you should add the following settings to your <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.metrics.enabled=true
quarkus.cassandra.metrics.session.enabled=connected-nodes,bytes-sent
quarkus.cassandra.metrics.node.enabled=pool.open-connections</code></pre>
</div>
</div>
<div class="paragraph">
<p>This guide&#8217;s <code>application.properties</code> file has already many metrics enabled; you can use its metrics list as a good starting point for exposing useful Cassandra metrics in your application.</p>
</div>
<div class="paragraph">
<p>When metrics are properly enabled, metric reports for all enabled metrics are available at the <code>/metrics</code> REST endpoint of your application.</p>
</div>
<div class="paragraph">
<p>Running in dev mode with <code>mvn clean quarkus:dev</code>, if you point your browser to <code><a href="http://localhost:8080/metrics" class="bare">http://localhost:8080/metrics</a></code> you should see a list of metrics; search for metrics whose names contain <code>cassandra</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For Cassandra metrics to show up, the Cassandra client needs to be initialized and connected; if you are using lazy initialization (see below), you won&#8217;t see any Cassandra metrics until your application actually connects and hits the database for the first time.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ネイティブモードでの実行"><a class="anchor" href="#ネイティブモードでの実行"></a>ネイティブモードでの実行</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you installed GraalVM, you can <a href="https://quarkus.io/guides/building-native-image">build a native image</a> using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn clean package -Dnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>Beware that native compilation can take a significant amount of time! Once the compilation is done, you can run the native executable as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">./target/cassandra-quarkus-quickstart-*-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>その後、ブラウザで <code><a href="http://localhost:8080/fruits.html" class="bare">http://localhost:8080/fruits.html</a></code> を開いてアプリケーションを使用します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="eager-vs-lazy-initialization"><a class="anchor" href="#eager-vs-lazy-initialization"></a>Eager vs Lazy Initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このエクステンションでは、どちらかを注入することができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>QuarkusCqlSession</code> bean;</p>
</li>
<li>
<p>or the asynchronous version of this bean, that is, <code>CompletionStage&lt;QuarkusCqlSession&gt;</code>;</p>
</li>
<li>
<p>or the reactive version of this bean, that is, <code>Uni&lt;QuarkusCqlSession&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The most straightforward approach is obviously to inject <code>QuarkusCqlSession</code> directly. This should work just fine for most applications; however, the <code>QuarkusCqlSession</code> bean needs to be initialized before it can be used, and this process is blocking.</p>
</div>
<div class="paragraph">
<p>Fortunately, it is possible to control when the initialization should happen: the <code>quarkus.cassandra.init.eager-init</code> parameter determines if the <code>QuarkusCqlSession</code> bean should be initialized on its first access (lazy) or when the application is starting (eager). The default value of this parameter is <code>false</code>, meaning the init process is lazy: the <code>QuarkusCqlSession</code> bean will be initialized lazily on its first access – for example, when there is a first REST request that needs to interact with the Cassandra database.</p>
</div>
<div class="paragraph">
<p>Using lazy initialization speeds up your application startup time, and avoids startup failures if the Cassandra database is not available. However, it could also prove dangerous if your code is fully asynchronous, e.g. if you are using <a href="https://quarkus.io/guides/reactive-routes">reactive routes</a>: indeed, the lazy initialization could accidentally happen on a thread that is not allowed to block, such as a Vert.x event loop thread. Therefore, setting <code>quarkus.cassandra.init.eager-init</code> to <code>false</code> and injecting <code>QuarkusCqlSession</code> should be avoided in these contexts.</p>
</div>
<div class="paragraph">
<p>If you want to use Vert.x (or any other reactive framework) and keep the lazy initialization behavior, you should instead inject only <code>CompletionStage&lt;QuarkusCqlSession&gt;</code> or <code>Uni&lt;QuarkusCqlSession&gt;</code>. When injecting these beans, the initialization process will be triggered lazily, but it will happen in the background, in a non-blocking way, leveraging the Vert.x event loop. This way you don&#8217;t risk blocking the Vert.x thread.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can set <code>quarkus.cassandra.init.eager-init</code> to true: in this case the session bean will be initialized eagerly during application startup, on the Quarkus main thread. This would eliminate any risk of blocking a Vert.x thread, at the cost of making your startup time (much) longer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="まとめ"><a class="anchor" href="#まとめ"></a>まとめ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>クライアント・アプリケーションからのCassandraデータベースへのアクセスは、QuarkusとCassandraエクステンションで簡単に行えます。</p>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">Japanese</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
