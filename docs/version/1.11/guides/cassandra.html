<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Using the Cassandra Client - 1.11</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/1.11/guides/cassandra" />
  <meta property="og:title" content="Quarkus - Using the Cassandra Client - 1.11" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/cassandra">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">Quarkusとは <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/continuum" class="">リアクティブ</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学ぶ<i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ガイド</a></li>
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">コミュニティ <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="/publications" class="">出版物</a></li>
          <li><a href="/awards" class="">受賞</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >ENGLISH</a></li>
          <li><a href="https://ja.quarkus.io/">JAPANESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/1.11/guides/"> Back to Guides</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">Select Guide Version</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.9 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" >2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
          
        <option value="1.11" selected>1.11</option>
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">Quarkus - Using the Cassandra Client </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#前提条件">前提条件</a></li>
<li><a href="#アーキテクチャ">アーキテクチャ</a></li>
<li><a href="#ソリューション">ソリューション</a></li>
<li><a href="#creating-the-maven-project">Creating the Maven project</a></li>
<li><a href="#creating-json-rest-service">Creating JSON REST service</a></li>
<li><a href="#configuring-the-cassandra-database">Configuring the Cassandra database</a>
<ul class="sectlevel2">
<li><a href="#connecting-to-apache-cassandra-or-datastax-enterprise-dse">Connecting to Apache Cassandra or DataStax Enterprise (DSE)</a></li>
<li><a href="#クラウドdatastax-astraデータベースへの接続">クラウドDataStax Astraデータベースへの接続</a></li>
<li><a href="#高度なドライバー設定">高度なドライバー設定</a></li>
</ul>
</li>
<li><a href="#running-a-cassandra-database">Running a Cassandra Database</a></li>
<li><a href="#フロントエンドの作成">フロントエンドの作成</a></li>
<li><a href="#reactive">リアクティブCassandraクライアント</a></li>
<li><a href="#リアクティブなフロントエンドの作成">リアクティブなフロントエンドの作成</a></li>
<li><a href="#接続のヘルスチェック">接続のヘルスチェック</a></li>
<li><a href="#メトリクス">メトリクス</a></li>
<li><a href="#ネイティブ実行可能ファイルの構築">ネイティブ実行可能ファイルの構築</a></li>
<li><a href="#まとめ">まとめ</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Apache Cassandra®は、フリーでオープンソースの分散型ワイドカラムストアのNoSQLデータベース管理システムで、多くのコモディティサーバーにまたがる大量のデータを処理するように設計されており、単一障害点のない高可用性を提供します。</p>
</div>
<div class="paragraph">
<p>このガイドでは、RESTサービスでCassandraデータベースを使用する方法を見ていきます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>このエクステンションはサードパーティによって開発されたもので、Quarkus Platformの一部です。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="前提条件"><a class="anchor" href="#前提条件"></a>前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドを完成させるには、以下が必要です:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IDE</p>
</li>
<li>
<p>JDK 1.8+ がインストールされ、 <code>JAVA_HOME</code> が適切に設定されていること</p>
</li>
<li>
<p>ネイティブモードを使用したい場合は、 <code>GRAALVM_HOME</code> を適切に設定して GraalVM をインストールしてください。</p>
</li>
<li>
<p>Apache Maven 3.6.2+</p>
</li>
<li>
<p>Cassandra or Docker installed</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="アーキテクチャ"><a class="anchor" href="#アーキテクチャ"></a>アーキテクチャ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドで構築されたアプリケーションは非常にシンプルです: ユーザーはフォームを使用してリストに要素を追加することができ、アイテムリストが更新されます。</p>
</div>
<div class="paragraph">
<p>ブラウザとサーバー間の情報はすべてJSON形式になっています。</p>
</div>
<div class="paragraph">
<p>要素は Cassandra データベースに格納されています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ソリューション"><a class="anchor" href="#ソリューション"></a>ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の章で紹介する手順に沿って、ステップを踏んでアプリを作成することをお勧めします。ただし、完成した例にそのまま進んでも構いません。</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>quickstart</code> <a href="https://github.com/datastax/cassandra-quarkus/tree/main/quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-the-maven-project"><a class="anchor" href="#creating-the-maven-project"></a>Creating the Maven project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず、新しいMavenプロジェクトを作成し、 <code>quickstart</code> ディレクトリーに存在する <code>pom.xml</code> ファイルをコピーします。</p>
</div>
<div class="paragraph">
<p><code>pom.xml</code> は、RESTEasy/JAX-RS、JSON-B、Context Propagation、Cassandraクライアントエクステンションをインポートしています。</p>
</div>
<div class="paragraph">
<p>Data Access Layerのコードを簡略化するために、 <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/mapper">DataStax Object Mapper</a> を使ってRESTアプリケーションを構築します。</p>
</div>
<div class="paragraph">
<p><code>pom.xml</code> で最も重要なのは、 <code>cassandra-quarkus</code> のエクステンションを追加することです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.datastax.oss.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;cassandra-quarkus-client&lt;/artifactId&gt;
    &lt;version&gt;${quarkus.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、コンパイラの設定にアノテーション・プロセッサーを追加する方法についても、必ず <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/mapper/config/">指示</a> に従ってください。プロジェクトがコンパイルされると、追加のマッパークラスが生成されます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-json-rest-service"><a class="anchor" href="#creating-json-rest-service"></a>Creating JSON REST service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この例では、果物のリストを管理するアプリケーションを作成します。</p>
</div>
<div class="paragraph">
<p>まず、以下のように <code>Fruit</code> Bean を作成してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Fruit {

    @PartitionKey private String storeId;
    @ClusteringColumn private String name;
    private String description;

    public Fruit() {}

    public Fruit(String storeId, String name, String description) {
      this.storeId = storeId;
      this.name = name;
      this.description = description;
    }

    // getters, setters, hashCode and equals omitted for brevity
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DataStax JavaドライバーのObject Mapperを使用しているので、このクラスには <code>@Entity</code> がアノテーションされています。また、 <code>storeId</code> フィールドは Cassandra パーティション・キーを表し、 <code>name</code> はクラスタリング・カラムを表しているので、Object Mapper ライブラリから対応するアノテーションを使用しています。これにより、Mapperはその下に適切なCQLクエリを生成することができるようになります。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
エンティティクラスには、デフォルトの引数なしのコンストラクタが必要です。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>このアプリでMapperロジックを活用するには、DAOを作成する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Dao
public interface FruitDao {
  @Update
  void update(Fruit fruit);

  @Select
  PagingIterable&lt;Fruit&gt; findById(String id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このクラスは、RESTサービスで使用される操作を公開します。</p>
</div>
<div class="paragraph">
<p>最後に、マッパー本体です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mapper
public interface FruitMapper {
  @DaoFactory
  FruitDao fruitDao();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>マッパーは， <code>FruitDao</code> のインスタンスを構築する役割を果たします．上の例では、 <code>FruitDao</code> のインスタンスは、基礎となるセッションと同じキースペースに接続されます。詳細は後述します。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
異なるキースペース用の DAO インスタンスを作成することも可能です。方法については、ドライバードキュメントの <a href="https://docs.datastax.com/en/developer/java-driver/4.7/manual/mapper/mapper/#dao-parameterization">DAO パラメーター化</a> を参照してください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に，DAOインスタンスを生成するためのコンポーネント <code>FruitDaoProducer</code> が必要です。実際、マッパーとDAOのインスタンスはステートフルなオブジェクトであり、アプリケーションスコープのシングルトンとして、一度だけ作成されるべきです。 このコンポーネントは、QuarkusのDependency Injectionコンテナを利用して、まさにそれを行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import com.datastax.oss.driver.api.core.CqlIdentifier;
import com.datastax.oss.quarkus.runtime.api.config.CassandraClientConfig;
import com.datastax.oss.quarkus.runtime.api.session.QuarkusCqlSession;
import javax.enterprise.context.ApplicationScoped;
import javax.enterprise.inject.Produces;
import javax.inject.Inject;

public class FruitDaoProducer {

  private final FruitDao fruitDao;
  private final FruitDaoReactive fruitDaoReactive;

  @Inject
  public FruitDaoProducer(QuarkusCqlSession session) {
    // create a mapper
    FruitMapper mapper = new FruitMapperBuilder(session).build();
    // instantiate our Daos
    fruitDao = mapper.fruitDao();
    fruitDaoReactive = mapper.fruitDaoReactive();
  }

  @Produces
  @ApplicationScoped
  FruitDao produceFruitDao() {
    return fruitDao;
  }

  @Produces
  @ApplicationScoped
  FruitDaoReactive produceFruitDaoReactive() {
    return fruitDaoReactive;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>QuarkusCqlSession</code> のインスタンスが <code>FruitDaoProducer</code> コンストラクタの cassandra-quarkus エクステンションによって自動的に注入されていることに注意してください。</p>
</div>
<div class="paragraph">
<p>また、 <code>FruitMapperBuilder</code> は <code>java-driver-mapper-processor</code> アノテーション・プロセッサーによって自動的に生成されるクラスの一つであることにも注意してください。</p>
</div>
<div class="paragraph">
<p>ここで、アプリケーションのビジネス層となる <code>FruitService</code> を作成し、Cassandraデータベースから果物をセーブ/ロードします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class FruitService {

  private final FruitDao dao;

  @Inject
  public FruitService(FruitDao dao) {
    this.dao = dao;
  }

  public void save(Fruit fruit) {
    dao.update(fruit);
  }

  public List&lt;Fruit&gt; get(String id) {
    return dao.findById(id).all();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>コンストラクタで，サービスが <code>FruitDao</code> インスタンスを受け取っていることに注目してください．この DAO インスタンスは <code>FruitDaoProducer</code> によって提供され、自動的に注入されます。</p>
</div>
<div class="paragraph">
<p>最後に必要なのは、GETとPOSTのメソッドを公開するREST APIです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/fruits")
public class FruitResource {

  private static final String STORE_NAME = "acme";

  @Inject FruitService fruitService;

  @GET
  public List&lt;FruitDto&gt; list() {
    return fruitService.get(STORE_NAME).stream()
        .map(fruit -&gt; new FruitDto(fruit.getName(), fruit.getDescription()))
        .collect(Collectors.toList());
  }

  @POST
  public void add(FruitDto fruit) {
    fruitService.save(covertFromDto(fruit));
  }

  private Fruit covertFromDto(FruitDto fruitDto) {
    return new Fruit(fruitDto.getName(), fruitDto.getDescription(), STORE_NAME);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>list</code> と <code>add</code> の操作は <code>storeId</code> の "acme " に対して実行されます。これは私たちのデータモデルのパーティション・キーです。このパーティション・キーを使って、Cassandraからすべての行を簡単に取り出すことができます。 それらはクラスタリングカラムでソートされます。 <code>FruitResource</code> はデータアクセスロジックをカプセル化した <code>FruitService</code> を使用しています。</p>
</div>
<div class="paragraph">
<p>REST APIを作成する際には、REST APIとデータアクセス層の間で同じエンティティーオブジェクトを共有すべきではありません。それらは、APIがストレージ層から独立して進化できるように結合されるべきではありません。これが、APIが <code>FruitDto</code> クラスを使用している理由です。このクラスは、Quarkusによって、クライアントのリクエストに対してはJSONをjavaオブジェクトに、レスポンスに対してはjavaオブジェクトをJSONに変換するために使用されます。変換はquarkus-resteasyエクステンションによって行われます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class FruitDto {

  private String name;
  private String description;

  public FruitDto() {}

  public FruitDto(String name, String description) {
    this.name = name;
    this.description = description;
  }
  // getters and setters omitted for brevity
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
JSONのシリアライゼーションレイヤーで使用されるDTOクラスは、デフォルトの引数なしのコンストラクタが必要です。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-the-cassandra-database"><a class="anchor" href="#configuring-the-cassandra-database"></a>Configuring the Cassandra database</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="connecting-to-apache-cassandra-or-datastax-enterprise-dse"><a class="anchor" href="#connecting-to-apache-cassandra-or-datastax-enterprise-dse"></a>Connecting to Apache Cassandra or DataStax Enterprise (DSE)</h3>
<div class="paragraph">
<p>構成する主なプロパティーは次のとおりです。 Cassandraデータベースにアクセスするための <code>contact-points</code> 、ドライバーによって必要とされる <code>local-datacenter</code> そしてオプションでバインド先のキースペースです。</p>
</div>
<div class="paragraph">
<p>設定のサンプルは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.contact-points={cassandra_ip}:9042
quarkus.cassandra.local-datacenter={dc_name}
quarkus.cassandra.keyspace={keyspace}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この例では、localhost上で動作する単一のインスタンスを使用しており、データを含むキースペースは <code>k1</code> となっています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.contact-points=127.0.0.1:9042
quarkus.cassandra.local-datacenter=datacenter1
quarkus.cassandra.keyspace=k1</code></pre>
</div>
</div>
<div class="paragraph">
<p>クラスタがプレーンテキスト認証を必要とする場合は、さらに2つの設定を行うことができます。 <code>username</code> と <code>password</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.auth.username=john
quarkus.cassandra.auth.password=s3cr3t</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="クラウドdatastax-astraデータベースへの接続"><a class="anchor" href="#クラウドdatastax-astraデータベースへの接続"></a>クラウドDataStax Astraデータベースへの接続</h3>
<div class="paragraph">
<p>Astra に接続する際には、コンタクトポイントとデータセンターを提供する代わりに、<code>secure-connect-bundle</code> を提供する必要があります。これは、Astra のセキュアな接続バンドルへの有効なパスを指すとともに、Astra クラスタでは常に認証が必要となるため、 <code>username</code> と <code>password</code> も提供する必要があります。</p>
</div>
<div class="paragraph">
<p>DataStax Astraのサンプル構成は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.cloud.secure-connect-bundle=/path/to/secure-connect-bundle.zip
quarkus.cassandra.auth.username=john
quarkus.cassandra.auth.password=s3cr3t
quarkus.cassandra.keyspace=k1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="高度なドライバー設定"><a class="anchor" href="#高度なドライバー設定"></a>高度なドライバー設定</h3>
<div class="paragraph">
<p><code>application.conf</code> または <code>application.json</code> ファイルを使用して、他の Java ドライバーの設定を設定することができます。これらのファイルは、アプリケーションのクラスパスに配置する必要があります。すべての設定は、基礎となるドライバー設定メカニズムに自動的に渡されます。 <code>application.properties</code> で <code>quarkus.cassandra</code> のプレフィックスを付けて定義された設定は、 <code>application.conf</code> または <code>application.json</code> で定義された設定よりも優先されます。</p>
</div>
<div class="paragraph">
<p>設定の全リストを見るには、 <a href="https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/reference/">ドライバーの設定リファレンス</a> を参照してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-a-cassandra-database"><a class="anchor" href="#running-a-cassandra-database"></a>Running a Cassandra Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>デフォルトでは、 <code>CassandraClient</code> は、ポート 9042(デフォルトの Cassandra ポート)でローカル Cassandra データベースにアクセスするように構成されています。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
設定 <code>quarkus.cassandra.local-datacenter</code> が、Cassandraクラスターのデータセンターと一致していることを確認してください。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ローカルのデータセンターの名前がわからない場合は、以下の CQL クエリを実行することでこの値を見つけることができます : <code>SELECT data_center FROM system.local</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dockerを使用してCassandraデータベースを起動したい場合は、以下のコマンドを使用して起動することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run \
   --name local-cassandra-instance \
   -p 7000:7000 \
   -p 7001:7001 \
   -p 7199:7199 \
   -p 9042:9042 \
   -p 9160:9160 \
   -p 9404:9404 \
   -d \
   launcher.gcr.io/google/cassandra3</code></pre>
</div>
</div>
<div class="paragraph">
<p>9042ポートのみが必要であることに注意してください。他のすべてはオプションですが、CassandraインスタンスのJMX監視などのエクステンションを提供します。</p>
</div>
<div class="paragraph">
<p>次に、アプリケーションで使用するキースペースとテーブルを作成する必要があります。Dockerを使用している場合は、以下のコマンドを実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker exec -it local-cassandra-instance cqlsh -e "CREATE KEYSPACE IF NOT EXISTS k1 WITH replication = {'class':'SimpleStrategy', 'replication_factor':1}"
docker exec -it local-cassandra-instance cqlsh -e "CREATE TABLE IF NOT EXISTS k1.fruit(store_id text, name text, description text, PRIMARY KEY((store_id), name))"</code></pre>
</div>
</div>
<div class="paragraph">
<p>ローカルでCassandraを実行している場合は、cqlshコマンドを直接実行できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cqlsh -e "CREATE KEYSPACE IF NOT EXISTS k1 WITH replication = {'class':'SimpleStrategy', 'replication_factor':1}
cqlsh -e "CREATE TABLE IF NOT EXISTS k1.fruit(store_id text, name text, description text, PRIMARY KEY((store_id), name))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="フロントエンドの作成"><a class="anchor" href="#フロントエンドの作成"></a>フロントエンドの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>それでは、 <code>FruitResource</code> と対話するためのシンプルなウェブページを追加してみましょう。</p>
</div>
<div class="paragraph">
<p>Quarkus automatically serves static resources located under the <code>META-INF/resources</code> directory. In the <code>src/main/resources/META-INF/resources</code> directory, add a <code>fruits.html</code> file with the content from this <a href="https://github.com/datastax/cassandra-quarkus/tree/main/quickstart/src/main/resources/META-INF/resources/fruits.html">fruits.html</a> file in it.</p>
</div>
<div class="paragraph">
<p>これで、REST サービスと対話できるようになりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkusを起動する <code>mvn clean quarkus:dev</code></p>
</li>
<li>
<p>ブラウザで <code><a href="http://localhost:8080/fruits.html" class="bare">http://localhost:8080/fruits.html</a></code> を開きます。</p>
</li>
<li>
<p>フォームを使って新しいフルーツをリストに追加します。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactive"><a class="anchor" href="#reactive"></a>リアクティブCassandraクライアント</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>QuarkusCqlSession</code> を使うと、QuarkusとMutinyを統合したメソッドのリアクティブなバリアントにアクセスできます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Mutinyに慣れていない場合は、まず <a href="https://quarkus.io/guides/getting-started-reactive">Getting Started with Reactiveガイド</a> を読んでください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>先ほどの例をMutinyを使ったリアクティブプログラミングで書き換えてみましょう。</p>
</div>
<div class="paragraph">
<p>まず、リアクティブに動作する <code>@Dao</code> を実装する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Dao
public interface FruitDaoReactive {

  @Update
  Uni&lt;Void&gt; updateAsync(Fruit fruitDao);

  @Select
  MutinyMappedReactiveResultSet&lt;Fruit&gt; findByIdAsync(String id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MutinyMappedReactiveResultSet</code> の使い方に注意してください。これは、ドライバが返すオリジナルの <code>Publisher</code> から変換された特殊な <code>Mutiny</code> 型で、クエリの実行情報を取得するなど、いくつかの追加メソッドも公開されています。このインターフェイスで何も必要としない場合は、単純に <code>Multi</code> を返すようにメソッドを宣言することもできます。<code>Multi&lt;Fruit&gt; findByIdAsync(String id)</code></p>
</div>
<div class="paragraph">
<p>同様に、メソッド <code>updateAsync</code> は <code>Uni</code> を返します。これは、ドライバーが返す元の結果セットから自動的に変換されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cassandraドライバは、リアクティブコールにReactive Streamsの <code>Publisher</code> APIを使用しています。しかし、QuarkusフレームワークではMutinyを使用しています。そのため、 <code>CqlQuarkusSession</code> インターフェイスは、ドライバが返す <code>Publisher</code> インスタンスを透過的にリアクティブ型の <code>Multi</code> に変換します。 <code>CqlQuarkusSession</code> は <code>Publisher</code> を <code>Uni</code> に変換することもできます - この場合、パブリッシャーは最大で1行を出力し、その後完了することが期待されます。これは書き込みクエリ(行を返さない)や、最大で1行を返すことが 保証されている読み込みクエリ(例えばカウントクエリ)に適しています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に、 <code>FruitDaoReactive</code> のインスタンスを構築するために、 <code>FruitMapper</code> を適応させる必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Mapper
public interface FruitMapper {
  // the existing method omitted

  @DaoFactory
  FruitDaoReactive fruitDaoReactive();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、リアクティブな <code>@Dao</code> を利用した <code>FruitReactiveService</code> を作成することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class FruitReactiveService {

  private final FruitDaoReactive fruitDao;

  @Inject
  public FruitReactiveService(FruitDaoReactive fruitDao) {
    this.fruitDao = fruitDao;
  }

  public Uni&lt;Void&gt; add(Fruit fruit) {
    return fruitDao.update(fruit);
  }

  public Multi&lt;Fruit&gt; get(String id) {
    return fruitDao.findById(id);
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
上記の <code>get()</code> メソッドは <code>Multi</code> を返し、 <code>add()</code> メソッドは <code>Uni</code> を返します。これらのタイプは、Quarkus のリアクティブ REST API と互換性があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>リアクティブロジックをRESTAPIと統合するには、 <code>quarkus-resteasy-mutiny</code> への依存関係が必要です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-resteasy-mutiny&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは <code>Multi</code> 、<code>Uni</code> 、REST APIの間の統合レイヤーを提供します。</p>
</div>
<div class="paragraph">
<p>最後に、 <code>FruitReactiveResource</code> を作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/reactive-fruits")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class FruitReactiveResource {
  private static final String STORE_NAME = "acme";
  @Inject FruitReactiveService service;

  @GET
  public Multi&lt;FruitDto&gt; getAll() {
    return service
        .get(STORE_NAME)
        .map(fruit -&gt; new FruitDto(fruit.getName(), fruit.getDescription()));
  }

  @POST
  public Multi&lt;FruitDto&gt; add(FruitDto fruitDto) {
    Fruit fruit = covertFromDto(fruitDto);
    return service.add(fruit).then(ignored -&gt; getAll());
  }

  private Fruit covertFromDto(FruitDto fruitDto) {
    return new Fruit(fruitDto.getName(), fruitDto.getDescription(), STORE_NAME);
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
RESTインターフェースを介して公開されているすべてのメソッドは、Mutiny APIからリアクティブ型を返しています。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="リアクティブなフロントエンドの作成"><a class="anchor" href="#リアクティブなフロントエンドの作成"></a>リアクティブなフロントエンドの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s add a simple web page to interact with our <code>FruitReactiveResource</code>. In the <code>src/main/resources/META-INF/resources</code> directory, add a <code>reactive-fruits.html</code> file with the content from this <a href="https://github.com/datastax/cassandra-quarkus/tree/main/quickstart/src/main/resources/META-INF/resources/reactive-fruits.html">reactive-fruits.html</a> file in it.</p>
</div>
<div class="paragraph">
<p>これで、リアクティブな REST サービスと対話できるようになりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkusを起動する <code>mvn clean quarkus:dev</code></p>
</li>
<li>
<p>ブラザで <code><a href="http://localhost:8080/reactive-fruits.html" class="bare">http://localhost:8080/reactive-fruits.html</a></code> を開きます。</p>
</li>
<li>
<p>フォームを使って新しいフルーツをリストに追加します。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="接続のヘルスチェック"><a class="anchor" href="#接続のヘルスチェック"></a>接続のヘルスチェック</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>quarkus-smallrye-health</code> エクステンションを使用している場合、 <code>quarkus-quarkus</code> は、クラスタへの接続を検証するための Readiness ヘルスチェックを自動的に追加します。</p>
</div>
<div class="paragraph">
<p>そのため、アプリケーションの <code>/q/health/ready</code> エンドポイントにアクセスすると、接続の検証状況に関する情報が表示されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
この動作は、 <code>application.properties</code> で <code>quarkus.cassandra.health.enabled</code> プロパティを <code>false</code> に設定することで無効にできます。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="メトリクス"><a class="anchor" href="#メトリクス"></a>メトリクス</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>quarkus-smallrye-metrics</code> エクステンションを使用している場合、 <code>cassandra-quarkus</code> は、QuarkusCqlSession と Cassandra ノードに関するメトリクスを提供できます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
この動作を有効にするには、まず <code>application.properties</code> で <code>quarkus.cassandra.metrics.enabled</code> プロパティを <code>true</code> に設定する必要があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次のステップでは、どのメトリクスを有効にするかを明示的に設定します。</p>
</div>
<div class="paragraph">
<p><code>quarkus.cassandra.metrics.session-enabled</code> および <code>quarkus.cassandra.metrics.node-enabled</code> プロパティは、メトリクスを有効にするために使用する必要があります。前者は有効にするセッション・レベル・メトリクスのリストを含み、後者は有効にするノード・レベル・メトリクスのリストを含む必要があります。どちらのプロパティも、有効なメトリクス名をコンマで区切ったリストを受け付けます。</p>
</div>
<div class="paragraph">
<p>例えば、 <code>session.connected-nodes</code> 、 <code>session.bytes-sent</code> 、 <code>node.pool.open-connections</code> を有効にするには、 <code>application.properties</code> に以下の設定を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.cassandra.metrics.enabled=true
quarkus.cassandra.metrics.session-enabled=connected-nodes,bytes-sent
quarkus.cassandra.metrics.node-enabled=pool.open-connections</code></pre>
</div>
</div>
<div class="paragraph">
<p>利用可能なメトリクスの全リストについては、リンク:https://docs.datastax.com/en/developer/java-driver/latest/manual/core/configuration/reference/[ドライバーの設定リファレンス] と <code>advanced.metrics</code> セクションを参照してください。</p>
</div>
<div class="paragraph">
<p>メトリクスが有効になっていて、アプリケーションの <code>/q/metrics</code> エンドポイントにアクセスすると、有効になっているすべてのメトリクスのメトリクスレポートが表示されます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ネイティブ実行可能ファイルの構築"><a class="anchor" href="#ネイティブ実行可能ファイルの構築"></a>ネイティブ実行可能ファイルの構築</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ネイティブ実行可能ファイルでCassandraクライアントを使用することができます。</p>
</div>
<div class="paragraph">
<p><code>mvn clean package -Dnative</code> コマンドでネイティブ実行可能ファイルをビルドすることができます。</p>
</div>
<div class="paragraph">
<p>実行は <code>./target/quickstart-1.0.0-SNAPSHOT-runner</code> を実行するだけで簡単です。</p>
</div>
<div class="paragraph">
<p>その後、ブラウザで <code><a href="http://localhost:8080/fruits.html" class="bare">http://localhost:8080/fruits.html</a></code> を開いてアプリケーションを使用します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="まとめ"><a class="anchor" href="#まとめ"></a>まとめ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>クライアント・アプリケーションからのCassandraデータベースへのアクセスは、QuarkusとCassandraエクステンションで簡単に行えます。</p>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus はオープンです。このプロジェクトの全ての依存関係は<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>または互換性のあるライセンスの元で利用出来ます。<br /><br />このウェブサイトは <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> で構築されており、<a href='https://pages.github.com/' target='_blank'>Github Pages</a>にホストされており、完全にオープンソースです。改善したい場合、 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>ウェブサイトをフォークし</a>、修正してみせてください。</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
            <li><a href="/">ホーム</a></li>
          
            <li><a href="/about">Quarkusについて</a></li>
          
            <li><a href="/blog">ブログ</a></li>
          
            <li><a href="/insights">ポッドキャスト</a></li>
          
            <li><a href="/events">イベント</a></li>
          
            <li><a href="/newsletter">ニュースレター</a></li>
          
            <li><a href="/publications">出版</a></li>
          
            <li><a href="/awards">受賞</a></li>
          
            <li><a href="/security">セキュリティポリシー</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォロー</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
            <li><a href="/support">サポート</a></li>
          
            <li><a href="/guides">ガイド</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入門</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">ディスカッション</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">開発メーリングリスト</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">Japanese</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">等々...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
